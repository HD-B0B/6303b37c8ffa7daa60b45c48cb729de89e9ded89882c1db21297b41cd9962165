Title: Build and Deploy a SaaS AI Agent Platform | Next.js 15, React, Better Auth, Polar | Full Course 2025

() welcome to Meet AI a video calling app powered entirely by AI agents these aren't just summaries or transcripts every meeting here was an actual real-time call with an AI trained for a specific role whether it's a language tutor interview coach sales assistant or something completely custom the AI is there to actively help during the call to start a new call with an AI agent I click on the new meeting button i'm going to name this one startup coaching call i'll also create a new agent here called Hustle Coach and just for fun in the instructions I'll tell it to be direct hyperdriven and a bit over the top like a founder who just raised a seed round once the agent's created I can select it and I'm ready to start the meeting with everything set I click create meeting and land on the new meeting page right now the meeting is scheduled as upcoming which means I can come back to it later cancel it or start the call whenever I'm ready so I'll go ahead and hit start that takes me into a familiar looking lobby just like Zoom or Google Meet where I can check my camera and microphone before joining once I enter the call our new agent Hustle Coach shows up right after this is a live AI in the meeting with me responding in real time powered by Stream Video SDK and Open AI Realtime API hey hustle coach what makes a good startup idea all right listen up a killer startup idea boils down to three things massive market potential a unique value proposition and scalability you want a problem that's begging for disruption and a solution that screens innovation and don't forget your model needs to scale like wildfire if you can pitch it in one sentence and it sounds epic you're on to something hot now go out there and disrupt disrupt disrupt when the call ends the meeting switches to processing status behind the scenes background jobs kick off automatically powered by ingest and agent kit these workflows handle everything fetching the transcript summarizing with AI and saving the results back to the database when the meeting is done processing it's marked as completed and all the content is ready first there's the summary a clean breakdown of what was discussed organized by topic and timestamp next is the transcript it's fully searchable and when you search for a word it highlights every place it appears the whole call is also recorded and available to replay and finally there's a chat GPT like interface that actually understands the meeting powered by stream chat SDK you can ask for specifics like who asked for advice and it will give you the answer meet AI is a SAS product so it runs on a subscription model down here you can see I've hit the limits of the free trial when I try to create a new meeting I'm redirected to a page with three upgrade options i'll go ahead and upgrade and that takes me through a quick checkout powered by Polar authentication is powered by better out a fully free and open-source out solution built for modern web apps it handles email login social providers session management and even a seamless integration with Polar our payment infrastructure our app is also fully responsive every screen adapts cleanly to mobile models and dropdowns turn into mobile drawers for a smoother experience on smaller devices in this course we won't just write the code we'll also follow a proper Git workflow throughout the tutorial each chapter ends with a new branch and a pull request reviewed automatically using code rabbit AI let's quickly go over the test stack we'll be using Nex.js 15 with React 19 together make our full stack framework supporting server components and serverside rendering trpc for full stack type safety used together with tanstack query drizzle OM with Postgress provided by Neon for the database tailwind version 4 for styling combined with Chats UI for accessible and reusable components better out for authentication polar for payments stream for video and chat SDK ingest for background jobs code rabbit for AI powered code reviews and finally Open AI for real-time agents and AIdriven features and of course we'll deploy everything to production when it's ready and now without further ado let's get started in this chapter we're () going to go ahead and set up our project this will include configuring Nex.js JS confirming our environment installing Shhatzy UI and finally pushing our project to GitHub to introduce some Git workflows let's start with Next.js from their official installation guide we can find some system requirements let's go ahead and confirm that we have the proper Noode.js version purther instructions it needs to be at least 18.18 or higher than that you can go inside of your terminal and run node-v if you have a lower version or you've gotten an error running this command you most likely have to reinstall NodeJS you can head to nodejs.org and simply install the latest long-term support version which is in my case 22.15.1 the exact same I'm using after that you can restart your terminal and run the command again to confirm and while you're there it's a good idea to also confirm these two commands npm and npx these two commands come alongside node so you will automatically have them installed but it's always good to double check once you have confirmed those three commands you are ready to install Next.js in their automatic installation chapter they instruct you to use the create next app with the at latest version the latest version at the time of me building this tutorial is 15.3.2 so instead of using at latest this is what I'm going to do npx create next app at 15.3.2 the reason I'm doing this is so that you the viewer is completely aware of the version that I am using because I don't know if you found this video 6 months from now or a year from now in that case the at latest will be significantly different than the one I am using so my advice to you if you want to follow this tutorial exactly as I am use the exact same versions that I'm using so I'm going to be using create next app at 15.3.2 let's call our project meet AI and now we have to select some options you can use arrow keys to select between yes or no for TypeScript select yes this is crucial slint is also yes tailwind is also yes source directory should also be yes make sure to change it if no is default app router also yes turbo pack also yes and the only option I will leave at no is to customize the import alias i don't want to customize it i will leave it the default let's wait for the dependencies to install once you get the success message you can go ahead and enter the new directory change directory meet AI and inside you can enter ls command which should list all the files and folders inside now that you've done that before we run the project let's quickly set up our IDE in my case that will be Visual Studio Code so I'm going to select open and I will select the meet AAI repository if you get a big prompt asking if you want to trust the authors you can select yes here now let's quickly go inside of package JSON and confirm the versions react 19 next 15.3.2 TypeScript 5 and Tailwind version 4 now let's quickly confirm our config files ts config host CSS config next config and slant config there is no Tailwind config because thanks to Tailwind version 4 we have one less config file which is absolutely amazing and also confirm that you have the public folder confirm that you have the source folder and inside the app folder with favicon globals layout and page once you have confirmed all of that you are ready to start the app using npm rundev and you can head to localhost 3000 to see the result depending on the light or dark mode you might see a white or black background now let's go ahead and learn how to change something go inside of the AMP folder page.tsx and you can remove everything from the return method and you can remove the image import and instead just return a hello world and there we go you should see your change the moment you save your file now let's quickly try out Tailwind so I'm going to go ahead and write some class names text for Excel font bold and text green 500 and you have probably immediately noticed that I have some help writing this tailwind i have autocomplete i have the color helper and when I hover over classes I can see the actual CSS if you're interested in having the same help go ahead and install the Tailwind CSS IntelliSense this package right here it is immensely helpful when writing Tailwind go ahead and save this file and immediately you should see your new Tailwind changes perfect what we have to do next is we have to install ChatsN UI what is Chatnen UI so it is a set of beautifully designed accessible components and a code distribution platform but it is not a component library instead it is how you build your component library let's go ahead and add it to our project to understand a bit better i'm going to click installation next.js and instead of using at latest I'm first going to confirm what is the actual latest version so you can use the same version as I am so I will just do d- version here and there we go 2.5.0 so npx shaden at 2.5.0 in it make sure you're doing this inside of your project go ahead and select neutral for the base color and go ahead and select d-leacy pure depths as the solution in case some packages fail why would any packages fail because we are using React 19 react 19 is the latest React version at the time of recording this video but not all packages have adapted their peer dependencies to support React 19 and while they're still probably working inside of React 19 installing them throws warnings in some cases errors which completely break the installation cycle so you have to override them by using either d-force or d- legacy peraps in our case we will use d- legacy peer deps so select the arrow keys and choose d- legacy pure deps and wait for the installation to complete once the installation is completed you will be able to go back to your project and you will notice some new files here if you're wondering exactly which files are new you can click in on this little source control icon and you will see everything that has changed so some of this was changed by us for example this page which now only displays hello world so obviously we are not interested in this but we are interested in the new utils file which seems to have added a new function called CN which is actually short for class name or class names which we will be using to safely merge combine and dynamically add tailor wind classes it's going to come in very very handy so that's one of the files that our chat init command has added another thing it has modified is our globals.css what it modified it with is adding an actual theme for our project and we will be able to modify this theme and then our project will look unique later on and it also installed a couple of packages like class variance authority clsx lucid react uh tailwind merge and I believe one more tailwind animate css everything else was already here but uh it might have moved position like next you can see the next version didn't change it just moved the position so don't worry the next version was not modified and we also have the components.json JSON which you can think of as a config file for chat and UI and I didn't mention but also or did I uh lucid react these are our icons which we will use for the project but we still can't really see any components here and they instruct us to add a button component here so while we can do that two things that will annoy us throughout this project is first of all remembering what is our version and the second one is remembering to choose d-leacy peer depths every time so instead how about we add all components at once and then later just get rid of those we don't need so we only have to remember the chatsen version one more time and we only have to select d- legacy peer deps one more time as well so I will select this and I will select d- legacy peer deps one last time and let's wait for this to install all dependencies and there we go all of these components have now been added to our project you can go inside of your source components UI and you will see all of them here and that's the power of shhatsen UI they are not just added as npm packages instead they are actual coded components inside of your project which gives you the power to customize every single last bit of them and that's exactly what we will do in this tutorial so let's go and try one component out let's go inside of the app folder page instead of returning a div let's return a button from components UI button in case it's your first time seeing the add sign it's basically an alias which makes it easier for us instead of doing this all the time so basically the alias sign moves the import to source if that makes sense you will see uh it will make more sense later as we work with the project and now let's go ahead and add click me inside once you save this and go ahead and mpm rundev your project again instead of the hello world you should now see a click me button and if you add a variant here like destructive it will change its color but the cool thing is if you click command or control and click on the button to enter it or of course manually go inside of source components UI button you will be able to add or change any variant for example after link make sure you have a comma and add custom text white background purple 500 border two and let's do border red 500 now let's go back to the page and what you will notice now is that it has automatically been added to the types here and there we go we now have our fun funky new variant of course we just used that for demonstration you can remove that now and you can see how you immediately get an error here great so we now learned how to add Chatsen components and how to use them and we've also learned the difference between your usual component libraries and Chatzen which allows us to actually see the code behind each component and modify it to our liking one more thing we have to do is push this project to GitHub so before we do that we have to commit all of our changes and there's quite a lot of them here since I'm using Visual Studio Code I will click on the source graph here and I will simply use the plus icon to add or stage all of these changes this is equivalent to get add dot command once all of these have been changed have been staged you will find them under the staged changes accordion and then you have to enter a commit message in my case I follow the following convention this is chapter01 setup so I'm going to call this 01 setup as well and I will simply click commit that's it i'm not going to touch anything else we still haven't pushed this to GitHub but now we are ready to do so so go ahead and click create new new repository and you will see this screen i'm to call this meet AI and I will select it to private and I will create a repository after that I'm going to go ahead and select the second option which is push an existing repository from the command line so just copy these three lines here go inside of your terminal you can shut down the app you shouldn't have any numbers here or anything because uh nor should you have any numbers here basically it should all be committed and just paste those three lines and once you've done that refresh and there we go your project is now on GitHub and you are ready to follow the proper Git workflows and you can create pull requests branches everything perfect you can go ahead and check inside of your source app page and inside of here you should have a button with click me perfect so I think that wraps up our setup chapter we have set up Nex.js we confirmed our environment we installed Shatsen UI and we pushed our project to GitHub amazing job and see you in the next chapter () in this chapter we're going to go ahead and set up a database and an OM for our project let's get started and let's obtain a Postgres database using Neon you can visit neon.te or you can use the link in the description to let them know you came from this video let's go ahead to the Neon homepage and let's quickly create or log in using Google after you are inside of your dashboard you will be able to create a new project i'm going to call this one meet AI and I will set the database name to meet AI as well once I create the project I can click on the connect button and this will help me obtain my database URL connection string once you've obtained that go inside of your project and create a new environment file in the root of your application go ahead and create a database URL and inside of the quotes simply paste the copied snippet it goes without saying that you should never share this with anyone all environment variables that I will be using are for this tutorial and it will be removed after this tutorial you however should not share this with anyone make sure you didn't misspell database URL here and also do one more thing confirm that your environment file is a little grayed out that means that it's added to Git ignore and that you will not be able to accidentally commit it great after you've added the database URL it is time for us to set up our Drizzle OM so let's go to orm.driel.te theme or use the link in the description to let them know you came from this video so let's go to Drizzle ORM here let's click get started new database Neon and now what we're going to do is we're going to install some packages what I've prepared here is the versions right so what we're going to do is we're going to prepare and without pressing enter we're just going to go ahead and get the latest versions of each one just in case you're watching in the future you will know what versions I'm using so drizzlem04 43.1 neon database serverless is 1.1.1.1 and my environment is 16.5.0 and I will also add [Music] d-leacy-per depths so this is all in one line and this will basically help me avoid those errors which I was talking about regarding peer dependencies please use this line otherwise you will get an error if you get an error no worries just try again and add- legacy pure depths after you run this command you should have three new packages let's go inside of a package JSON we can check here as well neon database serverless environment and drizzle ORM there we go so neon database serverless is version 1.0 environment 16.5 and Drizzle OM 0.43.1 perfect now let's add Drizzle Kit and TSX as our dev dependencies so the drizzle kit version I will be using is 0.31.1 and the TSX version I will be using is 4.19.4 and let's add legacy here deps here as well this will add these two packages right here in the dev dependencies we now have Drizzle Kit and TSX great now we can close all of these i mean you didn't even have them open but I will close them we've already established step two adding the connection variable so we can go immediately to step three i'm going to copy this snippet here and I will go inside of source database folder and inside an index DS let's paste this inside and I'm going to change this to double quotes and I will add an exclamation point here at the end and I will do export const database one thing I want you to double check is go inside of your environment copy this key and paste it here because you would be surprised how easy it is to misspell this and no errors will be thrown if you for example put an I here instead of an L it just won't work so what I recommend is just copy it from here and then paste it here there we go and add an exclamation point to get rid of the error great now let's go ahead uh and do the following thing so in here we we are okay with using neon http uh if you need a synchronous connection you can use the neon database serverless we have it installed so if you want to uh you can do it like this as well great so now what I want to do is I want to create a table and we can do this exactly so I'm just going to copy whatever they did source databases schema.ts let's go inside of schema.ts there we go and this really doesn't matter because we will remove it later but for now yeah let's use integer pg table and vchart here uh and for the id it will be generated always as identity here this will be unique uh and these will be integers and these will be vars with a fixed length once you've done that we have to set up a drizzle config file so we can copy this as well and create drizzle doconfigts in the root of our application there we I'm going to go ahead and just modify these two double quotes i love using double quotes there we go and let's just confirm that this is correct so my out will be uh slashdrizle my schema is at source database schemas let's double check source database schemas my dialect is Postgress and my database credentials are correct and once again just double check database URL and just add it here make sure you have the Drizzle config outside of any folders here great and now what you have to do is you have to apply the changes to the database the easiest way to do that is by using npx drizzle kit push alternatively there are more advanced methods such as generating the actual migrations and then applying the migrations but since we are not working in a team we are working solo this is just a tutorial we're going to keep it simple and we will directly push our changes to the database so let's go ahead and clear this and let's just do a comparison so if you go inside of your neon now and go inside of your tables here you will see that for the meet AI there are zero tables in the public schema but if I do npx drizzle kit push right here you can see that it pulled the schema from the database and it applied the changes so if I try refreshing now I have the users the user has an ID name age and email there we go perfect so we've added Drizzle OM we've added the schema we pushed the schema and we verified the changes in Neon but one thing that we didn't do is verify changes in Drizzle Studio so let's go ahead and do that now using a similar command npx drizzle-kit instead of push you can type studio and in here you can click on local.drizle.studio so you have two options you can either locally use the drizzle studio like this or you can use them in the neon console there we go so these are in sync they are the same uh studio amazing right and now what I want to do is create some scripts just to help us in the future so let's go inside of package.json JSON here and let's go ahead and add database push and let's map that to drizzle-kit push and database studio will be drizzle-kit studio so now instead of doing npx I don't have to do that anymore because drizzle kit is a part of our dev dependencies here so instead I can do npm run database studio like this it's going to be more generic so later on if for any reason you replace your database you can keep the uh command that you can keep the familiarity with your command right and we are also not going to have to remember this command anymore npx drik studio we can just use our database push then database studio like that excellent so I believe that is it we have verified the changes in the studio now what we have to do is create review and merge this pull request let's go inside of our source control here and under the changes let's click the big plus button and this will mark them as staged changes and this is zero to database i believe it is so I will press commit and since we have already connected with GitHub this time uh what we can do is we can check out to a new branch and I'm going to call this 02 database there we go so I have committed but I'm in a new database because I didn't push yet in case you already pushed no worries okay we are just learning the git workflow here you can do the branch process in another chapter it's completely fine no worries but uh if you didn't push you can create the new branch using the IDE just like I did and I will just click publish branch that's it and now my branch will be published so I'm going to go inside of GitHub repository and see what happens inside of my GitHub repository you can see that I have a new branch with recent uh pushes here so I will click compare and pull request but just in case you don't have this you can go inside of pull requests manually click on new pull request keep the main as base and select your new branch here just in case you want to do it manually and then click create pull request and I'm going to now click create pull request now in here uh yours will probably look like mine was a second ago you probably don't have Code Rabbit so what is Code Rabbit code Rabbit is an AI tool which will uh almost act like a teammate for me and it's going to review all of the changes that I just added here and it's going to give me a summary of what I just did and also some comments even some potentially breaking issues so it's a very useful teammate for us and we're going to see our code being reviewed by AI for each chapter so we know we didn't commit any bugs and you'd be surprised in my last tutorial Code Rabbit caught so many bugs i was shocked so I'm excited to see what it will catch now I'm going to pause the video and play it when it's finished and here we go a summary by code rabbit we introduced some new features integrated Drizzle OM and the Neon database support we added a what is a temporary database schema for users including fields for ID name age and unique email we've also added some environment variable management for secure database connections so no worries it did not detect a new environment variable it detected that we're using it for database connections so no we did not commit any environment variables here and we also detected some chores such as new scripts for database migrations and studio access and we in here we have a more in-depth walk through uh specifically we have changes file by file exactly what we modified and how and we even have a sequence diagram which will in become increasingly useful as we add some complex things right now the only sequence it can create is our app connection with the neon database through Drizzle OM but later on when we add some hooks and components it will create equally if not even more useful diagrams to help us understand that and in here we have some actionable comments as you can see here it recommends adding an environment variable validation for database URL basically inside of our let me see index here we put an exclamation point here because we just know that the database URL will exist but Code Rabbit recommends doing an if clause and throwing an error if it's not set and then we can use it without uh the exclamation point it also recommends using the Neon database serverless driver so in our case I'm fine the way it is uh I'm always open to suggestions like this one but uh this is how I initially built the project and I didn't have any problems whatsoever and I think it's okay because with if we are missing the database URL nothing is going to work either way so we don't have to put an explicit if clause for that and as per database uh neon database serverless well using the drizzle you know configuration here we can see it's fine to use neon http serverless is if we want a synchronous connection more specifically if we want to use websockets uh but it's completely fine to use neon http for this tutorial let's see what else it gave advice for so in here I think it's the same thing it's recommending an if check for the database URL of course a good suggestion but as I said if this is missing everything will break anyway and here's an interesting thing so it actually detected that some issues were opened in Drizzle or Drizzle Kit where they had a mismatch between Drizzle Kit and Drizzle OM so our Drizzle Kit version is 0.31 uh and our Drizzle RM is 0.43 so it's telling us to be careful here but it's completely fine uh they don't have to match exactly perhaps that was an issue previously in some previous versions but it's completely fine you can see it's working with no problems whatsoever great so I'm ready to merge my pull request we got a very good review uh and this is how we are going to review our code every time great so once you have merged this you will see this says merged and you can now go back to your code and you can change your branch uh back to main like this and you can press this and click okay and it should synchronize your branch with main and when you look at your graph here you will see that we had our 01 setup commit and then we branched out into a new version uh I mean into a new branch and then we merged that pull request back here so it's important that next to your main branch here you don't see any numbers you can click this button as much as you want it will simply recsynchronize so make sure you don't have any weird numbers here or any numbers here make sure your graph looks like this and that means that you are ready to go onto the next chapter amazing so if you want to have code reviews like this you can visit coder rabbit.ai or use the link in the description if you want to let them know you came from this video i highly highly recommend this especially if you're working solo and have no one to review your code there we go so let's go ahead and wrap this up and see you in the next () chapter in this chapter we're going to go ahead and create our authentication setup we're going to be doing that using better AL we're going to configure the new ALF schema we're going to push those changes to Neon database and we will create a very basic temporary UI which will allow us to create a new user and we will finally create review and merge the pull request for this chapter let's start by adding better out so you can head to better-al.com or use the link in the description to let them know you came from this video so we're going to go ahead and click get started right here and if you want to read more about Better Out you can read it here it's an absolutely amazing library i I have not seen a library as good as this in a while so I'm going to go inside of the installation tab here and we're going to do mpm install better out and just for this project's longevity sake I will use an exact version uh 1.2.8 like this and let's see uh I forgot to add d-leacy peer depths so of course we get an error so let's repeat this but let's add d-leacy peer depths and let me confirm that this was the correct version 1.2.8 it is there we go so when I add d- legacy per depths we have no error whatsoever great now let's go ahead and let's add the better secret environment variable here so I'm going to add this and you can add whatever you want inside or you can use the button generate secret here and just copy whatever is here it really doesn't matter but it must not be empty you need to write something inside for production obviously it would be a good idea that it's something the length of this rather than just you know secret uh but for development it doesn't matter just make sure it's not empty let's also set the better out URL here and we can set it to be localhost 3000 under the HTTP protocol so it's important that you know the protocol of your app and you can find it every time you do npm rundev in here you can see my protocol is http localhost 3000 so you can copy this and add it here it needs to match great and now let's go ahead and let's create a better ALF instance so the place I'm going to do this is inside of source and inside of lib I will create ALF ds and I will simply import better from better out and I will export const here and let's quickly just visit my package JSON just so you can doublech check my versions 1.2.8 there we go now let's go ahead and configure a database as you can see it immediately offers Postgress here but we will actually be using Drizzle so it has an option for that as well of course it does so I'm going to add the Drizzle adapter here from better al adapters drizzle and I will import database from at / database which is our Drizzle instance so this is the exact location that my database is in database index now that we have both of them we can add the database option here and we can select the provider to be PG which stands for posgress of course since we are using Posgress this is the correct option let's see what else we have to do now we have to create the database tables so better out includes a CLI tool to help manage schema required by the library so you have two options to create the actual schema for your authentication if you want to you can use npx better al cli generate or you can manually create it by going inside of the database section here and you will see every single database item that we have what we are going to do is we are going to use the CLI here so we are just going to use the generate one we are not going to use the migrate one because we will be pushing directly to the database now for longevity sake I'm also going to show you the version at the time it looks like the version uh of better out CLI needs to match the better out i'm not sure if this is a coincidence but it makes sense that these two match so yes the version I'm using is 1.2.8 and we don't need d- legacy pure deps here because we're not installing anything we're just generating uh so let's click generate and let's see what happens i have to install this package first 1.2.8 and let's see what will happen once this completes so it's asking me do you want to generate the schema to do /all schema ts i'm going to select yes i want it to be in a separate file so it doesn't accidentally overwrite whatever I have in my schema so I will press yes and there we go schema was generated successfully so now what we're going to do is we're going to go inside of the out schema here we can remove integer we don't need it and now uh what I want to do is I want to copy things just one by one from out schema to my source database schema so instead of this users you know we will have an actual user here so we can remove this actually uh and we can also add this here there we go uh and what I would like to do is just fix the indentation of these so it looks a little bit better there we go like that after we defined our user let's add our session so the reason I'm doing it one by one is just so we are a little bit more aware of what we are adding to our schema and I'm just formatting it a little bit so what do we have so far we have the user here and we have a session and you can see that session has a relation to the user and once the user it's deleted the session will be deleted as well thanks to the cascade method here we also know that uh the email has to be unique for example so that's why we are going one by one just so we're a tiny bit more aware of what's going on here now let's copy the account one so the accounts will be used for social login here uh let me go ahead and fix the indentation on this one here and this one is pretty simple so it has a relation to user as well and let's add the verification which looks like to be the last one here and verification is self-explanatory if we want to add verification we have the table for that as well uh there we go so one two three four tables it looks like we've added here so let me just confirm here one two three four we did not miss any so we can now go ahead and remove the out- schema we no longer need that here because we have added it to our schema right here uh and it looks just fine let's see what else do we have to do now so the next step here is to migrate but we are not doing migration we don't have to do that we have our script for synchronizing with the database and that's going to be database push it's much simpler uh this way so it looks like uh we can do that already so let's do it let's see if we will encounter any errors or will this work uh by itself so I'm going to try and do npm run database push i think we might actually encounter some uh errors here so actually no errors but we do have a question is account table created or renamed so uh this is asking us a question because we previously had uh the users table which we deleted right so we have two options here if you want to you can just nuke the database from neon and just create a new project with the new database and have a clean slate right but what you can also do is just answer to these questions so I'm going to try answering the questions if it seems to be okay no problem but if you for whatever reason think you've messed this up you can always just create a new database and just obtain uh a new database URL paste the new database URL run the command again and you won't have these questions so the account table is a new table so using the arrow keys I will select the plus option and press enter same for the session the only thing I will uh say is the users so the users have actually been renamed here and the verification has been uh added now in here uh is email verified column created or renamed uh so this is a create created column image is the created column created at is created updated at is created uh and looks like at the end of all of that uh I got some errors so I'm not exactly sure if this worked correctly so that's why I wanted to tell you you don't have to worry even if you mess this up like I did what you can do very simply is go inside of your settings here just delete the project right so you have to learn how to work with your database here of course obviously this is just for early development phases you would not consider actually doing this in production you would have proper migration status right but let's just try again meet AI 2 for example and let's click create and again let's click connect and copy the snippet and in here let's just paste this here so just make sure you have the new database URL and you don't have to change anything else let's do npm run push now and let's see if we will have any errors no errors at all because this is a completely clean database and if you go inside of your tables here now in Meet AI 2 you have account session user and verification those four tables which we just added so even though we could probably work our way around this issue and resolve it I just want you to see how I actually do these kinds of things when I develop things I often get into these kinds of conflicts since I'm in early development phases I can just nuke my database and speed up the process again please only do this in early development phases like this one where we are just learning how all of this works excellent so we have done the following we have configured the out schema and we have pushed the changes uh I'm not sure if we can mark this as completely integrated i'm going to check this one last let's see what else we have to do so we now have to add some authentication methods we are going to add social providers later the first one we're going to do is the normal email and password so let's go inside of the out here and let's add email and password enabled true and just like that we have enabled normal email and password but besides that you have pass key username magic link you have so many different ways of authenticating here and that's only uh what they provide you with there's also the community plugins so it's it's absolutely insane now what we have to do is we have to go inside of app folder API out so let's quickly go ahead and do that source app folder let's create a new one called API and inside inside of square brackets out so we are following instructions exactly as they say which I've messed up my apologies out without square brackets and then inside of square brackets three dots all so this is kind of a catch all route and then finally inside of that a reserved file name in nex.js route.ts which represents an API so we can then copy this and paste it inside so we are registering our AL client here to post and get route for our localhost 3000/ API/ and then whatever comes after it this is like a catch all universal route excellent so now that we have that we also have to create the client instance uh so let's go inside of our lib here the same way we created ALF we will now do ALF-client.ts like this and we can just copy this entire thing here and paste it so the base URL of the server you can see it says optional if you're using the same domain so you actually don't need this at all because we are on the same domain and finally you now have uh uh you can now Yeah my apologies no I thought that this was an example but um they are showing you that you can also export individual methods and hooks from create out client instead of exporting the entire AL client but I'm fine with this way and there we go so that's it you are now ready to use better AL in your application continue to basic usage to learn how to use the ALF instance uh to sign in users so let's go inside of the basic usage here and what we're going to do is inside of page.tsx here we will just create a very simple uh form here so I'm going to mark this as use client so I can make it reactive and add some hooks here and I'm going to add email set email use date and then I will do the same thing for name set name and password set password obviously uh this is not how we will build forms but what we we are doing now is just a very very basic confirmation that our uh better out has been integrated properly so what I'm going to do here is just a div and then I'm going to add an input from components UI input which we have because we added all components from chats UI i'm going to give this a placeholder of name this one will be email this one will be password with a type of password and I will just go ahead and give this one a value of name and on change event target uh value and I will just copy these and add them down here there we go uh oops I completely forgot to actually wrap this uh so this will be set name this will be set email this will be set password the value here will be email and the value here will be password i will just collapse this so you can see better okay I just collapsed these elements so you can see them better and let's go ahead and try it out all we need is a button here which will say create user so I'm going to do npm rundev and I will visit my localhost 3000 which should now show my very simple form here we can give this a class name padding four flex flex column and gap y of four just so they have a little bit more space here and what I will focus on here is my network tab i want to see what's going on here as well so what we want to do now is we want to learn how to use better out here so let's import out client in here and let's use the out client in our onsubmit method here so what I'm going to do is call out client dot sign in and let's see if is that the correct one my apologies it is sign up email and inside of here I have to pass in the email i have to pass in the name and I have to pass in the password so these are the three required ones you can also pass the image if you want to and the callback URL and let's also add these right here so on error let's do window alert something went wrong on success window alert success just so we are aware of what's going on great so now that we have this um let's go ahead and try submitting so const on click on submit so I think by default we should get an error here just by clicking this let me try there we go something went wrong obviously we get an error because we have an invalid email because the email was not passed at all so I'm going to set my name to be Antonio my email to be Antonio at uh demo.com and let's use the password to be password one hint your password needs to be I think at least eight characters otherwise it will throw an error so if I just do one to three and click create user again we have an error here password is too short so try 1 2 3 4 5 6 7 8 and let's see again something went wrong let's see what exactly it is there we go so uh this one wasn't exactly clear from the return here from the network tab but if you go inside of your terminal you will see some errors server error weather out error drizzle adapter the model user was not found in the schema object please pass the schema directly to the adapter options so this is what I was waiting for because I knew that my AL configuration looked a little bit different so I was waiting for the reason why and it looks like because we need to add our entire schema so let's import asterisk as schema here from at database schema and let's go ahead and pass the schema here and simply spread the schema like that so we have now connected our schema user session all of these things with the schema here and I think that if you kind of like try and rename something here you might actually get an error here or not maybe not but let's try again now so I'm going to try Antonio antonio demo.com and 1 2 3 4 5 6 7 8 create user looking promising and there we go success 200 and we can now go inside of our neon console here refresh this and go inside of user and there we go you can see the actual user so Antonio demo.com you can see when we are created you can see the matching account with the credential provider ID because we didn't use the social login we used credentials and you can also see the active session because we are automatically logged in actually and the verification doesn't exist because we didn't add anything regarding verification but yes this is the part that was missing adding our schema here uh and one more thing I want to check here is is there a nice way to maybe display that we are logged in uh let's say uh can I check let's actually try and follow the documentation here so this is sign in okay that works just fine social sign on how do I actually see the session that's what I'm using there we go the session so I'm just going to go ahead and add this here from outclient use session all that I care about is the data which remaps to session here so what I'm going to do is I'm going to check if I have a session we are going to return a div here with a class name flex flex column padding four and gap y of four and I will add a paragraph logged in as session do user name like this and let's add a button here sign out on click and I think we can just do outclient sign out here like this there we go you can see that in initially it shows the the register that's because this is an actual fetch request so it's loading for some time you can of course extract is pending here if you want to handle that but this is just for demo and when I click sign out uh there we go and the cool thing now is that if I try registering again I will get thrown an error because this email is already taken user already exists perfect so the only thing that's missing here is a way to uh log in so let's quickly add this as well just for fun let's do it let's do a class name here flex flex call yep y10 and we can just copy this entire thing and paste it below and this will be login this just needs the name and onsubmit will be on login here and let's just copy onsubmit here let's call it on login outclient sign in looks like we can also use email just like that there we go so let's try this let's try antoniodemo.com and yes both of them will be filled but that's completely fine let's try the wrong password first password click login something went wrong and I didn't open my network tab but I'm pretty confident that we got as you can see from the code 401 let's try again invalid email or password now let's try actual password here actually 1 2 3 4 5 6 7 8 let's try logging in and success there we go logged in as Antonio just like that we have implemented credential out and it only gets easier from here this was the hardest part of our authentication absolutely amazing amazing library uh and of course we only tested this in the client mode because it's just you know easier to create a form here and add all of these callbacks and things but you can have equally uh good developer experience with server components and their server util and we will use that later on but as I said for this chapter I just wanted to build like a very dirty basic UI to ensure that we can actually create the new user and now let's go ahead create review and merge this pull request so I'm going to go inside of my graph here my apologies my source uh source control here uh and I'm going to go ahead and add all changes and I before you commit you can open the branch whenever you want so you can for example add the changes make sure they are in staged go ahead and click uh checkout to and then create a new branch so I'm going to call this uh 03 authentication setup i think that's the branch name yeah authentication setup and the message will be the same you can see your branch is down here you can click commit here and you can publish your branch as simple as that so your branch is now available for review let's go ahead and click compare and pull request and let's create a pull request and in a couple of seconds we will see the review by code rabbit and here we have the summary so new features we have introduced a complete authentication system with user sign up login and sign out capabilities we have added a user interface for authentication including forms for registration and login as well as conditional rendering based on the authentication status a new API endpoint to handle authentication requests and we have expanded the database schema and of course the new authentication library dependency in here we have a more in-depth walkthrough as well as file by file change and a sequence diagram explaining how our current form actually works so you can see here that when we fill up the sign up or sign in form we call the sign up or login method which actually reaches the API al route which then handles the AL request and then using the uh to the database it validates or stores the user session and account entities and then it equally returns that state back to the user and the UI of course it left a ton of comments in regards to our form because that is just a temporary form which is missing a ton of things so naturally all of these recommendations are correct but no point in resolving them because we will be deleting that entire component uh in place of a proper one here but if you're interested you can pause and read just to see how this AI bot actually works because it is quite impressive as well as the suggestions it gives you uh excellent and it actually refactors like your entire component but we will be doing that later so no need to accept this uh in here it adds some suggestions for our schema and regardless if this is uh more correct or not I don't want to change anything because I want this to be strictly compatible with better out i don't want to you know uh accidentally mess it up uh great uh so in in here it marked a potential issue sensitive credentials stored as plain text i think that is a confusion because this is called text that doesn't mean that what's stored inside is not encrypted right it is just a text type this is true it could be a varcher with a uh token limit but I think they do exactly that they encrypt it but they just store it under a text type from Drizzle all of these other suggestions are semantic or new syntax here so I'm going to go ahead and merge this pull request because I am satisfied with this result excellent once you have merged this go back to your IDE here and switch to your main branch so you just have to find the origin main and then just go ahead and click this and fetch origin here and that should recsynchronize everything here when you go to your graph there we go you can see that uh we have added the database in the previous one and in this one we added the authentication setup and everything regarding authentication let me just close package lock so you can see the actual uh code like our session and our form and we just merge that into main you can of course go inside your app page to confirm that you can see the code in here excellent so that's it we just merged our code you can always try this multiple times in case you think it's not synchronized for whatever reason and that's it let's go ahead and mark this as completed amazing job and see you in the next () chapter in this chapter we're going to develop the UI for our authentication this will include the AL pages out layout out module and finally the AL views or components let's go ahead and let's do one thing first so right now if you take a look at our package JSON in here you can see the d-turbo packac option and when you run your app you will see the turbo pack here and you will see turbo pack right here what I want you to do is to remove turbo pack that is because I found an issue with the layouts which is something that we will be learning in this chapter and that issue simply makes it a bit harder to demonstrate uh what I want to teach you in this chapter so for now go ahead and remove that and save package JSON and then go ahead and do npm rundev again if you you will know that you've done it correctly when you no longer see turbo pack as opposed seeing it right here so just go ahead and do that that is the first thing we have to do the next thing we are going to do is create our first route so let's go inside of source app folder and let's do sign dash in and inside a page dsx file let's go ahead and do an export default and let's simply return sign in page two things you have to know here page is a reserved file name if you've named it something other than page Nex.js will not recognize this as a route the second important thing is to always do a default export in that reserved page file name otherwise Nex.js will not be able to find the component it needs for routing now if you want to find this what you have to do is simply go to localhost 3000/sign so let's go ahead and visit that page right here so you can see I still have my old form here but if I go to localhost 3000/sign-in we can find the sign in page so now let's go ahead and copy and paste this and let's rename this one to sign up let's go inside of the page and change this to sign up page this one is visible at the same one just dash sign up there we go now let's say that I want to add some design here for example for this signin page I will add a class name background muted flex minimum height of svh flex column items center justify center padding of six medium padding of 10 and then I'm going to add an inner div here which will be used to limit the width width will be full by default but on mobile devices the maximum it will be able to expand to is 24 rem or 384 pixels on larger devices we are going to increase this to 3 XL or 768 pixels now let's go ahead and check this out so sign up page is all the way here but if I go into sign in you can see how it is uh pushed down here and this is actually centered and it will be easier for you to understand that if you for example wrap it with a card component you have the card component available since we have added all components from shatzen UI so it is right here in source components UI card and that's where you can import it from so now it makes more sense this is definitely a centered component what I want you to do now is go inside of sign up page here and simply add the same card without anything else so just the card so now you can see a clear difference between sign in and sign up pages they are they have different backgrounds and they have different positions but since we know that we want the exact same style for both of these routes there should be a way to reuse this layout and there is let's learn that by creating a new folder called AL let's go ahead and select both sign in and sign up and let's drag and drop them inside if you are asked to update the imports you can select yes now first thing you will notice is that our page has turned into a 404 that's because it is no longer available at /s sign in now it needs out sign in that's how you create nested routes there we go and same thing is true for sign up but what we've unlocked now is a parent folder parent folder can now have a layout file layout is a reserved file name just like page and it behaves pretty similar it needs to have a default export the name of the component does not matter but what does matter is that you always return the children from here children are a type of React node let's go ahead and destructure them from here and let's render them inside of this empty div so right now not much will change sign up still looks like this and sign in still looks like this but what I want to do is I want to go inside of sign in here and I want to copy these two divs and I will instead put it here in the layout and I will add an additional closing div here and I will indent the children and now I'm going to go inside of the sign-in page and I will remove everything besides the card here so my signin page and my sign up page now look identical besides the text inside of them and in my layout I have now added the class names and what happens now the signin looks exactly the same and the signup also looks the same signup has now gotten those styles that it didn't previously have so that's the power of layout files layout files are reusable well layouts that you can use and this will apply to every route that I create inside of the out folder that's why we needed a parent folder but you are probably wondering what if you just want to have an organizational folder right because while this is cool it also extended our URL right we now have to visit using /out here what if I want to go back to this do I have to write the layout file individually in each page as I did before no you don't what you can do is use something called route groups go ahead and rename this into AL in parenthesis if it asks you to import to update the imports you can select yes what this will do is it will mark this as an out uh as a route group which means that your routes are now officially accessible back through its original URL you can see that the current one is 404 but if I go back to my old ones there we go now I have a much cleaner URL but I also preserved the ability to create a unique layout file for that group of routes so this basically tells the Nex.js router do not include this in the URL that doesn't mean don't include this folder in routing it simply means this specific folder it's just a grouping folder right this will not be a part of the URL this will be a part of the URL and you can nest this kinds of things as deep as you want they won't stop working right whenever you have something in parentheses inside of the app folder it will be excluded from the URL but that does not mean excluded from routing that's important to understand great so now that we have this set up and we have learned about the layout and how we can use it how about we go and create the actual module so let's go inside of the source make sure you are in the source and create modules and inside of here create the ALF module and in here I'm going to keep everything ALF related let's start with our UI in here we're going to have views so modules out UI views go ahead and create signin view.tsx just like this this is a component so it does not need to have a default export we can just do sign in view and return sign in view like this or let's be a bit more specific uh let's return a card from components UI card and now if you go inside of your sign in page so right here in the out route group you can just return that sign in view so now our page here is used purely for routing and it just renders this and we are going to develop the actual code inside of the module where it belongs so now sign in looks identical so let's go ahead and do the same thing sign in view let's copy it sign up view let's rename this to sign up view and change this to sign up view and just to clarify this is a my code structure this is not something you have to do modules is not a reserved folder in Nex.js this is simply how I like to separate my modules right instead of writing the actual code in pages I mostly use page for redirects for prefetching uh and then I just render the actual component I need maybe for some suspense or something like that but I keep them as server components so that I can leverage everything server components has to offer and then I simply do the client stuff inside of these views right here so now let's go ahead and go inside of sign up here and let's do the same thing here so sign in view my apologies sign up view remove the unused imports and you can remove these comments we now know how to access these routes right and uh now before we move on I just want to go quickly back inside of these views and into both of them go ahead and add use client at the top so signup view and signin view both of them should have use client at the top and what I want you to do is add a console log sign up view and go inside of sign in and add sign in view and then go inside of these pages here so sign in page add a console log here sign in page and sign up sign up page so all of these four should have both the views and the pages the only difference is that signup views have these use client thingies i'm purposely doing this to show you something so you can see that when I'm on my signin view the signin page console logs from page.tsx but it has a server prefix this means that it's actually logging this on the server and not on the page right so I just wanted to show you that difference and if you go inside of the sign up you will see the same thing you can see we have signup page on the server whereas signin view is the actual client component so you can now remove these console logs and uh I'm going to talk more about server and client components moving on but I think this is this will gives you like the most basic uh difference between the two so our views need to have use client because we're going to do client stuff in them so let's start with the signin view what I'm going to do is I'm going to wrap this inside of a div whoops let's just move that here i'm going to wrap the card inside of a div and I'm going to give the class name flex flex column and gap of six now for the card I'm going to give it a class name overflow hidden and padding of zero then I'm going to import card content from the same at /components UI card like this in the card content let's give it a class name here grid padding of zero and on desktop grid columns 2 so right now if you add a paragraph for example column one and then another one column two and head into sign in you will see that these columns are next to each other but when you zoom in they collapse because that's exactly what we told them to do only on desktop this has to become two columns next to each other otherwise it's going to be beneath one another that's exactly how we want them to behave great so now what I'm going to do is I'm going to uh create a form element here like this and in here I will create a div element simply so we can begin separating these two now let's go ahead and do the following let's do the second column uh first because it's easier so this column right here we're going to do a class name here background radial from and then in here uh let's go ahead and say green 500 to green 800 something like this we can experiment a bit let's try 700 to 800 or maybe make this a bit darker something like this for now it's okay uh let's keep it relative hidden MD flex flex column gap Y of four items center and justify center so now you should see column two here in the center like that and now what we're going to do is we're going to render a paragraph here with a class name text to Excel font semibold and text white and this will have meet AI text inside or whatever you are going to call your app and then above this we should have a normal image element so yes it should have this warning that's okay we should go to /lo.svg svg and give it an alt here of image and give it a class name here of height 92 pixels and the width of 92 pixels now you will get this because we don't have a logo yet and I'm going to show you where you can get one so I find my placeholder logos on logo Ipsum i think it's an amazing website with a bunch of placeholder logos all right so you should only use this for your demo applications and the one I found is this one so logoipsum.com you can of course find the link in the description all you can do is just click on this logos and that will copy the SVG you can of course use the normal download or you can just click copy and then go inside of public logo SVG and paste it inside let me just uh yes if it asks you to open that uh just click yes to open the editor and then paste it inside and then this will uh have the logo and when you refresh there we go we have the logo now let's go ahead and just change the colors a little bit here so we have this color E22935 go ahead and use the find and replace option here and change it to the following color 6 a34 A and click uh this one to replace all instances there's two of them there we go so already when you refresh you will see a change of color but now we have four more instances of the red color so use the find method again you can use control F or command F if you haven't been able to find it and replace this one with 6cc58D and you can use this one to replace all four instances and refresh and there we go perfect so that is it for this column right here and now we can focus on actually developing uh the form so what I'm going to do is I'm going to go back in my sign in view here and since we installed all components from chaten we also got some new packages uh and one of them is zod so we can import z from zod and you can go inside of package json and search for zod to confirm that you have it besides this we are also going to need uh zod resolver from at hook form resolvers /zod and we are also going to need the input component from components UI input we are also going to need the button from components UI button and we're also going to need all the components from components UI form so let's add this as well you have all of this installed right all of this already exists in your project uh don't confuse this ad sign with this ad sign so this is the name of the npm package and this is the name of our alias that's where I add space between imports to separate my npm imports versus my local imports besides this let's also import the alert component so alert and alert title from components UI alert and uh let's also prepare octagon alert icon from Lucid React i think that's enough for us to start with the development of the form so let's define the form schema here to be Z.Object object email a type of string and email and password also a type of string and the only thing I'm going to pass here is the minimum length with the message password is required I will not change this to be any other length because this is the sign in view so it really does not matter what length I put here right uh the length matters for the registration but I don't think you should ever enforce the length on the sign in view because uh what if you change your requirement later on and you have a bunch of users who no longer meet the requirement you will prevent them from logging in so it only makes sense to enforce that on registration so now that we have the form schema let's go ahead and let's get use form my apologies const form from use form and we did not import this but we should from react-hook-form this is another package that we have installed react hook form you can find it here you can find hook form resolvers you can find lucid react all of those are installed when we added all components from SHA CN UI great so now that we have this inside of this let's define Z infer and let's add type of form schema inside of this let's add a resolver to be Zod resolver and pass in the form schema and let's finally add the default values this should be an email and a password just like this now let's go ahead and let's go back inside of our card content here and I'm going to uh separate these with a space just so I can find them more easily and let's actually add our form with a capital F to wrap our native form element so this form with a capital F is the import from Shadnui and it needs the entire form props so this is like a provider for all the form hooks and components which we are going to use going forward let's give this form a class name of padding six and on large devices padding 8 then let's finally remove this text and inside let's open a div and another div inside with the first outer div give it a flex flex column and gap six and in the inner div give it a flex flex column again items center and text center inside of this inner div you're going to render an H1 element and below it you're going to render a paragraph element the H1 element will render out welcome back with a class name of text to Excel and font bold and let's quickly see how that looks like there we go and in the paragraph here add a class name text muted foreground and text balance and in here you're going to render log into your account now let's go ahead and outside of this inner div but still inside of this outer div you're going to render a div with a class name grid and gap 3 and inside you are going to render the form field which is a self-closing tag pass the control prop which is form control name which is email render which will destructure our field and go ahead and then inside render form item inside of form item add a form label and write in your label for this field which is email then add a form control and finally inside the component you want to use which in our case is a normal input component type is email placeholder can be m@example.com and go ahead and spread field so now this input becomes a controlled component so that's how we are going to build our forms modularly and you can also add a self-closing form message which will be used to render errors if there are any excellent so now you have your email uh right here perfect and now what you can do is you can copy this div including the form field paste it below and change the name of this to be password and if you haven't noticed already this is uh strictly typed so I can only choose between email and password because it reads from our default values here it reads from our form schema so now in here where we added the name password change the form label to be password and change the type to be password and for the placeholder well you can just add some asterisks here 1 2 3 4 5 6 7 8 there we go so now uh let's go ahead below this and outside of this div we are going to do the following let's do true so literally hardcode the word true and render the alert component and inside render the octagon alert icon and close it and then add an alert title and render error in the alert give the class name of background destructive divided by 10 which basically means 10% opacity then uh let's go ahead and add border-none and for the octagon alert icon give it a class name height four width four and add an exclamation point text destructive this marks as dash important uh I mean exclamation point important so now you have an error here so this is where we are going to display our server errors because we don't know what field exactly caused an error but maybe our connection went out maybe the database is down this is where we're going to display server errors that's why I have hardcoded it to true later this will be an actual uh boolean value below this add a button and sign in text go ahead and give it a type of submit and a class name with pool like this there we go and now uh let's go ahead and do the following here below this button add a div with a class name after border dash border a relative text center text small after absolute after inset zero after top 1 and a half after zindex of zero after flex after items center and after border top add a span element here or continue with and give this a class name background color of card text muted foreground relative zindex of 10 and px of two so now you have this cool looking line crossing text and in here we're going to add the buttons to log in with socials so outside of this div go ahead and add another div which will serve as our grid specifically handling two columns here if you have three social login you would change this to three right in here add a button go ahead and give it a variant of outline a type of button and a class name with pool type button is quite important otherwise this button would submit the form and inside of here uh what we are going to do is render the Google icon so for now let's just add the text Google and in here GitHub so now you have Google and GitHub texts right here great uh and then what I want to do is go outside of this div right after we close this button and add one more div here with a class name text center and text small and in here you're going to add don't have an account and you can use you can't exactly put an apostrophe here you have to use at signappos like this so don't have an account import link from next slashlink and in here you're simply going to redirect to slash sign up if you don't have it and inside just sign up uh you can also do if it's easier for your eyes you can add an empty space like this and then collapse this there we go and give this link a class name underline and underline offset 4 there we go don't have an account sign up like this great so now uh what I want to do is just one more thing here outside of this card here add a div with a class name text muted foreground asterisk column square brackets href element column hover column text primary text center text extra small text balance again this type of sign but this time for underline and then just copy it and add underline offset four and inside of here you can add a text by clicking continue you agree to our and you would probably use an href or link here for terms of service and privacy policy and give this also an href so just some template for you to have there we go perfect so now let's go ahead and actually make this form work so in order to do that we have to create uh the we have to add our ALF utils so let's go ahead and import the ALF client which we can do here there we go out client from lib out client like that and let's do the following let's add con router here use router you can import that from next navigation like that and then let's also add error set error to be use state from react by default set it to null and give it a type of string or null you can import use state of course from react and now let's create our const onsubmit method which is an asynchronous method which accepts data which will be z.info type of form schema so we know exactly what kind of data we are getting here first of all we are going to reset our error here and then we're going to extract the error by using await outclient signin email and in the first argument for this option we will pass the email to be data and password to be data.pass and in the second argument we are going to pass in the on success here which will be router.push push to the front page and then in here if we have an error actually we can do this better we don't need this to be asynchronous at all we can just I think do this and then in here on error set error error which we have to get from is error and let's see dot error dot message like this or yeah I think this will always be available maybe we can destructure this yeah and then like this I think this should work and now what we I have to do is go inside of this form here it's a native HTML element and add on submit here to be form handle submit onsubmit let's see any errors we do have an error here unused variable so let's go and find our alert button instead of true it will be if we have an error and you can add double exclamation points here make sure there's double so this turns it into a boolean and in here just render the error so let's go ahead and try it out so just by clicking sign in you should have the normal forward validation errors but if I try using something that doesn't exist so I'm pretty sure I don't have this user and click sign in I should be getting an error back there we go invalid email or password so this came from the server right if I if I try this again you can see that this error message is coming from the server and we are rendering it here so the user knows something went wrong we can improve this a little bit by also adding uh the let's see what we can do disabled if we are submitting but I'm trying to find a good way of doing this so we could of course you know just add a new field set is loading maybe I should do that because yes we can also use the form state is submitting but since we will be using um social login buttons I think it's more reliable for us to actually introduce loading and actually this will be pending set pending use state false by default so set pending here false as well and let's go ahead actually this will be set pending to true and then in here we're going to add on let's see do we have on uh we can just do it after this I suppose then set pending false maybe this isn't No this will not work like that we can just do this it's easier and then find the button and if it's pending disable it so now you have a nicer experience you can see the button is disabled until it either returns with an error or success so you can copy this and also add it to these buttons right here there we go perfect so this form should now work now let's go ahead and copy it so we can copy everything in here and go inside of signup view and paste everything in here i'm first going to rename this back to sign up view and go inside of my sign up page to ensure no errors are being thrown and when I control or commandclick here I will be redirected to this newly copied component make sure you are working in the new copied component so you don't override anything and let's start by introducing uh the new form schema so besides the password here we are also uh I'm also just going to say password is required i won't introduce any validation here because we have backend validation from better out but what I will do is ensure that user has to confirm password and I will also add a name which will be Z string and min one message name is required the reason we don't need that for email is because this takes care of that but the confirm password uh will be a little bit different so this can stay the same and we're then going to add dotrefine get the data and check if data.p password matches data confirm password but if it doesn't the message we're going to pass is passwords don't whoops passwords don't match and the path well this basically means what field should show this error that should be the confirm password like this there we go so now inside of here everything can stay the same but we now also have name and we have confirm password and now what we have to do here is we have to change the onsubmit method to call the sign up method and we also need the name here so data.name that's it no errors at all and now in here we're going to change instead of welcome back this will be let and let's use at@ appos so let's get started and this will be create your account the first field here will be name so you can copy the the entire form field with the grid gap and paste it above change this name to be name and this to be name and the type can be text and this can be John Doe for example so you can click sign up here and you should be seeing that new form which now has name here now below this we have email below that we have password and then copy the div grid gap and the form field paste it below and change just the name here to be confirm password and well uh we should also change this to be confirm password I guess there we go so let's just zoom out a bit there we go so let's just try something here let's try 1 2 3 and 1 2 3 4 there we go passwords don't match but if I try 1 two three you can see that it works so let's try adding a new user for example and I will also prepare my database here so what we can do of course is run mpm run database studio here which should get us you can click this link and this should open the studio then and in here I think I have one user Antonio demo so let's go ahead now and create a john john john john john john john john john john john john john john john john john john john john john john john john john john john john john john john john john john john john john john john john johnondo.com and let's add 1 2 3 4 5 6 and let's do 1 2 3 4 5 6 I'm purposely doing something wrong to see if This will throw an error there we go password too short so let's add 78 78 and let's see what's going to happen now there we go logged in as John and if I go ahead and check uh my Drizzle Studio here and refresh this and refresh this there we go johndemo.com so if I sign out now and if I go back to sign in here I should be able to log in as John demo.com let's try an invalid password first there we go let's try the correct password and there we go i'm logged in perfect so we have completely uh modified the form from the previous one now it looks much better of course but there are some things we still have to fix including this one let's wrap up the chapter with this so inside your sign up view go down here and change this to sign in and this to sign in and instead of don't have an account it will be already have an account so now you can switch between sign up and sign in here so what we have to do is we have to improve this gradient a bit i don't like how it looks and we have to add proper icons for this and of course we have to actually enable Google and GitHub social signins but that will be for another chapter and also this button might need have might need to have a different primary color we'll see about that later but yes you can play around with the form i'm pretty satisfied with how it turned out great let's go ahead now and wrap up the chapter we created the out pages out layout and the out module we created the out views we got the register login and the app logo and now let's create review and merge this pull request so what I'm going to do is uh you can change your branch either from using the three dots here and then clicking check out too and but I think you can also do clicking here and then create a new branch from here maybe that's easier and let's call this 04 authentication UI let me just double check it is 04 authentication UI there we go i'm on my new branch now I will go inside of the uh source control and I will click plus here now all of these are staged changes i will add 04 authentication UI here confirm one more time i'm on the new branch and I will click commit and publish branch now let's head to GitHub let's go ahead and open a pull request here and create a pull request and let's wait a second for our AI reviewer to start and here we have our code summary so let's for change read the walk through instead this is a bit more detailed so this update introduces a new authentication related react components for signin and signup flows including form validation and UI layouts we also add a layout wrapper for authentication pages and we updated the development script to remove the turbo pack flag so that's precisely what we did in here as always we have a file by file change and in here we have an interesting sequence diagram this is what I was talking about this will make it easier for us to understand what we just developed so the user navigates to sign in and that renders the signin view component from the signin page the user submits email and password in the signin view which is then sent through the out client depending on success or failure we either redirect to home or we display the error alert and the same functionality is for sign up view and signup page in here we have some actionable comments here and this is an actual issue I forgot to do so it caught that in my sign up view i forgot to change the submit button label it still says sign in so this is something we're going to fix in the next chapter great catch by Code Rabbit AI and then of course it gave us actionable advice here to enable the social login but since we don't yet have them u configured we will not be doing that nevertheless let's go ahead and merge this pull request once the pull request is merged you can go back to your IDE here go ahead and click here and find the main branch whether you will use this main or origin main it does not matter just make sure it's main or if you use anything else for your default branch and once you're there click on this button to pull and push commits from origin main this will make it synchronized with everything else so there we go perfect amazing amazing job now let's go ahead and mark this as completed and see you in the next () chapter in this chapter we're going to go ahead and implement social provider login for GitHub and Google we're also going to learn how to protect our non-ALF pages let's go ahead and check if you are running your app so npm rundev after that go to localhost 3000/sign so you're viewing the same form as I am after that let's go to better out i would highly suggest that you follow the documentation alongside with me go inside of the documentation authentication and find GitHub the reason I told you to follow alongside is so you can copy the code snippets but also use the very useful links they have added so in here they have prepared the redirect URL for us so go ahead and copy this click on GitHub developer portal it's located in your settings developer settings click new or out app let's call it meet AI and authorization callback URL is the redirect URL for the homepage URL you can just set the local host 3000 if you are unsure if the protocol or the port are correct you can double check here when you run npm rundev you can see your local URL if it's anything different for example https or 3001 no problem just modify it here and here after you are ready go ahead and click register application this will uh allow you to copy the client ID so go to environment and add GitHub client ID and prepare GitHub secret my apologies github client secret go ahead and click generate a new client secret and copy it go ahead and paste it here and that's all you need now what we have to do is configure the provider so let's go ahead and copy the social providers here now let's go inside of source lib out and go ahead and add the social providers here make sure that you have added the client ID and the client secret for the GitHub social provider as always what I like to do is copy from here and then paste here just to double check so copy from here and paste here the reason I always advise doing this is in case you misspelled this for example like this you can't really see it immediately but this is a different variable right i missed the letter T for example so that's why you always copy from here and paste here great now let's go to sign in view and find your or continue with part find your two buttons Google and GitHub and go ahead and add on click here and simply call our client sign in social and add the provider and set it to GitHub like this so now if you go to your sign in view here and click on GitHub regardless if you are trying to register or log in uh all out works the same way if the user doesn't exist it will create it if it does exist it will just log in so it does not matter that we are doing this from the signin page also double check that you didn't accidentally register with your existing GitHub email if you have go ahead and remove that user from your database you can visit Dusel Studio or Neon Tables so let's click GitHub here and in a few seconds we should see the authorization screen let's authorize and I should now be redirected back to the homepage here if you for whatever reason were not redirected you can manually go to localhost 3000 here wait a second and you will see your GitHub username right here great now let's go ahead and let's sign out let's go back to sign in here so what I want to do now is I want to copy this here and I want to go to sign up view find the GitHub button here and add the on click here so now both from the sign up and from the sign in GitHub should work what we have to do now is the Google login let's go ahead and click on Google here and let's go inside of the Google Cloud Console so before you do anything here what you have to do is create a new project using your navbar you can select your current project and in here you can click new project i'm going to go ahead and call this meet AI you don't have to select any organization and go ahead and click create and now just wait for your project to be created it should be done in a second and click select project now you will see your project name here in the project picker and if you try clicking on these credentials or oath consent screens uh you will probably at one point be redirected to this Google out platform that's because I've noticed that Google is in some kind of migration phase where they are introducing this Google AL platform so to make this easier for you to follow let's follow from the actual better AL documentation so let's together click on Google Cloud Console that seems to take us to APIs and services here and usually what you would do is you would go and create the credentials but in here I have this warning remember to configure the Oout screen uh before we create the credentials so usually you would click here right and as you can see that takes me to Google out platform and tells me that the Google out platform is not configured yet so basically you need to find a way to configure the out platform i just showed you one way of getting to here and then click get started here and that basically takes you to the overview so let's call this app meet AI let's use whatever you have for the user support email and click next for your audience select external so that anyone can test the app go ahead and click next and enter your uh contact email address here and click next agree to the terms and service and continue and click create and this will set up the Google AL platform right here so what I would suggest you do now uh is click on branding just to see everything's okay so the app name is meet AI this is the support email and here's an advice do not add a logo if you add a logo you will need to submit your app for verification which can take some time so don't add any logos do you don't have to add anything here i'm just checking that the name is correct now let's click through audience here and this is important before you create the credential click on the publish app push to production so here here it is if your app's configuration has more than 10 domains or if it has a logo or request sensitive or restricted scopes you will need to submit for verification so that's why I told you to not add a logo because this way you can just push to production like this that's it that's all you have to do make sure this says external here and now let's go inside of the clients here and now we can finally click create client in here go ahead and select web application and go ahead and call this meet AI and now in here select add authorized redirect URIs and in here you can just copy this one let's go here and let's add it here so double check the protocol and the port and click create and this will now show you your client ID and your client secret so let's go ahead and add to Google client ID and Google client secret there we go make sure you have both of them here and click okay and now you're ready to go inside of your sign in view here copy the on click go to Google and add the Google provider here go to the sign up view and do the same thing now let's go ahead and try it out so I'm going to go ahead and click Google it doesn't matter from sign up or from sign in let's click Google and let's wait a second this should uh open up the Google login let me try refreshing or maybe there is an error maybe we did something incorrectly well we did something incorrectly most certainly and what I don't like is that we are not getting any Oops I just clicked GitHub uh no no no i don't want to log in with GitHub so basically we are not getting the errors here so what I want to do here is set error to be null and then in here I'm going to do on error how about we let's standardize this shall we so okay go inside of sign up view right here and you can copy the onsubmit method entirely paste it below itself and rename this on social change this to be provider change it to GitHub or Google set the error to null and the pending to true change this from email to social and simply pass the provider as you can see the provider it has to be sign in dosocial so even in the sign up view you have to use the sign in for the onsocial so the provider type can be all of these as you can see when I hover it's an enum not an enium sorry it's this type of type so this actually matches so I can just set the provider prop here and the error goes away and in here you can set the pending false here and set the error message here like this and then you can use the on social in the buttons below so let's try it like that or sign in with and let's do on social Google and in here on social GitHub so now what I would like to do is copy the on social here go to sign in view here and keep it like this and then just change these as well so on social Google and in here on social GitHub so now the reason I did this is because when you click on Google it should now say provider not found that's because we actually forgot to add the provider here so let's quickly do that let's add Google to our alph.ts where we just added GitHub so let's just add Google below this and as always let's double check this so Google client ID oops so copy this paste it here copy this paste it here and now let's go ahead and try again google There we go let's click on this one let's click continue and I should now be logged in as John Doe there we go so what I want to do now is I don't know if you've noticed but even before I selected my account I already got redirected to the root page that's probably because of the way this on social here handles the on success so I think on success here might be just successfully making the oalf request so it already pushes me here which is not good because at this point the user would not be logged in so what we can do here is add a callback URL like this and I just want to confirm let me just check inside of better out can I search for call back URL as you can see we can also do it like this i'm trying to find the fallback URL okay so we can use relative imports relative URL i was wondering if I need to do the whole local host or not and then I'm going to remove the router.push from here so that's in the signin view let's do the same thing for the sign up view so remove router.push here and add call back URL to forward slash and how about we do the same thing for sign up with email so we can add call back URL so we don't have to do router.push which means we don't have to use router which means we don't need the next navigation import and do the same thing in the signin view so in the onsubmit sign in with email remove router.push and add a call back URL to be a forward slash remove use router and remove next navigation so let's go ahead back to / signin now and let's try logging it with GitHub so I should now only be redirected in the call back there we go perfect so I think that now we can officially mark this as completed now let's learn how to protect our non pages here so I think we can finally now go inside of source app folder page and remove this entire thing div homepage we can remove all of this imports the only thing I would actually like to leave here yeah let me just revert it a bit sorry for telling you to remove it i mean I just I'm just using it so I have so I can copy these two things this is the only thing I care about there we go so I just want this to be here which means that uh I need to get data session from out client use session and I need to mark this as use client and I need to import button from components UI button and in here if there is no session return loading Okay so make sure you've marked this as use client and I just want this i don't need the entire form or anything so the problem now is uh as you can see well I didn't really handle this correctly right because there is no session here so I just return loading but I actually want to handle it a little bit differently so this is how we would do it let's go inside of source modules and I will just create a home module and inside of the home module I will create a UI folder and then I will create views and this will be a home view.tsx so that will actually be this page here let's paste it here and let's just export con home view here and we can remove the default export entirely so this can be the use client part right in our home module here home view so now we are free to use our server component here as an actual server component so we can remove everything here and just use it as a server component so inside of here what we would do is we would return home view like this so right now it should work exactly the same it's displaying loading because I didn't do any out here to I didn't I I basically if there's no session I just say it's loading right so what I want to do instead is use a server component to redirect the user back to my AL pages and the reason I want to use a server component for that is well so we learn how to use the server uh util of better AL and simply because it's better to redirect direct from the server side than from a client component if we already have server components right why not use them to for what they're good at so let's go ahead and get the session here using await which means that we have to turn this into an asynchronous component let's import out from lib out so not outclient out directly API.get session and inside of the session here we have to pass the headers so this can be await headers from next headers and execute them it's a function make sure you don't have use client here in the page and then if there is no session redirect using next navigation to /signin there we go so now you don't really have to worry about this because never will a user see the home view client component even being rendered if they don't have a session so yes this is technically correct way of doing it now because in here we are going to detect that there is no session sooner than we detected that there is no session here because this is a fetch request whereas this is an actual deconstruction of the header parameters so if I try manually going to logos 3000 now you can see that I am redirected back i cannot see the homepage anymore but if I click on GitHub for example let's wait let's wait there we go logged in as Antonio so now I can visit the homepage what I want to do now is I want to do the reverse of this so I'm going to go ahead and just copy this pattern and I'm going to go inside of source app out signin page.tsx dsx and I'm going to add this here and turn this into an asynchronous method and I'm going to import out from lib out and I'm going to import headers from next headers and I'm going to import redirect from next navigation and in here I will do the opposite logic if the session already exists so what I can do is turn it into a boolean by adding double exclamation points this will redirect the user back to the root page or to the homepage right so now I will just indent this properly i will copy this again i will go instead of sign up here and I will do the same thing here async out lib out headers whoops next headers and redirect there we go like this so now if you are logged in like I am you should not be able to visit slashsign in for example you can see I'm immediately redirected back to my homepage but if I sign out uh oh yes I didn't properly do this so uh this will not actively look for my session so that's why this did not redirect after I signed out but thankfully that's why our sign out offers us uh a on success fetch options which is an object on success and then in here we can do router which we have to add con router use router from next navigation and let me just open this so you can see better how it looks like so fetch options router.push sign in like this so let's try this again so I can now visit sign up and visit sign in but I cannot visit the homepage i immediately get redirected back here but if I log in I should get redirected back to the homepage when I am logged in I cannot visit sign in and I cannot visit sign up both of them are protected but if I sign out I should now get redirected there we go so that's how we're going to use this onsuccess method here perfect uh so you probably have a question here um can we somehow reuse this can we somehow put this maybe in a layout and then this way we can protect the entire AL route group i please do not do that um it is much much safer to explicitly protect routes rather than use the middleware or try and find a way to protect multiple things at once it's always better to have explicit protection there's been a number of issues in the middleware in the layout uh and those were security issues so basically people were able to bypass middlewarees and bypass the layout protection but the thing is uh you you never should have relied on things like that so using out in the middleware or in the layout is not inherently wrong if you want to improve user experience if you want to show them hey you're not logged in so it's not wrong to do that but that shouldn't be your last line of defense right you should always have another explicit redirect in the actual page you're doing in our case we don't even need these redirects because we're going to be implementing TRPC in this tutorial and we're going to have protected procedures so our entire backend and API will be strictly protected the only reason I'm even doing this redirects are for good user experience right so if you're asking can I use the middleware can I use the layouts you probably can there's probably documentation but I would not suggest doing that because people then uh completely avoid doing any kind of actual authentication protection so I will be teaching direct explicit uh authentication like this in pages great so now that we have that ready what I just want to do is add the icons here and also you know just for I want to check if my actual uh normal registration is working so let's try Johndemo.com password i want to see if these things are working or not let's see so looks like I was uh registered but it did not redirect me only once I refresh did it redirect me that's interesting okay so looks like that in my This is why it's always good to test so go inside of your sign up view here and to fix that you should go inside of uh sign up by email here you can leave the callback URL to be this but looks like we are going to need the router which we removed so const router use router from next navigation let's go ahead and add it here and simply on success after set is pending router.push to the root page like this and you don't need to add it for the social login because that seems to be working correctly perfect so that will now work go inside of sign in and you have to do the same thing next navigation go ahead and add the router here oops and in the normal onsubmit here do router push and go here like this so I think that now this should be working so if I sign out here and if I go into johndemo.com and password and sign in I should get redirected and I am perfect if I go inside of sign up here and try a new one and sign in I should get redirected as well there we go looks like everything is working nicely github will use the call back and my social and my credential will use the router push this seems to be working just fine perfect all that's left to do is to add the icons and we can close this chapter so go ahead and do npm install react icons d- legacy here deps the reason I'm adding these icons is simply because they have Google and GitHub icons if you're wondering about the version of this package it is 5.5.0 let's go inside of the signin view and let's import FA GitHub and FA Google from React icons copy this immediately inside of the sign up view go back inside of the signin view find your GitHub button and add FA GitHub here and replace the Google text with FA Google and then do the same thing let's just see what the error is about oops slash FA that's the full import same thing here /ash FA go ahead and find the Google here or GitHub fa GitHub and FA Google here and there we go now we have nice icons and everything is working social login redirects outs routes are protected everything is working just fine amazing amazing job so we learned how to protect non-out pages and now let's go ahead and merge this pull request so what I'm going to do is the following i have nine unsaved changes here i mean uncommitted changes so I'm going to do is I'm going to click on my branch here i will click create new branch and I will call this 05 uh authentication socials and I will just confirm that that's the name here it is i will add all of my changes just confirm you are on the new branch i will add all changes so now they become staged changes and I will add 05 authentication socials and I will click commit and publish branch now we can go to GitHub right here and we can open this pull request let's create the pull request here and let's wait for our AI reviewer to review our code and here we have our code summary so new features we added social login options via Google and GitHub on sign in and sign up pages we have introduced a new home view displaying user information and sign out functionality we improved authentication flow with serverside detection and automatic redirects for authent authenticated users we have updated UI to use icons to use icon buttons for social login options so in here of course we have a more detailed walk through and we also have a very big sequence diagram explaining how our new session detection works how our social login works so you can pause and take a look at this if you are interested or need further explanation about that now in here we have some usual comments uh code rabbit uh well very intelligently suggests that we should add a runtime validation for required environment variables so if you want to yeah you can go ahead and you know implement this kind of get environment variable function which will check if it doesn't exist and then throw an error on time um but I I'm pretty confident in doing it this way um I don't think there's anything we need to change here at least not for you know development here uh in here I'm not exactly sure that we use invalid fetch options on success um maybe this was in the previous versions of better out but in the newer versions of better out I'm pretty sure that sign out here offers fetch options on success so we are definitely doing a proper redirect here so that's fine uh so I will resolve this conversation now in here it is telling us that on social success handle should redirect and this is a completely valid uh you know thing to to comment on i'm pretty sure a human reviewer would notice that that's missing here as well that's because we noticed that when using social it is smarter to rely on the call back URL rather than the router push in the on success because the on success with the social sign in is you have successfully sent a Oout request but you you were not actually authenticated just yet that's why it's better to use callback URL so this is also fine I will resolve this and in here uh I don't think it has the new API headers are now asynchronous this was a recent change in nextJS so that is okay as Well but still uh very very smart suggestions it's good to have a sanity check on our changes here so I will just resolve everything there we go let's go ahead and merge this confirm merge and then let's go back here let's go inside of main again you can use main or you can use origin main it won't matter because you will click on this little button here and you will push and pull commits from origin main and this way if you go ahead and look at your graph you will see that you have just merged 05 authentication socials into your main branch here and of course you can check it yourself for example go inside of app page and in here we have the redirect which we just developed in that branch amazing amazing job that marks the end of this chapter and see you in the next one in this chapter we're going to go () ahead and develop the dashboard sidebar this will include creating the layout module the actual sidebar component modifying the global CSS to obtain our theme and then using those new themes to fix the gradient colors in our authentication views so our sidebar will look something like this a logo at top meetings and agents items here and then an upgrade item here down here we're going to have the currently logged in user and the drop down for the user to log out later this dashboard sidebar will also have the free trial status but it doesn't make sense to develop it now because we don't have any data to work with so let's start with creating the actual dashboard layout so as always just make sure you have your app running npm rundev and let's go ahead and check out how our app currently works so right now go ahead and log in using either a social provider or email and password credentials and you need to be on your dashboard page so basically this page with the big sign out button which tells you logged in as whoever you're logged in with so that is currently displayed on this route right here localhost 3000 just the root page and it's this page right here the home view right so what we have to do now is the following inside of your app folder we are going to create a route group called dashboard and since you've already learned whenever you create a new folder in parenthesis inside of the Nex.js GS app folder that means this is not a part of the URL it is simply a grouping folder and what you can do is you can actually drag and drop your main root page tsx and put it inside of here like this if you're being asked to update the imports you can select yes if you still end up with one unsaved file it's most likely the next types app file you can just go inside and click save and close it and then make sure you close the next folder so you don't accidentally continue developing here the next folder uh restarts and rebuilds every time you do npm rundev so no worries even if you've messed something up you can just delete this folder if you want to and just restart your server and it's going to be rebuilt it's not going to affect the actual production of the app so what we've done now is we moved our page.tsx from the app folder into the dashboard route group so what changes now well absolutely nothing but what we can now do is we can create a layout which is specific for this dashboard route group so we don't have to use this global layout here right because this is the root layout this is something else we don't want to add the sidebar here because I don't want to have my sidebar active at all times i only want it active for sites or routes which belong in the dashboard route group so that's why we did this decision let's go inside of here and let's quickly create a layout inside of here simply pass the children and now let's go ahead and create the interface props children react react node go ahead inside of here and the structure the children and still nothing should change because we don't add any new styles to this layout but you should still test it just to confirm you didn't break anything so what we're going to do now in the layout is the following we're going to go ahead and change this to be a sidebar provider from components UI sidebar so yes we also added the sidebar components when we added chats and UI make sure to double check that you have the sidebar component in your source components UI sidebar if it's missing make sure to revisit chapter one where we actually uh set up Shad and UI and added components great so now we're going to go ahead and do the following we are going to wrap our children inside of a main and give the main a class name of flex flex column height of screen width of screen and background color of muted and then we're going to go ahead and create a dashboard sidebar component this will be created and maintained inside of the modules so let's go ahead and create a dashboard module here let's go ahead and create UI and let's go ahead and create components and inside of here dashboard dash sidebar.tsx like this go ahead and mark this as use client and now let's go ahead and import everything we need from components UI sidebar so the same path as this one sidebar content footer group group content header menu menu button and menu item just like that now let's define our first section of items here so it's going to be an array of items which have an icon video icon a label which will say meetings and an href which will be the actual path / meetings then we're going to have an icon bot icon from Lucid React label of agents and an href of forward slash agents and then let's go ahead and copy this paste it and rename it second section this one will just have one item star icon from Lucid React and the label upgrade and an href forward slashupgrade make sure you have added all of these icons from Lucid React here and now we're going to go ahead and render them so that they display just like this let's go ahead and back inside of the layout and actually I can't really import anything yet i first have to develop at least something so let's export con dashboard sidebar and let's go ahead and return a sidebar component then a sidebar header and give the sidebar header a class name next text sidebar accent dash forground and inside of here a link from next link make sure you don't accidentally import it from Lucid React give this link an href of a forward slash and give it a class name of flex items center gap 2 px2 and padding top of two inside of the link render an image from next forward slash image and give it an href of /lovg basically the same thing that we do in our sign up and sign in views logo SVG in here we used a normal image element because we needed to position it uh and style it a certain way but in here we can use the optimized image component from Nex.js now go ahead and give it a height of 36 and a width of 36 and an al of logo or meet AI whatever you want and let me just see it's not href it's a source okay and now we can already import this in the layout so let's add that so we have one less error and you should already start seeing the development here make sure you're not zoomed in too much as it will probably collapse apps on mobile so make sure you are in the desktop view great so we now have that and let's add a paragraph here meet AI or the name of your app and add a class name here text to Excel and font semibold there we go we have our text here now perfect now let's go below this and add a class name div with a class namex4 and py of two and inside a separator there is a dash uh a sidebar separator component as well like this but um I had some problems with it maybe it's something uh the way I'm using it it always overflow here for some reason so that's why I'm not using it in case you were wondering and let's go ahead and give the text uh the separator a class name opacity 10 and a text of hex color 5D 6B 68 after you've done that go ahead and save and I'm not even sure if you will see this because it's extremely extremely thin and I can barely see it but you know just for your sanity you can add black can you do that text black or maybe let's see um I'm I'm trying to make sure this is actually visible uh let me just see opacity 10 how about I add opacity 100 there we go okay so yeah it's definitely here bring it back to what we've wrote here u the reason I'm doing it like this where it's barely visible is because later we are going to obviously inverse these colors so this is how it's going to be visible obviously on a white background you can barely see it but later when we inverse the colors it will be it will have more sense great so now let's add a sidebar content sidebar group sidebar group content and sidebar menu here inside of here map the first section of our items so get the individual item and go ahead and render sidebar menu item here go ahead and give it a key of item href and inside render a sidebar menu button and inside of here we are going to add a link component uh we already have it great and let's add an href here to be item href and then what we can do is add a span here item label and give this a class name text small font medium and tracking type let me just indent this and now you should see meetings and agents text here and when you click on them they should lead you to 404 because we don't have them yet but if you take a look at your URLs they should be correct so what's missing is to uh render the actual icon here so let's go ahead and do the following um what we can do let me try and do this can I just use this item icon and render it like this i can there we go like that let's just go ahead and style it a bit better so I'm going to give this a class name of size five like this and this should just make it a little bit smaller but you can see it's still kind of uh messed up not exactly behaving as we wanted to uh and what I actually want to do now before we do anything else before we fix this uh is I want to go ahead and actually apply the proper theme for our dashboard here so let's go ahead and go inside of our source app folder globals.css [Music] and what I want you to do is I want you to scroll down and find the root now be careful because they have identical variables for root and for dark we are not modifying dark we are just modifying the root okay so the first one you're going to modify in your root is the primary color now what I like to do is I like to leave comments so I know what I modified and I also add a little explanation of what it is this one is pretty self-explanatory but still primary color for example the color of our buttons so instead of 0.20500 we're going to set it 0.63 the second value will be 0.1699 and the third value 149.21 make sure that you don't add any commas here this is not RGB okay and right now what you will immediately notice is that our buttons have a new color so yes now our button has a new primary color previously it was a black color and now our button is this nice green color matching our app so that's the first thing I want us to change and now make sure you're logged in and seeing the sidebar i want you to find these sidebar elements here and let's modify the sidebar one so I will mark this as sidebar background color so I know what it is and that I've modified it it will be 0.2 the second value will be 0.0283 and the third one 174.92 and you can already see the background color has now changed below that we have sidebar foreground which will be sidebar text color go ahead and change this to be 0.82 0.57 and 182.99 so now the text is more visible towards this dark background we are going to leave the primary and the primary foreground as they are and go to sidebar accent this is sidebar active item background color and go ahead and change this to be 0.34 0.0601 and the last one 171.21 and the last one we're going to modify is the sidebar accent foreground which is basically sidebar active item text color go ahead and modify this to 0.34 0.06 06 uh my apologies no I I I was reading the values from here uh the sidebar active text uh color will be 1 0 0 a very simple one so now that we finally have our colors set what we can do is we can go back inside of the dashboard sidebar and we can modify the sidebar menu button to have some nicer colors here so go ahead and add a class name here and import CN from lib utils this will allow us to dynamically change class names if needed and also avoid any merge conflicts so this is the util that was added with shad CN i think this was one of the first uh functions we looked at once we added chaten and I told you it was going to come in handy later on so CN util is a way you should uh merge your class names right so the way you use it is pretty simple it can accept an infinite amount of parameters so the uh it can be for example text rows 500 and then the second parameter background blue 500 or you can add all of them in one parameter depending on what you need right so here's how I like to use it um I like to reserve the first parameter for my default classes so for example height 10 on hover background linear to right / klch give it a border border transparent on hover border will have a 5B 6B 68 color divide it by 10 we are continuing our and this is a typo it's not linear it's linear make sure that when you hover on your class names you can actually see the tailwind i mean the CSS that means it's a correct variable and again make sure you have the tailwind CSS intellense installed so you can see that let's continue so from sidebar accent which we have now modified right from 5% like this via 30% via sidebar color but let's reduce it for 50% opacity to sidebar color but let's reduce it for 50% opacity as well so now when you hover we have this nice effect as you can see it's brighter here and then it goes dark here so it's a very cool looking effect when we hover on our sidebar items here like that and let's go ahead and also do one important thing so the reason our sidebar menu button looks broken is because we forgot to add as child here once you add that there we go you will see how it becomes a uh properly aligned and it's entirely clickable right you don't have to click directly on the label perfect so that is now added now uh what I also want to do is the following i want to know if a certain route is active for example so the way we can do that is by adding a const path name use path name from next navigation make sure to add this import here and then we can simply compare the path name with the item href so for example I just added this obviously if I were just to add this type of class I wouldn't need the CN util but since now I'm going to add a comma here and add a dynamic one it makes sense so if path name is identical to the item href for this specific item that we are iterating upon we can simply add a different color background linear to write OK L and then a border 5 D 6B 68 / 10 like this and we can try it out for example you can do you can comment this out and then just set consp name to be slash meetings and then you will see that the meetings will kind of be active like this but um I don't want it exactly to be like this oh yes because we are missing one more prop here so let's add is active here path name identical to item href there we go so this is how it will look like when meetings is selected right or if the agents is selected did I write this properly the agents forward slash agents i'm expecting the agents to be selected but looks like um they are not selected for some reason uh let me just pause a bit and debug to see what I'm doing wrong oh well I figured out what I'm doing wrong uh I'm using a path name to be like identical string but it's not identical it's missing a it has an extra space here so that's not the same string yeah there we go now it's working so that was the mistake great we can now remove the hard-coded path name and make it dynamic like this so naturally none of these two will be selected because we are on the root page and if you're wondering where is the root page in the sidebar we are not going to have the root page we are later going to add a rewrite in the nextjs config to always lead us to slash slashmeings as the default page but we don't need that now we are okay with having this kind of root page for now uh great so we have this now what I want to do is I want to add the second section and we can do this quite easily here so what we need is we need to copy the entire sidebar group actually I think um let me just see do we copy the entire yeah let's just copy the entire sidebar group like this and let's paste it below and let's just add second section here so a bit repetitive but there we go now we have an upgrade which is clearly separated here and in between these two groups what we can do is we can copy this And we can add it here and there we go now we have this kind of separator here as well um great so that is now uh semifinished what I also want to do to wrap up the chapter is implement the user button so the currently logged in user right so the way we are going to do that is by going to the end of the sidebar content and adding the sidebar footer let's go ahead and give this a class name of text white and let's go ahead and add a div here with a class name uh actually I don't think we need this we can just do normal user button like this so this is a component which we're going to have to implement now uh and actually we might call it dashboard user button like this so we can go inside of a modules components and create dashboard user button.tsx because it's not exactly going to be reusable anywhere other than the dashboard so in here what we're going to do is we're going to export const dashboard user button return div user button and import dashboard user button here from dot / user button is completely fine because they are in the same folder so now here at the bottom you should have user button in case this nextjs action button is getting in the way you can actually click on it you can click on preferences here and you can change the position for example to be bottom right which will move it here which is okay because we won't really have anything uh here so if you want to you can do that so you can clearly see the user button here now let's go ahead and focus on the dashboard user button and let's go ahead and develop it so what we have to do inside of the dashboard user button is get the data and is pending from out client use session make sure you import this so if is pending or if there is no data user we can just return null like this so for a split second this will not be visible as you can see if you want to you can add a loading indicator here however you prefer but I'm completely okay for a split second this just not existing until it loads i've seen that kind of behavior on a lot of websites so now let's go ahead and do the following we have to import everything from drop-down menu so let's add all of these things drop-own menu content item label separator and the trigger from components UI drop-down menu so I'm going to encapsulate this inside of the drop-down menu here i will add a drop-own menu trigger component here and I will give it a class name rounded large border border dash border with 10% opacity padding three full width flex items center justify between background white with 5% opacity on hover background white with 10% opacity and overflow hidden and inside of here what we are going to do is the following let's just leave the user button now and you will see how it looks like right you can zoom in a little bit but just make sure your sidebar doesn't collapse if it's hard for you to see there we go so now what I want to do is I want to display this user's image so you can search for data user.image and if we have an image you will display an avatar if we don't you can just display null we will actually render something later so for now let's go ahead and leave it like this and add an avatar from components UI avatar and add avatar image from components UI avatar you can move this here as well you also have this installed when you added chats UI and the image will be source data user image like this so since I've logged in with my uh GitHub you can see that I have an image here if you logged in using credentials you will most likely not have an image here so that's completely normal don't worry what I want us to do now is implement a little component which will be useful for us uh to create uh placeholder images it will be useful for two reasons for users who don't have an avatar and second for our agents right our agents will be given some kind of personality with a generated avatar so let's go ahead and go inside of components and create a new f a new file called generated-vatar.tsx so you don't have to put this in the UI folder i like to keep chats and only stuff inside of here instead of the generated avatar here uh we're going to have to install two packages so the first one will be at dicebar-core u my apologies forward slashcore and the second one will be at dice bear so it's dice bear not bar slashcolction make sure to correct the dice bear if you haven't and I'm pretty sure we need to add dash legacy pier depths to avoid any errors i will of course show you the exact versions that have been added to my package JSON here so let's go inside of package JSON and let's go inside of there we go dice pair so 922 922 like this so now we can go back inside of our generated avatar here and we can import Oops create avatar from dice bear core and we are going to import two collections from dice bear collection the first one will be bots neutral and the second one will be initial initials so basically dice bear is an amazing library uh which can you can either use it with their JS API their react API they have a bunch of solutions they even have an HTTP uh rest API right but this one is um this one is cool because it actually generates the SVG without needing an internet connection so it's not going to generate any fetch requests in our network to display these avatars and there's a bunch of collections you can explore you can see there's a ton of them uh the ones I've chosen here have a license which is free for personal and commercial use so those are the initials and bots neutral created by Pablo Stanley so amazing amazing libraries so after you've added this let's go ahead and import CN from lib utils and let's import avatar avatar fallback and avatar image from add /components UI avatar and in here create an interface generated avatar props seed will be a string class name will be an optional string and the variant will either be uh well you can just copy bots neutral or initials like this and then export con generated avatar here go ahead and dstructure the props here so that will be seed class name and variant just like that and then define the avatar here so let avatar if variant is equal to bots neutral avatar will become create avatar bots neutral and simply pass in the seed else avatar will be create avatar initials pass in the seed pass in the font weight and pass in font size like this now that you have the avatar what you can do is you can return avatar avatar image and avatar fallback here give the image a source of avatar to data uri and an out of avatar and for the fallback we can just use seed dot character at first one to uppercase and give the avatar a class name of CN and pass in the class name inside so we can modify it from the outside so now we have a component we can use whenever we need a generated avatar so let's go back to our dashboard user button here and what the alternative here will be instead of null is the generated avatar component and pass in the seed to be data username and the variant will be initials and class name will be size 9 and mr of three initials like this so now nothing really changes for me but if I for example sign out and if I go ahead and create a new user for example uh so mark markdemo.com and sign in so this one does not have uh you can see any image we use the generated avatar with their initials here so that's how this will be used or you can change it to boss neutral and then it will create a little bot right but that makes more sense to use for the actual agents right great so that's one thing that I wanted for the trigger uh but still let's go still inside of the drop-down trigger here and create a div with a class name flex flex column gap app.5 text left overflow hidden flex one and a minimum width of zero inside we're going to have data username and we're going to have data user email rendered here so give the first one a class name of text small truncate and w with full and the bottom one a class name of text extra small truncate and with full and there we go now you have your name and your email right here outside of the trigger we're going to have a drop-own menu content here this will have an align of end side of right and class name of width 72 and inside of here drop-down menu label with a div class name flex flex column and gap of one and then inside of here you're going to have two span elements the first one will be data do user.name name with a class name font medium and truncate and the bottom one will be data user email again with the class name text small font normal text muted foreground and truncate so now when you click here you can see how it will open additional options here in form of a dropdown great uh and one thing I forgot to do here in the drop-down menu trigger before you close it just go ahead and add a chevron down icon from Lucid React give it a class name size four and shrink zero make sure you've added the Lucid icon import there we go so now it has a drop-own button perfect so now let's go ahead and continue developing uh the drop-own menu content here so after we finish with our label add a drop-own menu separator a self-closing tag and then a drop-own menu item in here add billing and credit card icon from Lucid React copy this and this one will be log out icon with the text log out give both of these icons class names and size four like this and you can give both of this drop-own menu items class names cursor pointer flex items center and justify between there we go so this is how the buttons are looking and we can't really develop the billing one but we can develop the on logout one so above the return here add const on logout asynchronous method await out client sign out fetch options on success and we also have to add the router here from use router next navigation like this and let's do router push forward slash sign in and we this actually does not have to be asynchronous we don't have to wait it at all let's use on log out and let's add it to the on click here there we go so now we have a user button which you can see takes some time to load once it loads we can click log out and we are logged out perfect so what I want to do now is I want to wrap it up by fixing the gradient colors here because we have added the layout the modules the sidebar and we modified the globals theme and now let's use these new variables to fix the gradient colors in the ALF views so this part right here so go inside of this sign in view in your modules al UI views and find the second column where you render the normal image tag with logo SVG where you have the background uh radial and instead of using these colors we're going to add our new variable colors so from sidebar accent to sidebar there we go so now it matches our sidebar uh technically you know we are using the sidebar color variable for something that's not a sidebar but they think it's okay to borrow it for you know just one or two more places right let's go ahead and copy this and do the same thing in the sign up view so that they look the same there we go so now both our sign up and our signin forms look very nice great so I'm going to go ahead and uh wrap up the chapter now because we just fixed this there we go and now let's create review and merge our pull request so what I'm going to do is close everything open my source graph here you can see we have a lot of changes here let's click on the branch down here let's click create new branch and let's call this 06 or is it 05 i'm not sure 06 dashboard sidebar let's add all changes so they are staged and let's do uh 06 dashboard sidebar make sure you are in your new branch here click commit and publish branch there we go now let's go to GitHub let's open a pull request and let's wait for our reviewer to finish looking at our code and here we have our code summary so new features we introduced a dashboard layout with a sidebar navigation and main content area we have added a sidebar component featuring navigation links section grouping and active route highlighting we've implemented the user profile button in the sidebar with drop-own menu for options for billing and logout as well as the aer generator component so in here we have a file by file walk through and a deeper uh review of what we've done two sequence diagrams the first one explaining how our dashboard uh layout actually works and the second one is our dashboard user button which handles the sign out functionality we have some actionable comments the first one is to add an on error in case sign out fails this is definitely something we can do and we will come back to this when we add the actual toaster component for displaying errors right so very good suggestion here in here obviously they suggest reusing some of the styles because we have two identical uh section groups you know first section and second section inside inside of our dashboard sidebar but since we know it's only going to be used for two things I'm okay with reusing it if it turns out that we will add more sections in the future it will probably be a good idea to separate it like they suggested here in here it advises against using hardcoded colors like this which is a completely valid claim so we can consider adding this to our uh global CSS we'll see if we can find at least one more place to use it perhaps but uh for this one of cases I'm okay with hard coding it uh anyways great great suggestions here you can of course decide for yourself you know your your project does not have to be identical to mine if you want to handle some things that AI suggests feel free to do so so I'm going to go ahead and merge this pull request and once I've done that I'm going back inside of my IDE here and I'm clicking down here and going back to my main branch make sure this says main or whatever is the name of your default branch and click on synchronize changes and click okay and this should automatically synchronize everything here so you can check by going inside of the app there we go layout dashboard sidebar everything is here amazing so that wraps up this chapter amazing job and see you in the next one in this chapter we're going to go ahead and develop the dashboard navbar () which should together with the dashboard sidebar wrap up the dashboard layout so in the previous chapter we have developed this part right here and now we're going to focus on this so two things will happen in the navbar first we're going to have the collapse button so that we can collapse the sidebar if needed and the second one will while it looks like an input it's actually going to be a button which is going to open a command model so that we will be able to search for any agent or any meeting using a global search and we will also have a little shortcut to open it so let's start by creating the dashboard navbar as always make sure you have your app running and let's go ahead and do the following let's go inside of source app dashboard layout and before you write anything double check you are on your main branch here and now inside of main uh inside of the main element I'm going to add dashboard navbar component now let's go inside of the modules dashboard components and now inside add dashboard navbar.tsx like this so let's go ahead and mark this as use client and let's export const dashboard navbar instead of a div let's return a nav element here and say hello navbar let's go back to the layout and let's import the dashboard navbar from modules and now when you go here when you refresh above this page you should see hello navbar right here so now we're going to continue developing that i'm going to give this nav element a class name flex px of 4 gap x of 2 items center py3 border bottom and bg of background there we go so already looks much better and I just can't help but notice that we are missing a little gap here in the user button between the avatar and the info so let's quickly go inside of dashboard user button here and let's find that so in here we have drop-down menu trigger here and looks like we are missing the gap here so let's just add gap x2 and there we go that keeps it separated like that so let's continue going back inside of the D uh nav dashboard navbar here and let's add a nate uh a button component from components UI button and in here I'm going to render a panel left icon from Lucid React and I'm going to give this a class name of size 9 and a variant of outline like this so now I have this button here right now when I click on it it doesn't do much but what I can do since I've wrapped my entire dashboard inside of a sidebar provider I can now access use sidebar in any of its children from components UI sidebar and in here I can get the current state of the sidebar i can get to toggle it and I can also extract is mobile so what I'm going to do is the following i'm going to add on click here to be toggle sidebar so now when a user clicks it opens and closes and now what I'm going to do is dynamically render this so let's just encapsulate this and let's check in parenthesis if state is collapsed or if is mobile which means it's automatically collapsed we are rendering the panel left icon otherwise render panel left close icon from lucid react now let me just collapse these so they are easier to look at and now let's go ahead and just add a little class name here size four inside so now you can see that we have actual different icons representing different actions right but if you enter mobile you will see how it will behave exactly the same perfect so now that we've uh established that let's go ahead and handle the button next to it which is the search button so in here I'm going to give this button a variant of outline a size of small and on click for now just an empty arrow function and in here I'm going to add a class name height 9 width of 240 pixels justify start font normal text muted foreground hover text muted foreground basically I'm doing this to override uh the usual effect where the color of the text changes on hover that's why I'm writing the same color on hover and uh that will be it and inside of here I'm going to add a search icon from Lucid React and you can already see how this looks like so it's very clearly a button we're just going to mask it as an input there we go like this and what I want to do here is add a KBD element which will basically just be uh a shortcut representation because besides clicking on this button you will also be able to do a keyboard shortcut to open the global search so inside of here add a span element and go ahead and write the following and hashtag 8984 and then a column like this and this will render a command icon right so obviously depending on uh Windows or Mac this will be the control icon uh but it's basically the meta key right you can of course change it if you want to detect users operating system and then display control but most people understand what this means so now let's go ahead and style this just a bit better so first of all I want to give this span a class name of text extra small and I'm going to give this one a class name ML auto so that will push it to the end here pointer events none inline flex height five select none items center gap one rounded border border uh my apologies background muted px 1.5 font mono text 10 pixels font medium text muted foreground and opacity um no actually we don't have to do anything with the opacity there we go so now you can see that this looks like an actual keyboard uh shortcut it's very recognizable right perfect uh what I want to do before we move forward is one thing just check one thing so if you go inside of source app layout you can see that we are currently using the Ge uh font how about we change this to instead use enter and let's go ahead and call this enter and simply set the enter font we don't need the variable so you can just add enter like this and you can just add inter dot class name here like that so this should change the font of the app to be inter which I think suits better in this case now we can go back inside of the dashboard navbar here and what I want to do now is I want to uh simply create that command even though it's not going to do much because we don't have anything in the database to search for and we don't have any API created but let's just prepare for it right so wrap the entire thing inside of a fragment here because semantically uh it will not be inside of the navbar it will be here so dashboard command that's the component we're going to create and go inside of here and create dashboard command dsx so all of them live here together let's export the dashboard command here and inside of here what you're going to do is you will return command dialogue from components UI command and then inside of here add the command input from components UI command and now what we have to do is we have to create the props for this so let's create an interface props open boolean set open dispatch from react set state action from react and then boolean inside now let's go ahead and modify this and let's destructure open and set open here let's pass in the open and on open change set open like this and besides the let's actually add some attributes so the command input placeholder will be find a meeting or agent like this and below this let's add a command list from components UI command and then let's add command item from components UI command and in here I will simply write test and I will give this uh I'm not sure it needs uh anything we can just do test like this and let's leave it like this so now let's go inside of the dashboard navbar and let's import this from dot / dashboard command like that and what we have to do now is we have to implement the use state control for this so command open set command open use state from react and set it to false by default and let's just move this up here and let's go ahead and add this to be open command open and set open to be set command open and now let's go ahead and use the button for search to be set command open and let's simply toggle so the current value and just the reverse of the current value so now when you click this you can see that it opens up right and you can see how it uses this filtering search it doesn't work properly yet because we don't have an actual API to call and search for meetings or agents right but that's how our global search will work and one thing we have to do is just implement the shortcut here so the way we can do that is by using a use effect let's add a use effect here from React make sure you have imported this uh you don't have to put anything in the dependency array define a function called down which will accept a keyboard event if event key is equal a and if we are pressing a meta key or we are pressing the control key so compatible both on Windows and Unix systems we will prevent default and simply toggle the current command status and then let's add a document add event listener key down to call the function down and important on unmount we need to remove that event listener on key down and pass the reference to the function so now when you press command and letter K it should open let's see did I implement this correctly I had to refresh there we go so without clicking I can now open and close it perfect so we just added the dashboard navbar and now let's wrap it up by adding a responsive drawer to dashboard user button so basically right now if you go into mobile mode and open this and click here you can see that it's not exactly usable right you can't really use mobile like this so what we're going to do uh is we're going to implement a drawer we already have that inside of our components so what we can do is go back to our dashboard user button the reason I'm doing this is so that we start getting familiar with uh our way of adding responsivity here so what we need to do is we have to import all components from drawer the same way we added all components from drop-down so from components UI drawer which is a chat UI component so source components UI drawer right here drawer content description footer header title and trigger and it works very very similarly uh they pretty much share the same base same platform so what we're going to do is the following we're going to get const is mobile using use is a mobile which we also have if you're wondering where did this come from well also chatnui one of the components needs it uh in case you are using you know some different version and you don't have it you can pause the screen and just write the hook yourself it is pretty simple it's not really that complicated uh but there is probably Oh maybe it doesn't use it oh use is mobile there we go the sidebar component uses it right so that's why we have it in our project in case you were wondering so now we're going to use it in the dashboard user button and what we're going to do is the following after this we're going to do if is mobile we're going to do an early return and similarly to this we will open a drawer here and then a drawer trigger which will have an as child option and in here what we can do actually I think we can just copy this thing like that and then literally just copy what's inside of this drop-own menu trigger so all the way to here and add it here this will ensure that the trigger button looks the same on mobile but that's just the trigger because now what we have to do is we have to add drawer content and in here a drawer header and a drawer title with data user name and in here data user email this will be drawer description and make sure to change the closing tag as well outside of the drawer header open up the drawer footer and in here we are simply going to add the two buttons so let's add a button from components UI button variant of outline on click empty function because this is the credit card icon and billing option give it a class name of size four and text black go ahead and copy and paste this and change this one to be our on log out method log out icon and log out just like that so now when you go ahead and click on mobile you will see that you have a much much nicer experience you have a proper drawer when switching to desktop it will open in a normal uh drop-down menu so that's how we're going to handle responsivity in this project and the buttons should work normally let's see log out there we go perfect responsivity great amazing amazing job i think uh that wraps it up so we added the responsivity and now let's go ahead and just merge the pull request here so uh I have opened this i have some changes i'm going to go inside of here clicking on my branch creating a new branch 07 uh this is dashboard navbar I believe correct ensure that you can see the new branch here go ahead and click the plus to add to stage all changes 07 dashboard navbar commit and publish the branch there we go now let's go ahead and open the pull request on GitHub and let's see the review from Code Rabbit then here we have the summary we introduced the navigation bar to the dashboard layout for improved navigation we added a command palent interface for the dashboard for quick searching or selecting items we updated the user menu to provide a mobile friendly drawer experience improving the usability on mobile devices and we simplified and updated the apps font to use inter for a cleaner appearance that's exactly what we did this was a pretty uh short chapter in here we have a sequence diagram if you uh need further or visual explanation of how our uh drawer works for example detecting the mobile or detecting the desktop as well as the dashboard command visualization here perfect and may I say no big comments some nitpick comments here as you can see uh but no large comments that need any action great so let's go ahead and merge this pull request and once the pull request is merged let's go back here select the branch name go back to main or origin main and go ahead and click this to synchronize the changes and click okay and then when you click on your source control here and go inside of the graph you will see that we just merged 07 dashboard navbar amazing amazing job let's mark this as completed and see you in the next () chapter in this chapter we're going to go ahead and set up TRPC in our project after we've done that we are going to experiment using it with a client component with a server component and then we are going to preview prefetching and how it works and how we are going to use it moving on so first things first ensure that you're on your uh default branch here ensure that you have synchronized all changes you shouldn't have any numbers in the source control here everything should be up to date and then you can also shut down your app simply because in the beginning all we're going to do is install a bunch of packages so head to trpc.io io or use the link in the description and let me show you how you can find the documentation that will tell us what we need to do in nextJS so you can click on the quick start which will take you to the documentation and in here uh you will have some uh options like backend usage and client usage and in here you will notice that you have nextjs integration that's because they still support explaining how to set it up with the pages router this is not what we are looking for what we need is one of these either the tanstack react query or React Query so I previously used this type of integration but nowadays they have this complete new rewrite of how you use Tstack Query with TRPC and honestly it makes so much more sense and it's actually simpler to use and it's the recommended way of going forward so this is what you have to find go inside of DRPC documentation client usage 10 stack react query and not in the setup if you want to you can go in the setup and you know uh but you can see that you're missing some things like the server router like where does this come from so that's why I recommend that you go inside of server components first and in here you will read how to set up the RPC with tanstack react query using their new integration using server components which basically can be translated to Nex.js app router so basically they are doing a separation of server components and client components that's why uh while the documentation might be a little bit confusing in here you can find everything you need for the Nex.js integration so let's go ahead and start with installing the dependencies so I'm just going to copy this entire thing here and paste it but I will also show you uh the versions that I am using so my DRPC server here is 11.1.2 my TRPC client very importantly will match that version and my TRPC 10stack react query will also match that version now for tenstack react query not TRPC tanstack react query actual tanstack react query they use latest but I will prefer using the exact version just for this tutorial's sake right obviously if you were developing this on your own it's completely fine to use the latest versions but for this tutorial I want to ensure longevity and the zod version will be 3.25.7 25.7 client only and server only uh it doesn't really matter these versions don't change too much and I don't think anything will be breaking here but of course I will show you which versions I got installed so why am I adding versions for these things and why am I adding versions for Zod right so the reason I'm adding versions for all of these is because you can see that if one of them is 11.1.2 2 the others need to be that version as well the other reason is you can see for example tanstack react query has a warning the package is currently in beta as we stabilize stabilize the API we might do breaking changes without respecting simber so what does this sentence mean it means that usually you would expect the breaking change in a major version change but since they are in beta the breaking change might come in 11.1.3 right that's why I'm telling you that for this tutorial it might be safer and it might save you some headaches to simply use the same versions that I'm using and I'm also pinning the tanstack react query version simply because I know that this version is compatible with this and why do I pin zod version well that's because Zod is also in some kind of transitioning phase where they are introducing version 4 so depending on when you watch this video version 4 might become you know the default to use but this is the current highest version that I have been able to found and we'll see uh how compatible it is with these other ones but this is the reason why I'm doing that because there's a lot of moving versions here a lot of beta things a lot of breaking changes and I just want to make it easier for you to follow along and go ahead and add d-leacy fear deps and wait for a second for this to install there we go so no need to start anything immediately we can just go back here and let's create the TRPC router so we're going to go inside of source create a new folder trpc and inside let's create init.ts and go ahead and click on this view sample back end now just a small note in case this documentation changes and you can no longer find these code snippets don't worry uh so this is how I'm going to do it i'm going to copy it i'm going to paste it here and I'm just going to you know slowly scroll so that you can see exactly what's inside it's not a very big code snippet in case the documentation no longer shows it you will have no problem writing it yourself there we go so just add this in the init file now what we have to do is we have to create our uh app router which will handle all of our procedures and different routers right so we are doing that inside of TRPC routers_app.ts so inside of the TRRPC folder go ahead and create routers and inside create_app.ts and paste this inside there we go and you can see that it can find dot.init which is this file right here perfect after you have added that let's go ahead and let's add to our app folder API TRPC dynamic TRPC route.ts so we can copy this and we will have to modify this snippet a bit because you can see they're using a different type of alias here so let's go inside of app folder API let's create the TRPC folder then let's go ahead and create another folder TRPC inside of square brackets and finally route TS so app API TRPC TRPC in square brackets route TS and paste this here and we are now going to modify these two to not use this squiggly line but instead the at sign because that is our uh default alias so this leads the import to source folder and then we can access the RPC from there there we go so I think that's all we need for the setup so let's leave it like this for now often when I go through this documentation I forgot to do something so I'm trying to be as careful as possible that that does not happen so in order to use the RPC both in client and in server components we will need to have client factories and server factories to handle that right so let's go ahead and create a queryclient factory so I'm going to copy this and create query-client.ts so let's close this let's go inside of TRPC and query-client.ts and let's paste it here and I will now slowly go over this so in here we have the import in here we have the super JSON import which we can comment out because A we don't have the package installed and B we are not using it yet and after that we simply export a function make query client this is basically the tanstack query setup that's it we will later enable the serialization and I just want to finish following through with the setup great so that's the query client uh and now let's go ahead and see what else we have and if you want to read more about it you can pause the screen or go to the documentation here now let's go ahead and create a TRPC client for client components so I'm going to copy this and I'm going to create inside of the DRPC folder client.tsx like this let me close everything else client.tsx and let's paste that inside of here so in here we mark it as use client we do all of these imports right here and then we add our makequery client from this which we've just added previously right make query client and we import the app router type from our routers here because this is where we are going to add all of our different routers so in here it will have the app router to give the context and the type interference for all of them so I'm just going over this slowly in case you cannot find that code snippet and want to type it yourself so in here we define the function get query client which I suppose it's doing it uh so it's compatible during server side rendering here even though this is a client uh a a even though this is a provider for the client component usage uh it we still have to handle server side rendering that's different from a server component so that's it's doing this and after that we have this get URL which I uh definitely want to modify I think is a bit unnecessarily complicated and it's optimized for Versel but what if you're not deploying on Versel right so how about we do this so find get URL method or if you're in the middle of typing it go ahead and stop here and instead let's go to our environment here and let's add next public app URL and in here we're basically just going we can copy the better out URL because it's exactly the same it's basically where we have our app running if you are unsure you can do npm rundev and you will see exactly where it's running like this and just add it here be mindful of the protocol and of the port so this will be much easier to do because you can see that versel URL does not include the protocol so then they have to attach it to the protocol it's just a mess to work with instead what we can just do is remove these two lines and just do return process.vironment environment next public app URL please copy and paste so you don't accidentally misspell that's it and what's important here is that you have actually defined the TRPC folder in the / API/TRPC so be mindful of that api TRPC make sure you didn't misspell it and finally we have the TRPC React provider which combines the query client with the TRPC we are later going to enable the superjson transformer and finally it adds all the necessary providers using the tenstack query and the TRPC and now we can wrap our application into that great so I hope that kind of explained it i will once again go through this slowly in case you are typing it out line by line so now let's go ahead and let's mount the provider in the root of our application so I'm going to go inside of layout right here so this root layout in the app folder and I'm going to go ahead and import gRPC react provider so be mindful here not to import the wrong thing prpc I already forgot what it's called react provider from at TRPC client the reason I I'm telling you to be mindful is because autocomplete intellisense might pull you and you might import uh a a similarly named provider which is not what we want so now let's go ahead and simply wrap our entire app into that like that and there we go now we can safely use the RPC and tenstack query throughout our application now we have to create an equivalent caller for server components because this is useless in server components but it will be quite handy for us to access our TRPC router in a server component so again I'm going to copy this and create trpc server.tsx so let's go inside of here server.tsx like this and let's paste it here so now what we're going to do is first ensure that you have server only and I just remember that I forgot to show you so client only 0.0.1 server only 0.0.1 those are my versions great and in here you should have no problems with this relative imports because it's all in the same folder so we have the init we have the query client and we have the routers app and you can remove this part so this is if the router is on a separate server that's not the case for us so we can remove that and this is the cool thing so usually uh if you were attempt to you know fetch your data in a server component uh using some kind of abstraction like hono RPC what it would do is it would actually do a fetch request on your server which is unnecessary overhead but that isn't the biggest issue that's not it's not slowing anything down too much the issue is if you're doing a fetch request in a server component you're losing authentication there you need to fill that fetch request with cookies and headers well this kind of server module for TRPC will allow us to natively call TRPC procedures in server components preserving the AL state that's why this is so good so there is no uh fetch request happening here it will directly call the TRPC procedures you will see more of this in action later on uh great so in here they immediately show you the prefetching example which I think is a bit complicated if you've never seen this before but basically pre-fetching allows us to combine the best of both worlds we are the when next.js GS page loads the first thing it loads is a server component and in here we have the option to prefetch a query for example you we just loaded a meeting with meeting ID 1 2 3 so what we're going to do in the server component is we're going to start the prefetch we're going to say okay start prefetching this immediately and then we're going to wrap this into the hydration boundary and then in the client component we're going to use the client DRPC integration and in here we will be able to load a already loaded data right because the server component will already put the data into cache so our client component will be ready to immediately use it right and we are also going to be able to use use suspense query with that and then we are going to have an even better developer experience for us i know it's all a bit too much overwhelming at the moment but uh you're going to see when we start doing this how helpful it really is but uh how about we go ahead and actually try a very simple example so what I'm trying to do here is the following let's go in inside of our TRPC routers and in here we can see hello base procedure so a pretty simple procedure how about we go inside of our modules home home view because this is a client component make sure you have your app running here and this is what we're going to do now so we no longer need to display anything else related we have that in the sidebar now but what we can do is the following we can learn how to use TRPC here so let's first add TRPC hook so const TRPC is use TRPC from TRPC client and then in here we would have the data which would be use query from tan stack query and then in here usually what you would do is you would create your fetcher and then pass the body what they have done is they have separated the API from tRPC and use query so you use query and you learn use query independently right you are not learning tRPC you are learning tanstack query that's the cool thing about this new integration they've done usually what you would do is tRC dot uh your procedure dot use query but that would require you to learn this whole new syntax whereas with this one all you already know use query most likely right so all you have to do is pass hello and query options inside and let's pass in is it name let's just see hello text okay let's pass in text to be Antonio and then in here simply render data greeting with a question mark here so now when you go to localhost 3000 and refresh this this should no longer exist and instead it should say hello Antonio there we go hello Antonio so it loaded for a second and then it said hello Antonio so that's how you would use it in a client component quite normal nothing too unusual right but we can also use it in a server component if we need to so let's just do that before we wrap up the chapter so getting data in a server component you would almost never you will almost never need this right but if you really really need data in a server component you can right so what we're going to do is let's just go inside of app folder dashboard page and what I'm going to do here is I'm going to fetch the greeting the same way so con greeting will be awake Wait and let's see what do we need to import a caller function and I'm not even sure if I have it yes they are telling me that I need to export it because we will never use this but just to demonstrate to you that you can still do it let's go inside of TRPC uh server if it's easy enough to do we will do it if it's complicated we will just skip let's see okay all I need is the caller expert con color caller app router create color and pass in this perfect let's import the caller from TRPC server so caller hello text Antonio server and then in here we're just going to return a paragraph greeting greeting so this would technically be data and then data greeting so now I'm overwriting that client component and you can see hello and new server so I just wanted to demonstrate to you that it's possible to do this as well but we won't be doing that we'll be doing the third option which is the pre-fetching leveraging both the speed of server components and the knowledge and the um uh I'm not sure what's the correct term to use a familiarity of the client components right because we're use used to this we know how to work with this right but it would be nice to leverage the speed of the server components which load sooner than the client components so you're going to see us combine all of that in one uh great but we just tested both so we know that both the client and the server iteration of these are working and we're going to learn more about the RPC as we go forward so we've done this this and this and I forgot to do one more step which is to uh merge the pull request so let's go ahead and do that so I have 11 uh uncommitted changes here let's go ahead and change the branch first new branch this will be 08 DRPC setup great let's confirm I'm on the new branch and let's click the plus icon to stage all of our changes here and let's do 08 PRPC setup and let's commit and let's publish the branch there we go and let's go ahead and open a pull request to see what Code Rabbit has to say about this though I won't change it much simply because this is the official documentation so I'm just going to follow how they've done it but still let's see what AI has to say about this and here we have the summary so let's read through the walkthrough this time this update integrates DRPC and React Query into the project introducing new API routes server and client utilities and a context provider for the app authentication logic is removed from the home view because we removed it right and which now displays data fetched via TRPC several supporting modules and dependencies are added or updated to enable seamless type- safe API calls and that was pretty much the point of this chapter and this is where you will finally see these sequence diagrams become increasingly more useful especially if you're struggling to understand uh all of these types of uh uh TRPC calls right server TRPC client TRPC uh hybrid with pre-fetching so this will come in quite handy in here for example you can see a very very simple one which is a usepc with use query for the hello procedure where we pass the text and we bring back from the app router the greeting with that text included and then render it back in here we have some comments but these are just demonstrations right we will obviously remove this so it's making sure that we are careful with this query that we have the error and loading field but we are going to remove it anyway and we will handle error and loading but in a different way using suspense we are also going to implement proper protected procedures later on you can see how it already suggested that right here perfect and in here of course it recommends a fallback but um we don't really need a fallback you know if you don't add this environment variable the app will not work either way because we will use it for some other things later on and finally the caller here which again does not matter uh because we only added it to demonstrate how you can use TRPC for purely server component call but still you can see how uh for seemingly harmless pull request it noticed so many things that could go wrong right luckily for us most of this is just for demonstration but definitely a useful tool to have let's go ahead and merge this pull request and after it's merged go back to your IDE select the main branch and go ahead and synchronize the changes to double check you can click on the source control here open the graph and just confirm that you have emerged the TRPC setup perfect amazing amazing job and see you in the next () chapter in this chapter we're going to go ahead and set up the agents entity in our project this will include adding the agents schema module TRPC procedures some client pages and we're going to create reusable loading and error states let's start with the agent schema first things first ensure that you're on your main branch here and feel free to synchronize changes if you haven't and make sure you have no active numbers here meaning everything was merged everything is up to date so what I want to do now is run mpm install nano ID legacy peer deps great now let's go ahead and run our app now let's go inside of source database schema inside of here we have all the tables added by better out so what we are going to do now is import nano id from nano id and we are going to create our table so let's go ahead and export const agents pg table agents the ID is going to be a type of text with the column name ID it will be a primary key and we are going to add a default function here to assign a nano ID the reason I'm using Nano ID is because they are shorter and much more readable than UYU IDs let's go ahead and set the name field to use the name column name and it's going to be required user ID is going to be a text field user ID will be the column name it will be required and it's going to be a reference to our existing user table specifically targeting the ID field so we are referring to this user table right here this ID field and we are going to add a rule if the user is deleted we are going to cascade meaning deleting this agent as well let's add instructions to be a type of text with a column name instructions and let's just make it required and we are then going to have created at which will be a type of timestamp created at required and default now copy and paste this and change it to updated ad and change this to updated ad as well there we go we have our new agents table so everything above here is better out and everything starting from the agents will be our tables great now that we have our new agent schema let's go ahead and let's run database push so npm run database push and there we go changes applied so now you have two options you can either go on neon and look at the table or you can run database studio so whichever one you prefer you can go to local.drizle.studio to find the studio here or you can go to your neon console here and go inside of the tables and you will find the exact same studio here so now you have the agents and in here you have ID name user ID instructions created at and updated at and the last one is a repeated user which is basically just the relation which will be loaded once we add the user ID perfect so we added the agents schema now what I want to do is I want to add the agents module so let's go ahead and close everything let's go inside of source modules and let's add agents here and then inside of here let's add a server folder and let's add procedures.ts inside of the procedures here I want to import create brpc router from trpc init and base procedure from trpc in it let's export const agents router and let's make it create trpc router and let's add get many to be base procedure query and it's going to be a simple asynchronous function and inside of here we're just going to get the data using await database from at / db and let's go ahead and select from agents so make sure to import database and agents and we don't need to add any other query because we are not querying right now by user we are not querying by pageionation we are just loading all data so let's go ahead and return this now that we have that let's go inside of DRPC routers app and let's go ahead and prepare a bit so let's import agents router from modules agent server procedures and let's remove the hello procedure and add agents to be agents router and you can remove base procedure and zod from here like this now let's go inside of home in the modules folder UI views home view and in here let's clear it up entirely and let's just say home view here you can even remove the class names remove these two imports and just leave it like this this way the component is no longer erroring great so we now added the procedures now let's go ahead and finish the module by adding the agent pages so let me just go ahead and start my app here npm rundev let's wait a second for this to load there we go so we just have home view here and now um let's go ahead and actually run this let me just move this here bottom right there we go so it doesn't cause any issues and now let's go ahead and develop the agents page so we're going to go inside of source app folder dashboard and we're going to create the agents folder then inside of here page DSX then let's go ahead and simply do a default export here and write agents like this so now when you go ahead and click on agents here you will see the text agents now let's go ahead go inside of modules agents and create the UI folder inside and create a views folder inside of UI and finally in here create agents- view tsx mark it as use client import usec from tRPC client import use query from tanstack react query now let's export const agents view here let's go ahead and prepare trc using use query my apologies use and let's get the data by using use query here prpc agents get many query options like this let's go ahead and return a div JSON stringify data null and two so null and two is basically used to format the JSON stringification in a nice way so it's easier to read and let's also do the following is loading if is loading let's go ahead and return a div loading and if is error let's return a div error like this and I just have to wrap it this in parenthesis because I can't look at it like that okay great so now let's go to the page here inside of our dashboard agents page and let's go ahead and directly return the agents view like this and there we go you're now able to click add agents right and you will just see an empty array so what you can do is you can go inside of your either Neon Console or Drizzle Studio whatever you have up and running go inside of agents and click add record for ID you can just go ahead and type whatever you want because it's a type of text uh yeah but before you do this yeah let's just discard this go to your users and just pick uh at least one user here just pick an ID for the user copy it go instead of agents click add record write whatever you want for the ID for the agent the name can be first agent and then user ID paste the ID that you've added in the instructions add you are an agent it really doesn't matter and created and updated at our default so you can click save one change and there we go that will create an agent with a relation to the user in case you fail at doing this no problem at all i'm literally just adding one record simply so we can see something being loaded here right that's the only reason why I'm doing this if you are failing at doing it don't worry uh great so now that we have this uh let's go ahead and uh spice it up a little bit right so let's go inside of the agents view here let's go inside of get many and how about I go here and I purposely make it slower by using await new promise resolve set timeout resolve 5,000 so I'm purposely adding 5 seconds here so let's refresh this and now you can see our loading state being active here uh for 5 seconds before it loads now let's comment this out and instead let's throw new PRPC error here with a code bad request for example let's refresh this as well so it's going to load it's going to load for a couple of times until it eventually hits the error I believe and there we go so after a couple of retries it shows the error state perfect so we now have a little shortcuts to do both of them so what I want to do now is the following i want to build our error state and our loading state which we are going to reuse throughout the project so let's go inside of source components and create loading state tsx and do the following import loader to icon from lucid react create an interface props with a title of string and description of string export loading state like this the structure the props here so you can obtain the title and the description and inside of here return a div the div will have a class name whoops py 4 px8 flex flex one items center and justify center the div will have a class name of flex flex call items center justify center gap y 6 bg backgrounded large padding of 10 and shadow sm inside of here add a loader 2 icon which we have imported above and give it a class name of size six and animate spin and let's also give it a text primary let me just fix the typo in my animate spin class name here below this open up a div with a class name flex flex column gap y2 and text center inside of this div you will have a heading six which will render the title and below it a paragraph which will render the description go ahead and give the heading a class name of text large and font medium and give the paragraph a class name text small there we go now let's head back inside of our agents view inside of modules agents UI views agents view instead of returning this we are now going to return our loading state like that let's go ahead and give this a title uploading agents and a description of this may take a few seconds like this so now let's go back inside of our procedures and let's enable our 5-second timeout and there we go now we have a nice loading state which we can reuse throughout uh our project perfect so now what I want to do is the following i want to copy the loading state paste it here and rename it error state inside of here I will import the alert uh let me just see which com which one is the proper alert circle icon let's use this one and this will be called error state and it's simply going to load the alert circle icon it will remove animate spin and it will use oops and it will use a color text red 500 like that go back inside of the agents view and in here use the error state give it a title of failed to load agents and a description of something went wrong or maybe let's do please try again later and let's do error loading agents and in here we can remove these three dots like this so now how about we enable the error and remove this so it errors faster so let's refresh now so it's loading it's loading it's loading and it will eventually hit the error state displaying the error there we go so what you've just learned is how to use DRPC with usequery in the most normal way everyone is used to using it and if you want to you can complete the entire project like this there is absolutely nothing wrong with doing it like this if you prefer having your error states here your loading states here that's perfectly fine but what I'm going to show you now is how to do it by leveraging server components because right now we are using this agents view as the fetcher right but we have this uh out my apologies whoops dashboard agents page which is a server component which has closer access to the database than this which is essentially a fetch API call right so what if we could already fetch the data in the server component and then immediately provide it to the cache here what if we could do that well good news is we can do exactly that so let's turn this into an asynchronous component like this and let's go ahead and define the following const query client and let's do get query client from tRPC server so you already know that we are going to be using the server utilus for this one so we get the query client here and then what we do is avoid query client prefetch query and inside we do tRPC which you can also import from the server it's important that you import both from TRPC server not from anywhere else and in here dot agents get many and simply do query options here just like that so what we've done now is we used a server components to prefetch the agents get many but we are still not done what we have to do now is we have to wrap this agents view component in a hydration boundary from tanstack react query so let's do this and let's pass in the state here to be dehydrate from tanstack react query and pass in the query client like this so what we have done now is the following flow the first component that will load when the user clicks on the agents here will be this page this server component this server component will then prefetch the RPC agents get many and it will hydrate through hydration boundary the react query or tanstack react query cache so then when the agents view finally loads it will already have the data inside reducing the load time but in order to do that properly we need to not use use query instead we have to use use suspense query like this and we have to modify a couple of things so since we're using use suspense query it makes no sense to use the error and loading here why well let's look at the difference i'm just going to control Z back so when I hover over data here you can see that in here it can be undefined right because there is a state where this data is not loaded yet that's why we handle is loading but when you switch to use suspense query and hover over the data it will never be undefined because use suspense query has already fetched data inside of it already resolved data so that's why it doesn't make sense to use these here at all so you can remove them and you can completely rely on the data here instead what we're going to do is the following we're going to go ahead and wrap the agents view inside of suspense from React and we're going to give it a fallback and let's just keep this things simple so you have two ways of doing it you can add loading state here if you want to and give it a title of loading agents and a description here of this may take a few seconds if you want to you can do it like that uh or you can export con agents view loading and then in here return the loading state and simply repeat these two values like this and then in here you can do a simpler version agents view loading and you import all of them from the same place agents view and agents view loading whichever version you prefer and it's a self-closing tag great so now go inside of your procedures for the agents router whoops and enable this 5-second timeout so now do a hard refresh here and you can see it is still working but this time it's leveraging suspense great so how do we handle uh errors here well we need an error boundary now Nex.js by itself has an error boundary so that means that you could go inside of uh agents page here and you could create an error sx mark it as use client export uh I think you need to do a default export as well well you can just call it error page make sure to not call it error because that's a reserved file name and you could just return the error state here i believe with a title uh error loading agents and a description here something went wrong and I haven't tested this but I think it should work so let me try and enable the error now and let me do a hard refresh here and uh I'm just going to see if this is working so let's wait a few seconds and there we go yeah so just like that uh we handled the error state if you want to you can handle error states like that because Nex.js offers this native uh error boundary the same way it actually offers a loading boundary but there is another way of doing it and that is by using uh react error boundary dash legacy beer depths like this so in here what you can do is inside of suspense add error boundary make sure to not import it yet and what you can do is copy this error state from here go to agents view export con agents view error return the error state here import the error state like this keep them all together go here in the page you will import error boundary from react error boundary like this and give it a fall back of agents view error so now you have all three components from the same place like this and if you're wondering why would I do this over native Nex.js ones well that's because native Nex.js JS error boundary works on a entire page level which in this specific case makes sense but imagine you just wanted it on a very small component in that page that's where having this kind of error boundary makes more sense so you can now remove this error.tsx and you can do a hard refresh here and let me just see so yeah there is one issue that might occasionally happen right i don't know if you if you've noticed it so it eventually showed this error but uh it's very hard to reproduce for some of you it might happen for some of you it might not happen but keep your inspect element open and make sure there we go you can see what's happening so this is an infinite loop that it was caught in and the only time I've noticed it happen is either completely randomly or when you throw an error right so uh I'm not sure if it happens with the native uh error boundary from NextJS but what I do know okay let me just do a hard refresh here again yeah you can see that when I refresh sometimes it happens sometimes it doesn't so it's not exactly deterministic and when I say hard refresh I mean command shift R or basically this ignoring the cache i think you can do that in Chromium browsers right um it's something relating with the hot reload uh I'm not sure if it even translates to production at all but yeah sometimes it can happen so if you get that don't worry uh I get it as well and other people do so there is an open issue on tanstack query maximum update depth exceeded here and uh it's very hard to track why it's happening you can see that uh people are having trouble narrowing it down there is a specific version they found so if you want to completely get rid of it you could technically go inside of the package JSON find the tanstack uh query and downgrade you know oops not this one anstack React query right find this one and you could technically you know downgrade it to this version and apparently the issue does not happen there uh because that's the last place they uh did some actually it would be 3 this would be the uh version without any issues with infinite hydration error loops right if you if just for your information because that's where they introduce some hydration changes and then you can see a bunch of you know discussion here uh I think that even I left a comment here as you can see that I encountered this issue as well and when I use 5.66.3 the error actually goes away uh the good news is they seem to be getting to the bottom of it as you can see just yesterday at least of the time I'm recording this video they seem to be having a fix so if you want to you can also follow this discussion so uh just please don't spam anything here right they are doing their best to fix this it doesn't help anyone by commenting I have the same problem right unless you have something of insight no need to spam the issue they are obviously fixing it um so if you want to you can follow this issue along maximum update depth exceeded in tan tech query and in here you can find the preview uh pre-release packages which apparently fixed the issue i have not tested it yet to confirm so what you could do is do npm install this add- legacy pure deps and then you would have this type of version inside it's going to look like this so that's like a pre-release but basically I'm just trying to tell you uh yeah I'm having that maximum update depth error as well but I did not uh experience it breaking my app in any way right it doesn't seem to freeze the entire app it seems to be somehow controlled another thing you can keep an eye on is this issue simply to see if it's closed if it's closed it probably means that it might be a good idea to check for a newer version of React Query maybe that will be 2 right so go ahead and do a little bit of research if you're interested and maybe they will fix it in the next version but nevertheless I developed with uh this version and I did not find any big problems it happened very rarely mostly because we don't really throw that many errors right you can see that sometimes it happens sometimes not but eventually it this maximum update loop ends and it shows the error so yeah not sure exactly what's going on here but uh just to you know take some uh your mind off ease it's let's say quote unquote normal right at least they are on it they know it's happening so you can now remove these two you can remove this and you can do a hard refresh just to prove that it's still working uh and I'm not sure if you noticed but it is significantly faster now the loading is much much quicker than it was when we used the use query right so a big important thing here is if you're planning on using suspense query in this way you need to make sure that in your server component in your parent server component you are doing the proper prefetching here with the proper hydration boundary because if you forget to do these things you will end up with some cryptic errors so right now it is working the reason it's working here uh is because if it detects if use suspense query detects no data right meaning nothing was prefetched uh what will happen is it will simply fall back to use query but this will become a problem with protected routes and you're going to see that later when we actually implement some protected routes so I just showed you a bunch of options you can fetch data in your project a bunch of ways you can show loading states you can show error states we even use the native uh Nex.js error boundary so I hope that gave you a lot of new options and uh the idea of how this works and as I said you know if you have a preference for just using you know use query and then handling loading an error here sure no problem at all in doing that this is just an optimized way of fetching your data uh it doesn't have that much effect here because we just have this simple data but later when you have actual data it will definitely you know uh you will see that it's faster perfect so I think that that was everything I wanted to show you we have the agents modules agent pages loading state and error state and now let's go ahead and create review and merge this pull request so 09 agents setup so I'm going to go ahead and click on my branch here create new branch 09 agents setup confirm you are in your new branch add all changes here 09 agents setup commit and publish the branch now let's go ahead to our GitHub let's open the pull request let's create it and let's see the review from Code Rabbit and here we have the summary we have introduced an agents dashboard page with serverside data fetching loading and error handling we added reusable loading and error state UI components and we have implemented an agents database table to store agent information we have also enabled the DRPC API endpoint for retrieving agent data perfect and we have added some new dependencies nano ID and React error boundary perfect in here we have file by file change summary and in here we have the sequence diagram and these will only become more useful uh the more we use this type of prefetching right because they will be helpful in explaining why and how things are happening so let's go ahead and go over them a little bit so it starts with the user visiting dashboard agents on the agents page the agents page is the server component in there we do a prefetch to agents.get many that in turn calls the TRPC server which fetches all agents from the database it returns the agent list to the TRPC server which we then return to the TRPC client which finally hydrates uh the agents page view with the agent data and then we can render that data finally here is the agent view my apologies there we go perfect so it clearly shows how we are prefetching through the parent server component and as per the comments here it only has comments regarding the fact that this query is obviously not something you would use in production and that's completely fair comment here but we will do that later when we actually implement protected procedures so that we can query by a specific user and when we add pagination here and same thing for actually displaying those elements you can see in here they've created an entire uh state uh for us here perfect so let's merge this pull request let's confirm merge and once you've merged it you can go ahead back inside of your IDE select your main branch and synchronize changes click okay go inside of your source control here open the graph and confirm that you have just merged 09 agents setup there we go perfect amazing amazing job and see you in the next chapter () in this chapter I want to develop the responsive dialogue component simply so we save some time in the next chapter where we are actually going to focus on developing the new agent form and for that we're going to need a responsive dialogue so I want to do a separate chapter on that to also add a responsive command dialogue while we are here so as always ensure that you're on your main branch and ensure that you have your changes synchronized also ensure that you have no active numbers here in the source control perfect so let's go ahead inside of the components here and let's create the responsive dialogue dsx like this in here we are going to import everything from components UI dialogue and everything from components UI drawer we are also going to import everything from I mean one thing from use is mobile from use mobile hooks and let's mark this as use client here now let's go ahead and let's write out the interface responsive dialogue props title which is a required string description which is a required string children which are react react node open which is a boolean and unopen change which is a toggle for that boolean let's export const responsive dialogue here let's go ahead and use these props And let's go ahead and let's dstructure all of them so title description children open and on open change let's define is mobile use is mobile if is a mobile we're going to go ahead and return the drawer component otherwise we're going to return the dialogue component so let's go ahead and do the following thing let's add two of the same props to it open will be open and on open change will be on open change prop like this and now for the drawer let's add drawer content here draw our header drawer title let's render the title below it description but let's change this component to be drawer description outside of the header add a div with a class name adding a four and inside render the children now for the dialogue it's going to be quite similar open up the dialogue content here add the dialogue header add the dialogue whoops title which will render the title this one will render the description but this one will be dialogue description and fix the closing tag here and one thing we don't have to do is add a div so we can just add children here that's because while they are almost identical they briefly uh share they briefly uh don't match in the body so the footer I mean the drawer needs the padding whereas the dialogue doesn't so now let's go ahead and test this out we can do it quite easily by visiting any page that you want for example let's do agents uh and let's go inside of agents view so it needs to be a client component and inside of here you can just render the responsive dialogue give it a title of responsive test and a description of hello of responsive description and it needs the children so in here you could add like a button component uh some action so make sure you've imported this hardcode open and for on open change just do this there we go so now let's go ahead in the agents here and this is how it should look like on desktop you should not be able to close it right because we hardcoded it to be open but if you switch to mobile it should open a drawer so when you refresh there we go it looks like you can actually force close it on mobile but that's completely okay because obviously we want our models to be closable uh great so that's it for the responsive dialogue so we can close this now you can remove it from here you no longer need it you can remove the associated components so what I want to do now is I want to do the same thing for this because right now this is what it looks like so let's make it responsive and the way I want to do this is just a little bit different so I'm going to go inside of source components UI and I'm going to go directly inside of the command component right because when you go inside of your dashboard command that's where you import from so how about we invent a new component inside so that's what chats allows us to do we are we should not be afraid of modifying these components they are not maintained by some other author in your node module they are in your project you can go inside you can change the code and make it to your liking so let's do exactly uh that go inside of the command here and find the command dialogue like this and let's go ahead and copy it entirely and let's paste it below like this and let's rename it to command responsive dialogue the title can stay the same and the description can stay the same as well uh and then what we're going to do is the following we're going to add const is mobile use is mobile from hooks use mobile right and then if is mobile we are going to render you guessed it the drawer in order to do that we need to import everything from the drawer so let's just add this and let me just move the hook up here there we go let's go to our command responsive dialogue like that so let's go ahead and render the drawer component and in here simply spread all props the same way you're doing for the dialogue now let's add the drawer content and let's give it a class name overflow hidden and padding of zero inside of here let's add a drawer header and let's give it a class name SR only which means screen reader only let's add a title here and render the title so this is only for accessibility right this will not be visible let's add a description here and let's just fix this by using the proper drawer description component and then in here what you will do is you will copy the command and all of its classes just like this there we go and let's see now we have command responsive dialogue and we have to export it so go all the way down here and export it like this and then when you go inside of your dashboard command replace the import to use command responsive dialogue and instead of using command dialogue use command responsive dialogue as simple as that so now when you try opening this up let me try zooming in a little bit when you try opening this up it should render in a drawer looks like it's not rendering in a drawer let's see why so I have set it to be a command responsive dialogue i have set this to be is mobile oh because I'm not using the return my apologies return that's why it never returned the reason you don't see any errors for these kinds of things is because it's technically correct syntax you don't have to return right it's just never what you want right and there we go now it's a nice draw so that's exactly what I wanted uh so it's easier to use this global search on mobile perfect and on desktop it stays a dialogue amazing so there will be uh we will be coming back to this component later on when we actually implement the functionality of this because maybe you've already guessed but the way this works right now is by using filters right so it's not actually doing any API calls here it's simply filtering whatever we put inside right so for example if I do test two here and if I type two it only filters test two that's not what we want because what we want is to do an API request on each keystroke right but we will worry about that later perfect so I think this is a great smaller chapter so we fixed some of those things and just one more thing that I kind of want to bring to your attention you might have noticed that any of my buttons which are not links don't have the cursor pointer instead they look not exactly clickable so that's a change in Tailwind version 4 right only links have the cursor pointer but buttons don't have it if you want to change that there is a small snippet you can do so what you have to do is go inside of your app folder globals and go all the way down here and simply add this another layer base and basically you will find all elements which are either buttons which are not disabled or are any other elements which have a role of button and are not disabled and for them add a cursor pointer so just don't forget this little comma here if you are writing this out uh I found this snippet from the actual Tailwind version 4 documentation so this is what they suggest if you want to reverse uh that effect so now buttons are clickable again if you prefer it that way if for whatever reason you don't want it that way just remove this but you can see that now this clearly indicates hey I can click on this right and I can click on this and click on this and on this i prefer it this way great so I think that wraps it up we added the responsive dialogue and responsive command dialogue perfect so now let's create review and merge this pull request so I'm going to go ahead and go inside of my source control just to review okay so I have four files changed i'm going to create a new branch 10 responsive dialogue i'm going to stage all of my changes there we go add a commit message 10 responsive dialogues dialogue and let's commit and publish the branch there we go let's go to our GitHub let's open a pull request and let's get a review from our AI bot so let's go through our code summary we have introduced a responsive dialogue component that adapts its appearance for mobile and desktop devices we have also added a responsive command plet dialogue that adjusts its layout based on the device type there we go we have also added one more command option and we improved cursor feedback for enabled buttons and interactive elements ensuring a pointer cursor is displayed for better user experience that's exactly the way I feel about it right uh great great and in here we have a whole sequence diagram explaining the device type detection and how we display a drawer or a dialogue depending on uh well device type in here it left uh some comments here uh so this is pretty cool it noticed the inconsistent padding between mobile and desktop implementation in the responsive dialogue component right do you remember that and we know that that's okay right we know because drawer content behaves differently than dialogue content so I told you that we need to add padding for the drawer but uh code rabbit you know the AI can't really know that the same way you probably didn't know it right so it made a cons uh a consideration for us here to remove that to make it the same as for the dialogue but since we know that's not the case we can safely resolve this conversation but pretty good catch by AI obviously all of the command items in the dashboard command are currently just for test so no need to do that and this is interesting so it noticed props type inconsistency specifically it noticed it in the command component this one command responsive dialogue so in here we share the component props type of dialogue and then we use those props to spread them to the drawer so yeah this is a pretty good catch because nothing is really ensuring to us that these props will be compatible or at least compatible forever but in this case you know the draw you already noticed that the drawer component and the dialogue component behave pretty much the same and I'm pretty sure have the exact same API so that's open default open open unopen change and model all of those are supported in the drawer so we don't have to add any explicit props here so it's very good that it noticed that because I definitely didn't even think of that right so you can see the kinds of things uh it it suggests you to refactor so yeah in case you're using some newer version of Shaden and you're having problems here it might be because of that it might be because the dialogue and the drawer components API have diverged and they are no longer in sync but in my version of SHAT CN uh these components are exactly the same these props have the exact same uh API so I will resolve this conversation as well and I'm going to merge this full request there we go once we've done that we can go ahead back inside of our main branch and we can click this little button here to synchronize the changes let's click okay and that should bring back everything there we go amazing amazing job confirm with your source control graph here that everything's okay we just merged number 10 responsive dialogue amazing see you in the next () chapter in this chapter we're going to go ahead and develop the agents form this will include creating a list header component which is going to render the my agents text and the new agent button once we press on that button we're going to use previously created responsive dialogue and render the agent form inside in order to achieve all of that we're going to have to implement a protected procedure agents.create procedure the list header component the new agent dialogue and the actual agent form and this agent form will be reusable for both create and update actions so let's go ahead and start with protected procedure so right now if you go inside of source DRPC in it all you have is a base procedure and for example in your modules agents server procedures for get many we use a base procedure this is the equivalent of an API request which has absolutely no security at all in sense of protecting the authorized route so that's what we're going to do in this chapter we're going to create a protected procedure so before you start doing that as always ensure that you're on your default branch and feel free to click synchronize changes just in case something was left over go ahead and mpm rundev your app and now we're going to borrow the way we protected our dashboard page tsx using the session like this so you can copy this right here and go inside of tRPC in it now in here we're going to export const protected procedure and we are going to extend on top of base procedure technically you could also do t.procedure because that's exactly what base procedure is but just semantically it makes more sense that our protected procedure is based on top of a base procedure now obviously if later on you modify your base procedure to do something specific for you know public routes you wouldn't want to uh build the protected procedure on top of that right but for this kind of uh arrangement it makes sense so base procedure dot use async and extract context and next so this is a kind of middleware and now we're just going to paste the session await from out which we have to import from lib out so make sure you've added this import and import the headers from next headers and now we have our session using the server side out adapter from better out and what we're going to do is check if there is no session throw new TRPC error here make sure you import TRPC error from at TRPC server code unauthorized message unauthorized or whatever you want to throw and the important throw back next and extend the context so we're going to spread the existing context and under key out we are going to store the current session so now after this validation passes we will have access to the currently logged in user information in all of our future procedures so now we have the protected procedure here so let's go ahead now and do the following let's go inside of modules agents server procedures leave this as base procedure for now so I'm going to add a little to-do change get many to use uh protected procedure you know just in case we forget but for now just leave it like this instead let's create the create procedure using the protected procedure so make sure you import this great now inside of here we're going to add an input and inside of the input we're going to add the schema for create so let's go ahead and do this inside of the agents module create a new file called schemas.ts so it's like this it's not specifically in the server folder nor the UI folder it's schemas for itself in the agents folder in here import Z from zod export con agents insert schema Z object name string with a minimum value of one and a message name is required and the same thing for instructions like this and now let's pass in the agents insert schema here so the reason I have done it in a separate file is very simple so I can later reuse it for the form great so protected procedure.input and then let's chain dot mutation because this is not a query this is a mutation so in here we grab async again and we can export uh my apologies we can destruct input and the context from here so what is what in the input we can grab things like our name and instructions basically the things that will uh be added through a form but from the context we can now destructure out and out will hold our session our user ID and our user information you can see even some more useful things here so that's what these two hold so let's go ahead and do the following const data or we can do this we can do you can immediately destructure the array and go ahead and write created agent to be await database you already have it imported because we used it here so database.insert insert into agents schema values and in here spread the input and attach user ID from context out user ID and make sure to chain returning there we go so now when you hover over created agent you will see that that will be a new created agent if you forgot to add returning then it's just a type of any because it's not returning anything if you're wondering why do we need to do it inside of an array like this why not just like this that's because by default Drizzle always returns an array because that's the way SQL natively works right so that's why we have to dstructure the first item in this array because we know that even though this is an array we are only creating a single record so it's safe for us to simply access the first item in this array immediately in here calling it created agent and once you've obtained the created agent you can simply return the created agent and what's cool is that this is a fully uh validated and alprotected procedure now even though we didn't explicitly write any checks here so if the user forgets to pass instructions or the name for the agent this will cause the procedure to fail and if the user is not logged in this the protected procedure will cause it to fail so that's how we have abstracted that into our safe API safe procedure perfect now let's go ahead and create our list header component so let me just go to our app here make sure you have your app running of course and let's go inside of agents so we are on the same page here and in here let's go inside of source app folder dashboard agents page and now what we're going to do is the following so you might think that we will put the list header component which is this the text my agents and the new agent button inside of the agents view right maybe add it above this we are not going to do that because it makes no sense for that part to be shown an error or for that part to be loading that part never needs to load it's static right we are not loading the agent name it's just a hard-coded text my agents so what we can do is inside of this server component we can simply render some things outside of this hydration boundary here for example list header like this and now we are going to go ahead inside of modules agents UI and create a new folder called components just so we semantically differentiate between the two and let's call this one list header.tsx if you want to you can call it agents list header if you want to be more specific let's export const agents list header like this let's just call it list header and in here import agents list header from modules agents UI components agents list header so now you will see that this list header is automatically displayed regardless of this being in the loading state and that's exactly how I wanted it to behave right there's no point in hiding this while it's loading perfect so now let's work inside of the agents list header here and let's give this div a class name of py4 px4 and let's do mdpx8 flex flex column and gap y of four now inside of here add another div with a class name flex item center and justify between And in the first element here which is the heading five write my agents and then below it add a button from components UI button with the text new agent so make sure you've added this import here uh and also yeah mark this as use client because by default uh if you just put a new component inside of a server component it will be a server component until either the parent has used client or the component itself has used client and uh I have to explain this just in case you got confused now so if you were to mark this as use client then yes every single ch child inside of here would automatically become a client component as well but that can be uh overridden if you used children for example so if you inject children into a use client component whoops then everything will become a client component besides the children children act like kind of a portal outside of it right so I just needed to explain that just in case uh you jumped to some conclusions because I often get comments asking about that uh I will try to find a better example because this wasn't exactly the best way to show it so yeah just make sure you didn't change anything in this uh agents page besides adding the agents list header here and now let's see how this looks like there we go the text my agents and the new agent button so now what I want to do is I want to give this H5 element a class name of font medium and text extra large there we go my agents new agent and for this button let's add it a plus icon here from Lucid React and give the plus icon a class name actually I don't think you need to do anything it will automatically have the proper class name there we go great so now uh what we have to do is we have to enable a dialogue to open when we click on the new agent so for that we're going to go inside of this agents modules agents UI components and we're going to create uh new agent dialogue tsx and in here import our previously created responsive dialogue from components responsive dialogue create an interface new dialogue new agent dialogue props open boolean on open change a simple toggle for that and export con new agent dialogue let's go ahead and assign the props here and destructure them open on open change and in here return the responsive dialogue like this let's give it a title new agent a description create a new agent open and on open change and inside of here you can just write new agent form there we go so we now have the new agent dialogue so we can now go back inside of the agents list header encapsulate this entire component in a fragment so we are semantically correct with the positioning of our new agent dialogue even though it uses a portal right so uh it doesn't really matter where you put it but I like to be semantically correct now in here let's add is dialogue open and set is dialogue open to be use state from React with default false let me just align these imports like I like them to let's set the open here to be is dialogue open and on open change to be set is dialogue open and modify the button on click here to modify set is dialogue open to true there we go so now when you click new agent you get the new agent dialogue and in case you are on mobile you will get a draw so exactly as we've developed in the previous chapter perfect so what we have to do now is develop the actual uh new agent form which will be compatible uh both for updating and for creating the agents so let's go inside of components here so modules agents UI components agent dash form it's unspecified whether it's a new agent form or update agent form because it's one form to rule them all so in here let's create an interface agent on props and inside of here we're going to get on success to be an optional type of call back right same as on cancel so these are not won't be required but uh it's good to have them in case you want to redirect the user after a success or if they cancel right and then we need the optional initial values right but uh right now we have no idea uh what the type of the initial values is so how about we create this and the way we can do this the way I like to do this is not by reading what's inside of my schema that's one way of doing it we could infer this from Drizzle but what I like to do is I like to know exactly what my procedure returns back so that's the way I like to do it so this is what we're going to do let's quickly uh create a get one procedure so get one and the reason that I'm doing this is simply because when the user goes about updating the agent they will first have to fetch that individual agent so that will be done using the get one procedure so let's uh also keep this as base procedure for now it really doesn't matter let's just add two comments here so change get one to use protected procedure so let's just add uh base procedure here it's okay and let's add the input here to be Z.object and I think we need to import Z here so import Z from Zod like this and in here just set the ID to be a type of string we are basically fetching the individual agent using ID so select from agents where and then add equals from drizzle or like this and all you're going to check is whether agents do ID equals input do ID and you have to destructure the input from here and then you can use it here and then in here you can destructure the individual existing agent like this and return it so when I hover over this you will see that it's the correct type so this is the initial values that the update form will be populated with that's why I wanted to create this right here so make sure that you have added this so it's just a very simple temporary form we are going to change it to protected procedure later we will do the whole proper thing let's just leave it like this for now and let's go inside of agents and let's create types.ts and we are not going to type any types we are just going to infer them here so import infer router outputs from at gRPC/server and go ahead and import type app router from atward slashtrpc routouters_app so it's basically this export right here in our tRPC routers_app folder so this app router now has access to the entire agent's router including the get one procedure so what I can do now is export type agent get one and make it infer router outputs pass in the app router so it has the context target the agents specifically the get one procedure so now when I hover over this this is the type that I am returning in this get one procedure so now we have this reusable get one type which is correctly inferred as our API will return it right because you might think oh it would be much shorter if I just inferred it from the database schema well true but what if we change our get one base procedure and we only select the name for example right and we don't select anything else then your schema will not be correct right so that's why I like to uh know exactly what my API returns so right now for example let's try and do this i'm I'm not sure if I'm doing it correctly uh but let's say I use name agents.name is this how I do it and now when I hover over this you can see that it only returns the name right so that's why I think it's important to use the return of your API rather than your schema here because this is what defines what will the initial values be so now we have that in here i just removed that select you do it as well okay so we just did a small detour here now let's go back inside of UI components agent form and we can now set the agent get one from our types here and now we know what our initial values will be now let's export con agent form and in here let's add agent form props and let's dstructure on success on cancel and initial values let's prepare TRPC from use TRPC here let's prepare router from use router from next navigation and let's import query client from use query client from tanstack react query my apologies uh oops no no no this is incorrect use query client there we go no need for this so use router from next navigation use query client from 10stack react query use tRPC from ad/trpc client and agent get one from the types great now let's go ahead and create our create agent method using use mutation from tanstack react query and in here simply pass the TRPC agents create and pass in the mutation options here and in the mutation options define on success method here for now to be empty and on error to be empty as But we're going to come back to this uh later great so now that we have this uh let's go ahead and create our form here so const form will be use form from React hook form and we're going to Z.infer and in order to do this we need to import Z from zod so Z.info info and we don't have to write any new schema we can just do a type of agents insert schema do you remember this we've created this previously just a moment ago when we used it inside of our create procedure agents insert schema it's located inside of our modules agents schemas it's right here so I just import that again and then I can use it here and I don't have to write any new schemas i can then add my resolvers zod resolver from hook form resolvers zod and pass the agents insert schema and add my default values which are name and instructions so make sure that you have imported the ZOD resolver here and then make sure that you properly assign default values right because this is true for a new form but if we actually have initial values we should fill them so go ahead and check if you have initial values and then depending on if we are intame or an empty string or if we are in dot instructions or an empty string so this way it's going to populate or fall back to an empty string great so we now have the form now let's create a useful isedit method here which will be simply be a double exclamation point initial values question mark id so this is what we're going to use to determine whether this is editing form or creating form and let's define const is pending here to be create agent is pending the reason I'm adding it in a separate variable is because later we're going to have update agent is pending so right now this does not exist so that's why it's an error but let's already be prepared for this to be uh extended later on perfect so now let's do con onsubmit method here which gets the value z infer type of insert agent schema agents insert schema my apologies uh and if is edit we're just going to do console log to do uh update agent else we are going to do create agent.mmutate and pass in the values like this there we go perfect so now what we have to do is we have to import everything from our form control I mean from our add/components UI form so form form control field item label and message besides that we're also going to use our generated avatar component which we have already used in our dashboard user button in case the user doesn't have an image and we're going to add text area i think this is the first time using this component uh it's just a text area in your source components UI text area added from chats and UI and besides that we're also going to need the usual input from components UI input and button from components UI uh button and I think for now that's all the imports we need let's go ahead and develop this form now so after on submit let's finally do a return here and open up a form go ahead and spread the form from use form here inside of here add a native HTML form element give it a class name of space y4 and give it an onsubmit of form handle submit and pass in the onsubmit function in case you're wondering why am I doing a function inside of a function uh form handle submit basically ensures that uh we didn't do anything wrong in regards to the schema right so this part will prevent this from being called which is the actual submit method if the form is not correct if it's too short right if there are any HTML errors being thrown phone so now inside of here let's add a generated avatar component here and we're going to give the seed to be form.watch name so every time you change the name of this agent a new avatar will be generated according to that name the variant will be uh bots neutral let me just select it there we go and class name will be border and size 16 there we go now let's add a form field which is a self-closing tag let's give it a name of name and let's give it a control of form.cont control and then finally a render method in here we can immediately dstructure the field let's add form item here form label which will be the name let's add form control here and let's render the input and let's simply spread the field here so let's go ahead and check it out uh let me just see okay these errors are fine these are just unused values i think what I have to do now is go inside of my new agent dialogue right here and actually render the agent form from dot / agent form now in here uh what I want to pass is on success on open change false and on cancel too so basically once we complete the form and once we or if we cancel the form just close the responsive dialogue so that's what we want in the call back so now if you click here you should see this right how you name your agent will depend on the avatar that will be generated and I think that's pretty cool because this way we have consistent avatars for an agent right if you name it John it will have this avatar everywhere because we're always going to use the agent name as the seed perfect so now let's go ahead and uh let me just see one thing yeah this doesn't have a placeholder so if you want to you can add a placeholder here for example John right or I don't know maybe something like math tutor right uh now what we're going to do is we're going to copy this entire form field and we're going to use a instructions here this will be instructions and instead of using the input we will use a text area right and in the placeholder here you can add you know whatever you want to explain to your users what it is so for example it can be let me just paste it you are a helpful let's do math assistant that can answer questions and help with assignments like this right whatever you want to add inside there we go perfect and then what we need is after still inside of the form right but after the form control here add a div and inside check if we have on cancel if we do render a button and the text cancel give it a variant of ghost disabled of is pending and type of button this is very important otherwise it will submit the form because it's still inside of the form here and on click here will be a very simple on cancel and then you can add another button here loading actually disabled here will be is pending as well and give it a type of submit check if it's edit and then render update otherwise render create there we go perfect so now you have cancel and create here and let's just use this div to give it a flex justify between and gap x of two there we go so now when I click cancel here I can close this and the reason I can close it because in here I have added a call back here to close it right perfect so now uh yeah I think that I uh forgot to do one thing here for the name also add form message here outside of the form control and do the same thing here great right so now if you try submit this you will see the errors and yeah looks like inside of um my agent schemas I need to change this to be instructions are required there we go perfect so now let's just see what's being unused here so this is what we're going to do now in the on success let's do the following let's use query client to invalidate queries brpc aents.get many and pass in the query options like this and later on I'm going to add a to-do here uh invalidate individ oh actually we can do it yes my apologies we can already do if initial values has the id we can also invalidate another thing called PRPC agents what we just created get one because in here we need to pass the id and in this case that is the initial value ID so what's going on here basically uh when on success happens when we create the agent and we successfully do it uh we are going to invalidate the get many so that this right here refreshes so we're going to add a new agent and we want to immediately show that new agent in the table so that's why we need to invalidate those queries right and this is where you actually see the power of using pre-fetching in server components and uh handling it the rest in the client components because the fact that in the page tsx of our whoops page.tsx in our agents we do the prefetching it does not prevent us from continuing to refetch this through invalidation or any other method right so that's why I prefer using this way you could have done the same thing of course if you used just normal use query here but if you used uh if you actually load the data in the server component and then passed it as a prop you would not be able to revalidate it like this right that's why I really like this way of doing it and also um this invalidated queries I think that they are a promise so if you want to you can mark this as async and then you can await them like this i'm not sure if you have to wait not exactly sure i mean they definitely still work but you know and let's also add on success here but since it's optional do it like this and two S's there we go so this will then close it right why do I say it will close it well because we added that to happen here uh great so now let's go ahead and go inside of the on error here and what we have to do here is the following so in here we have to first go inside of our root layout so in the app folder layout and add a toaster from components UI soner so it's not a wrapper it is just a component to be added like this and then instead of the agent form you're going to get the error here and you're going to do toast error here error dossage and you can import toast from soner like this and I will just add a to-do comment here let me just go here to-do check if error code is forbidden redirect to forward slashupgrade so we don't yet have this but we will have this in the future uh great so the only thing that is uh unused at the moment is use router um and there is something that um yeah okay let's just remove use router then because we can't really redirect anywhere at the moment great so I think that this is now ready to create let's try it actually so make sure that you're logged in and let's try a test and test instruction here instruction let's click create and let's see i think that it works test instruction it's right here there we go test instruction and test perfect so it's exactly what we wanted let's try another one let's click create and there we go it immediately adds that here perfect uh now let's go ahead and let's try an error so how do we achieve an error well I think there is one way of achieving the error without changing anything so if you go inside of source app folder dashboard agents page you can see that this page is not protected so unauthorized users can actually see this page and I purposely told you that in the get many you leave it as the base procedure the same as get one the reason I told you is so I can demonstrate this so I'm going to copy this URL and I'm going to log out and then I will go back here in the agents as you can see I can access this page even though I'm logged out so this would be a very bad thing right but what happens when a logged out user actually tries to create something you get back uh what I now notice is a typo unauthorized let me just quickly fix that inside of my DRPC in it unauthorized right so even if you forget to do uh a redirect in the server page right because in my dashboard page I do this session and I do the redirect so even if you forget to do that somewhere you don't have to worry because that is our last line of defense our first line of defense are going to be the protected APIs so now what I want you to do is the following i want you to go inside of your agents procedure so modules agent server procedures and now change this to protected procedure and you can remove this comment and same thing for get one protected procedure and you can remove the base procedure input and now when you do a refresh here you will see that logged out users cannot even see the data so even if you forget to protect your page and redirect the user away you don't have to be afraid because our APIs are completely protected as you can see here we have this unfortunate maximum update depth which I talked about previously but you can see that eventually it stops and it will just show the user an error and if they even try to create something they also get the unauthorized error so there's absolutely nothing they can do but let's just wrap it up with doing proper redirect here as well so we can just copy this from the dashboard this entire thing here there we go and we can do it before we even add these like that so import out from lib out let me just move it here import headers from next headers and import redirect from next navigation so now even if you refresh you can no longer access that so I just told you the worst case scenario which is you forget to redirect from the server component nothing dangerous will happen that's because our that's our this is our last line of defense right this is not what's actually protecting our app trpc and the proper use of procedures are protecting our app that's what's handling the errors and that's what's protecting the actual data perfect so I think we've learned a lot in this agents form uh so we have successfully created the protected procedure agents create procedure list header uh new agent dialogue and the agent form which is reusable for both create which we demonstrated but we we can't yet demonstrate the update and now let's go ahead and merge these changes so I'm going to go ahead and click on my branch here create a new branch this is 11 agents form so 11 agents form let's stage all of these changes by clicking on the plus so they are now all uh staged 11 agents form commit and publish the branch now let's go ahead and open this pull request and let's wait for the review from code rabbit and here we have the summary so we have added a global toss notification for improved user feedback which is our toaster we introduced a new my agents page header with a new agent button we added a model dialogue for creating new agents with form validation and avatar preview we implemented an agent creation form supporting both creation and editing workflows perfect so in here of course we have a more in-depth walk through uh as you can see it noticed that we added a TRPC a protected TRPC middleware for securing the end points right and in here we have a whole sequence diagram explaining the state of our app right now uh but this part right here we've already covered this in the previous pull requests what we are interested now is in this part when user clicks on new agent and in here it rent it clicks it here in the agent list header which opens a dialogue new agent dialogue which finally uh renders the agent form so the user then submits the form in the agent form which then calls the create which is the protected procedure so that's calling the TRPC server right the TRPC server is a protected middleware in this case because it's a protected procedure so it calls the session if it has no session it fails but if it has a session it inserts the new agent right here in the database and the database returns back the created agent to the TRPC server which then on success handles the rest of the events so as I said this sequence diagrams will become more and more useful as we go on in here we have some comments of course we left a to-do here so it recommended adding the update agent in case we forgot but we did not forget we actually don't have it yet we just developed ahead of time in here uh it gave us the proper advice of handling um non-existent agents so yes when we actually go and develop this get one method which we are going to have to uh well advance a bit further than this we will also have to handle this throwing an error if the agent is not found so yes this is a good suggestion and we will add that later when we develop the actual agent get one page so we can resolve this and in here in the get many uh it tells us to actually protect this procedure even further by only loading the agents from that user that is exactly what we are going to do in the next chapter when we load this in the actual table right because right now we're just JSON stringify the agents in the next chapter we're going to develop the actual table for that and that will include this fix as well so all great suggestions exactly what I plan to do in the following chapters so let's go ahead and merge this now perfect and once you've merged it go back to main and click synchronize changes and click okay here and you should be all good let's go ahead and check our graph here we just merged 11 agents form which marks the end of this chapter amazing amazing job and see you in the next chapter in this chapter we're going to go ahead and develop the agents data () table this will include a nice display for existing agents but also a nice empty state if no agents have been created so the first step is to implement the data table component now as you probably know already inside of our source components UI we have all shats components and that includes the table component but what we are looking for is not the table component we are looking for a data table component so in order to implement that we have to go back to chats UI documentation and find data table now we can skip the first step of the installation here because we already have the table component instead we can immediately go to step two adding tanstack react table so make sure that you are on your main branch here and make sure you have s syn syn synchronized all changes once you've done that go ahead and install penstack react table and you can add a legacy pure deps to avoid any pure dependency errors great once you have added that you can go ahead and run your app i will now open my package JSON just to show you the new package version 8.21.3 you don't have to strictly use the same version i don't think uh this package often introduces breaking changes great so now let's go ahead and build this so we're going to start by adding columns let's go ahead and do that i'm going to go inside of source modules agents UI components and inside of here I'm going to define columns tsx like that and I'm going to copy this snippet now in case you're having trouble finding this documentation page or it changed a lot uh by the time you found this video no worries we're going to go line by line and see what's going on here so it's not too big of a file don't worry so first of all make sure it's marked as use client make sure you add a tsx extension and import column defaf from your newly installed package in here we just defined a very simple payment type with ID amount status and email and then what we do is we return an array of uh column definitions according to the payment type so we render the status the email and the amount using the accessor key and the header keys that's it so the next thing we have to implement is the data table component let's go ahead inside of components and let's create data-table.tsx and again I'm going to copy this entire snippet and paste it here and we're now going to go ahead and look at it so first of all use client then the necessary imports from tanstack react table which are column def flex render get core row module model sorry and use react table then table table body table cell table head table header and table row from components UI table which is the component we looked at in the beginning to confirm that we have it we then created a generic data table props which accepts any table data and any table value here and after that we export function data table and we pass it these generics right here and we destructure the columns and the data from the data table props passing the generics our table constant is defined through use react table which simply accepts the data the columns and the core row model inside of here we have a div with a class name rounded medium and border and it encapsulates our entire table then we have a table from the actual components UI table inside a table header and inside of the table header what we do is we map over each of our header groups and we render out the table row and then inside of this row we go inside of the individual header group inside of the headers and we map out each individual table head which would most likely be the column so this would be uh status email and amount in table head components we check if it's placeholder and render null otherwise we use the flex render function which we imported from tan stack react table and we pass in header column column def header in the first parameter and header get context in the second parameter and we end the table head and the table row and we do the exact same thing uh for the table body here you can see it's not anything more complicated the only thing we do here is we do a length check in case it is empty what we do here is we just render an empty table row and we give it some default height and text center here and we also give it a proper call span so it takes the entire width of our table so I hope that this kind of uh made it easier for you to understand what's going on and if you struggled finding the actual snippet you can now find it here so now that we have our data table let's see what is the next step here so let's go ahead and render that table and let's also invent this get data it seems so this is how we're going to do this now we're going to go inside of our views agents views here and we're going to render the data table component from that that dot dot/components data table and in here we're not going to use this data uh instead we are going to define our own data here let me just copy this let's just do const mock data and just do you know something like this id amount status it needs to be either pending or processing or success or fail so make sure it's it matches this type like this mock data and just pass in the data to be mock data here and you also have to pass in the columns so columns will be the columns which we can import from dot dot components columns like this and let me just see if I did this correctly here uh I think the problem here is in the mock data here we have to assign it to be payment type and we might have to oh it's just payment okay so let's import payment from the columns and set it as an array there we go now you no longer have any errors here and now if you visit this and refresh the agents page you should see your data table here let's wait and there we go this is our data table with our mock data and this is actually enough for us to no longer need to follow this if you want to you can take a look to see exactly how you would add some more things here but we are going to take it from here and develop our own version so the first thing I want to do is go back inside of the data table and modify it just a bit so I'm going to go ahead and give this div besides uh I'm going to change rounded medium to rounded large i'm going to leave the border and I'm going to set the bg to be background and overflow to be hidden so that's the first thing I'm going to do then what I'm going to do is I'm going to delete the table header entirely like that so I only want the table body to render and in the table body I'm going to go ahead and do the following i'm going to give this one a class name of cursor pointer like that so when I hover over it looks clickable and I'm going to introduce a new prop here after the data on row click like this to accept the row which is a type of data and return a void so I can now destructure on row click here and I will simply add it to the table row so on click arrow function on row click question mark dot and then execute and pass in the row original inside so it's optional uh so make sure you added the question mark here great now what I want to do is I want to modify the table cell here by giving it a class name text small and padding of four and in the table row here I want to change this to be height 19 and also add text muted foreground and change this oh well this can be no results that's fine yeah and remove table head and table header from here there we go just like that so now what I want to do is I want to go back inside of my agents view here and just start uh modifying this a bit so give the wrapping div here a class name of flex one padding bottom of four px of four and the px of 8 flex flex column and gap y of four there we go so looks a little bit better what I want to do now is the following i want to go inside of my columns and in here I'm going to modify this to no longer use this payment type instead I will use agent get one from the types which we did in the previous chapter right remember when I told you to create the uh get one protected procedure so we are reusing it one more time here as our column data type here and now we're going to go ahead and modify the actual columns here so the first one we're going to render will be the name of the agent and the header will be agent name and now what we can actually do already is we can go back inside of the agents view here and we can use this data we no longer have to use the mock data at all and you can remove this there we go and you can already see that you now have all of your agents here so if you add a new agent it will appear there we go so we are now rendering them inside of here perfect so let's go back inside of the columns and let's improve the way the name field is showing so we can do that by adding the cell property here the structure the row and render a div here with a class name flex flex column and gap y of one inside another div with a class name flex items center and gap x of two and then finally a generated avatar component which is a self-closing tag and inside of here give it a variant of bots neutral seed of row.name and a class name of size six so make sure you have added this import here and already you will see the avatars of your bots let's confirm so test seems to be having let's try test two it seems to be having this oneeyed row when I click create it has the exact same face perfect so now that we have added that below the avatar add a span element rendering row original name here and give the span a class name font semibold capitalize there we go and now outside of this div open up a new div with a class name of flex items center gap x of two and inside of this div a new div with a class name flex items center gap x of one and in here let's add a corner right down icon make sure you import this from lucid react and give this icon a class name of size three and text muted foreground and then add a span element row but give this a class name of text small text muted foreground maximum width of 200 pixels truncate and capitalize so we are adding truncate so that it cuts off right uh and let's just see so this should be corner down right icon so make sure you don't do the same mistake as I did corner down right icon there we go so flex item center gap x1 let's add uh maybe 1.5 here uh or maybe let's try two yeah maybe two is a bit better and now that I'm looking at it we don't even need the outer div here so you can just remove the outer div i think it's exactly the same yeah it is perfect so yeah you can choose gap x1 or gap x 2 i think maybe two gives it a little bit more breathing room maybe 1.5 as the perfect middle i don't know sometimes I can't decide okay uh great so we can now render our avatars here nicely our agents and now let's also add another key here accessor key meeting count and header will be meetings and cell here will be a row like this add a badge from components UI badge so you already have this component installed instead of source components UI badge and in here what we're going to do is simply render a video icon from Lucid React and give it a class name text blue 700 like this and then add row original dot meeting count which will throw you an error because it does not exist yet and then after it check if row original meeting count is equal to one and then add meeting or meetings and give the badge a variant of outline and a class name flex items center gap x2 and in order to modify the SVG size we have to target it like this and then add size-4 so right now you can see that it looks a little bit broken here so let's go ahead and improve it by going inside of our procedures for the agent and finding the get one here and in here in the select what we have to do is we have to add the meeting count option and I think that we can just import SQL from Drizzle RM and for now just like put a number five i think this will render the number five but what happens now is that our existing agent will only return this and you can also put like a type of number here but in order to preserve all other fields we can use a spread get table columns from drizzle or so so I imported SQL from here as well and pass in agents so now the existing agent has the meeting count which is a number and you no longer have any errors here let's refresh and see looks like it's uh not yet working just because I'm not sure how to actually uh use this to mock a number let me just uh try something what we can do for now since this is obviously not working we can do database dot dollar sign count agents and I think we can just do this let's just count all agents will that give us a number i'm still not getting uh any number so how about I try agents where equals and um let's try user agents do user id matches we can now since this is a protected procedure we can now extract context from here and we can pass in the context out session user ID let's try now okay i I can't get a number from here for whatever reason so yeah it's okay let's remove the meeting count from now let's remove this sorry for making you do all of this it's because we are missing the meetings schema right i'm trying to mock a number here so we're just going to set this to be five meetings for example like this and uh you do add a meetings count here and just use the SQL five with the type of number and import SQL from drizzle or um and you can add a little to-do change to actual count there we go so this is how it's going to look like besides everything regarding uh the first agent here we are also going to actually count the number of meetings it has so we need the meeting count property to exist here because otherwise the accessor key gets confused so that's why I'm trying to mock the number later what we're going to do is we're going to actually count the number of meetings associated with our agent or our agent associated with the number of meetings um perfect yes so this is what I wanted us to do and now what we have to do is we have to implement the empty uh stage as well so let's go ahead and let's go to neon.te so we can go inside of our project here tables or you can use the Drizzle Studio it's the same thing right and let's go inside of agents select all of them and delete all agents so it's completely empty and now when you refresh here uh you should see no results but I want this to have this nice uh view as well here so uh let's go ahead and go inside of here i'm going to fix this error in a moment let's just wrap up the um empty state right so I will leave this for later in order to implement the empty state we can get started faster by copying the error state so let's copy the error state and let's paste it let's rename it to empty state like this and export con state like that uh and then what we're going to do is the following i'm going to remove this part and just put flex flex column item center justify center and then I'm going to remove this div entirely like that and then in here I will not render the alert i will render an image from next forward slashimage and in here for now I will set the source to be logo SVG alt will be empty width will be 240 and height will be 240 as well and then in here this will be flex flex call let's set gap Y six here let's set maximum width to be medium mx to be auto and let's put text center here and this will also have a text muted foreground there we go like that so now that we have the empty state let's go ahead and render it so inside of agents view here where we have this error let's go below it and let's do the following if data.length is equal to zero go ahead and render the empty state like this so I'll just move it here with the error state here and the title will be create your first agent and the description will be create an agent to join your meetings each agent will follow your instructions and can interact with participants during the call and let me just fix this join there we go so now you should see your big logo here and the text create your first agent so what we have to do now is do a proper image here what I've prepared for you is a link you can visit or you can use the link in the description if this URL stops working so cwonia.com/me-assets and when you visit that you will get redirected to this uh public GitHub with all of the uh images and assets for this projects or if you have access to the source code you can just go directly into my public folder where I will add them so let's go ahead and add empty.svg since it's an SVG you have multiple ways of uh downloading it you can download it or you can click code and just copy the entire code here and then just go inside of your public folder add empty.svg click this open file using VS Code standard text binary right and just paste the code inside and there you go you now have uh the empty uh placeholder perfect so now let's go back inside of empty state and let's use empty.svg and there we go now you have the empty state create your first agent create an agent to join your meetings each agent will follow your instructions and can interact with the participants during the call and the moment you add uh a new agent test test click create and this will now refresh and you will no longer see that empty state perfect amazing amazing job so that's exactly what we intended to do we added data table empty state and we obtained the assets so in the next chapter we're going to focus on this the pageionation right and also this the filters but that's going to be for the next chapter amazing job and let's go ahead and create review and merge this pull request so I'm going to go ahead and click on my branches here create a new branch this will be 12 agents data table I believe yes let's go ahead and confirm we're on the new branch stage all changes here let's wait a second there we go stage changes 12 agents data table let's commit and let's publish this branch there we go let's go to our GitHub here let's open a pull request there we go uh and I already remembered something that I will have to do yeah so let's uh let's open this pull request and I'm going to let the reviewer do its thing here but uh let's go back inside of uh so it's completely fine to stay inside of this branch right we can work in it let's go inside of our agent view here ui view is agents view and I just want to see why am I getting this error here so something's wrong with the columns agent get one meeting count so something is not matching here let's go inside of our columns to see accessor key is name meeting count what if I comment this out nothing okay so for some reason it's throwing an error here i'm not exactly sure why so I will uh experiment with this a little bit we can leave it like this for now actually it's not it's not too big of a problem uh so I will explore this actually in the next chapter so we're going to fix this error alongside adding our pagionation and things and here we have the code summary so let's read the walkthrough a new table display feature for agent data was introduced using the tanstack react table library this includes the new UI components for table columns a generic data table and an empty state the agents view now renders agent data in a styled table and the backend query for agents was updated to explicitly select columns and added a computed field which is our mock meetings account in here we have a whole sequence diagram but we already know how this works right it's but and it goes even further displaying the data table or the empty state here and in here it left some expected comments it really doesn't like that we hardcode this so it gives us some action items define or migrate a meetings table in your schema we will be doing that very soon but I do want to wrap up agents first in here it uh suggests adding an action button to the empty state so this could be a good idea but since we already have a new agent here I kind of feel weird having another one you know here so I'm going to leave it like it is and uh in here of course uh it doesn't like that this is hardcoded we will change that later when we actually uh have this value here uh and in here it noticed that we removed the table header uh so very good that it noticed that but we did it on purpose great so let's go ahead and merge this pull request so in the next chapter what we're going to have to do is work on these filters here and fix this issue even though I'm 99% sure this types are confused simply because of uh Oh the types are confused oh I just realized that all this time I've been adding the meeting count to get one i also have to add it to get many that's why it's so confused here okay so we know how to fix it but we don't have to do it now since we just merged this pull request right let's not change anything in this branch anymore and instead let's go and change this to main and let's synchronize our changes here there we go let's click on our source control click on the graph and confirm that you just merged commit 12 inside of here and added all of these things perfect so amazing amazing job let's mark that as completed here and see you in the next () chapter in this chapter we're going to implement agents filters so the reason I didn't put any screenshots here is because the filters were already featured in our chapter 12 so it's going to be this search bar and the pagionation right here we're going to start by modifying our agents.get many procedure we are then going to add a package called nux we're going to implement the UI components for the filters which will include the search input and pagination and we are then going to synchronize the React server component filters and client filters because it's very important to do that when we do prefetching let's start with modifying the agents get many procedure and before we actually do anything well as always confirm you are on your default branch and confirm that you have synchronized your changes here and then head inside of modules agents UI views agents view and in here we have this bug and the bug is because in the get many procedure here I don't have the meeting count so what I'm going to do is I'm just going to copy what I did for the get one and I will add it in here like this and as you can see immediately the error now goes away and I think that now so all that time in previous chapter I was adding the meeting count in the get one procedure and I was so confused why I couldn't read it in my table here so I think that now once I add it to the get many procedure just a hard-coded number five i think that we can go inside of the columns so instead of agents UI components columns and I think that I can actually now try reading row um my apologies let's dstructure the row here row original meeting count can I do that now let's refresh there we go so number five is rendered here so if I change this in the get many procedure to number six and refresh it shows number six perfect so now we can go ahead and add that little tweak here if row original meeting count is equal to one show meeting otherwise show meetings so it shows the proper the grammatically correct text perfect so that's the first issue fixed we no longer have any errors inside of our agents view the second thing that we now have to do is go back inside of our get many procedures and what we have to do is implement the proper filters here so before we do dotquery let's add dotinput here and let's open up an object so I think we already have zod imported perfect so now inside of here we can add the filters the first one will be the page which will be a type of number and the default will be one as in the first page and for the page size here we're going to add Z dot number with a minimum of one and let's add a maximum of 100 and the default of Whoops let me just go back and the default of 10 and then we're going to have search which is a string and nullish uh nullish this one like this and you can set the entire input to be optional uh my apologies so you have to go inside of this parenthesis and then put optional here the reason I want to put optional is because we have default values for the page and the page size so if the user doesn't want to pass any filters they don't have to pass any filters right uh and also here's another thing you have to be aware of and let me just indent this a bit like this i just want to format it a bit nicer so it's clearer which part is which there we go like this so protected procedure as an input inside of that input we have an optional object which has three possible parameters the page page size and search why did I add optional to the entire Z object well for example if we go inside of our agent form component you might remember that in here we do some invalidation here right specifically what we do is whenever we create a new agent we refetch agents get many by invalidating it now if I were to change this to not be optional you can see that I immediately get an error here because this expects the object inside for the options but since I am invalidating this I don't really know what to pass here except just an empty object so it kind of looks weird right and not only that but for example in my agents view here I also have a problem even though I just want to use the default options I now have to just pass an empty object inside right so that's why I prefer to add dot optional to the input here i mean sorry to the Z object here and instead just make sure that I have some defaults for example the search doesn't need to have a default but pagenation needs to have some defaults and if I handle the defaults inside I can safely put the entire object to be optional and guess what i don't have to modify the rest of my existing queries here right i don't have any errors great so now I don't like magic numbers in my code so what I'm going to do is I'm going to go inside of source folder and create constants.ts and inside of the constants uh file I'm just going to export the default page to be number one default page size to be 10 maximum page size to be 100 and the minimum page size to be one so just these four constants here let's export them and the reason I put them in the constants folder file in source is because I will use the exact same defaults and constants for all of my get many procedures if you want to have different you know per module you can then put it inside of the agents module and use them but since I know that all of them are going to be the same I will just use them in the source folder great so now let's go ahead and replace the page default with default page from the constants right let's import it then the minimum here will be minimum page size from the constant maximum page size and default page size make sure to use default page size and not default page here so you should have all of these imports here there we go perfect so now that we have added that we can work with those inputs here let's dstructure the context and the input from here and the first thing I want to do is the following i want to add a where here and inside of here since I already know that I will have multiple uh equals I will add and from Drizzle ORM so make sure you import and from Drizzle ORM and then I'm going to open this and the first one will be an equals for agents user ID to be equal to my context out user ID or you can use context out session user ID whichever you prefer they're the same so that's the first thing that I want to load i only want to load agents that this user created because in the create procedure uh we set the user ID to the currently logged in user so that's how I know that this will work automatically but besides that we now also have some more filters like the search filter so for this we can check if we have the search and if we do let's use I like from drizzle OM so make sure you add this import here and let's go ahead and pass in agents.name like this open backex go ahead and add percentages and render the input dot search like this and this will be input dot search whoops like that otherwise undefined perfect so now um that we have that let's go ahead and you know now that I thinking you know I kind of don't like this uh I don't like that the input has to be uh accessed through a question mark here i have a feeling this might complicate things because even though we've set this things to default uh the input by is as you can see it's possible for it to be undefined so I'm going to revert my decision i know I told you to put this to optional but I would rather we don't do that so remove optional from here and you can see immediately I have errors here i would rather we handle those errors than have unsafe access to the variables inside my input because what I can do now for example is I can extract search page and page size from the input safely right whereas if this is set to optional I'm you can see this is any right obviously this doesn't work properly so I don't I think I would rather do it like this because now I have the proper information i think one possible solution is to set the input like this and then its number or undefined but then again you know I don't like working with values like this because this is technically not correct page size will always be a default something so it's obviously not inferring these things correctly so that's why let's not use optional uh I I regret doing that so I'm going to remove it now and I'm going to instead do what I said I didn't like but let's do it so add this Z object to your protected get many procedure you can go ahead and destructure these items here leave everything as it is and let's fix our errors so what you can do is you can search for agents.get get many and you will find all the places you are using it so let's start with the first place here this is the source app dashboard agents page where we prefetch what we have to do now is add the empty object inside let's go ahead and do it again agents get many the second one is inside of the agent form so inside of modules agents UI components agent form when we invalidate the queries pass an empty object here great and the last one is inside of the agents views so source modules agents UI views agents view and go ahead and pass that here there we go and we just resolve all syntax errors and we can now safely dstructure the search page and page size from the input here and then I can do search here and I can do search here there we go so it's easier for us to build these queries okay so yeah you can see me change my mind in real time now great now let's add order by here and let's add descending from Drizzle ORM and in here descend by agents.created created at and then combine it with descending agents id the reason we need the second one is for pagination so let's add a limit to be page size here and let's add an offset here to be open parenthesis page minus one multiplied by page size so each following page will offset the last result and now let's calculate the total so con total will be await database select count and use the count not from the not from console use it from drizzle o and execute it so make sure you import count from Drizzle OM and add from agents here and where just go ahead and copy the query like this but in here we will not do any ordering or any limit or offset so we are interested in the total number of items that we are working with because only with the total number can we calculate the total pages so let's use math ceiling total first one in the array dot count or what you can do is just the structure total like this so then you can do total dot count looks nicer this way and divide it by page size and then in here instead of returning the entire data what you're going to do is you're going to return items under data total under total.ount and total pages as a separate last item great and now that we have introduced this we have to go ahead and fix again uh all the places that use get many so let's search for agents get many in the page everything seems to be okay because we're not actually working with the data agent form everything okay because we're not actually working with the data agents view and we have some problems the one we can fix immediately here is data.length so now what we have to do is data items.length and in here data do items as well there we go so that's how we fixed that issue now let's refresh and let's see there we go i can only see one now uh and let's go ahead and let's try creating some more elements here for example let's create five of them just so we can try out our filters okay so I have five agents and I will go inside of my procedures get many and I will change the default page size here to be for example two so when I refresh now you will see these two right here and even though I entered the exact same name for them which is a coincidence you can see by instructions that they are different uh agents here perfect so we can now bring this back to 10 and just refresh there we go and also uh you can now try and changing inside of you suspense query here if you want page size for example you can do it here but this is also where you will probably encounter this issue and it says unauthorized why does it say unauthorized it seems like a pretty cryptic error for a very simple thing we did we just used the options that were given to us well the reason why is because you're using use suspense query that means that it's expecting the data to be populated from somewhere more specifically data populated from dashboard agents page prefetch the difference is in the server component you prefetch without any explicit page size but in here you are fetching with the page size so what happens is that this use suspense query notices hey I have different query options that means I cannot guarantee that I will have the same result as the cache that was given to me so I will fall back to use query the problem is one thing that doesn't get transferred when it does its internal fallback to use query is the headers which means that it loses the authentication so that's one uh gotcha as we would say right that's one potential foot gun with using this and not being careful so the the error is very cryptic it just says unauthorized that's because we are authorized when we prefetch but in here we lose that chain of events because we have different query options so in order to not throw an error but to still attempt to load the data what we do is we switch to use query and then we load with our new query options and somewhere in between we lose those headers and we fail to uh call that procedure because that procedure is protected and then we get into this weird state where the data actually loads but we still get this error right so it's kind of weird but the fix is very easy you just have to make sure that what you prefetch is exactly the initial state of what you expect in the suspense query you can later of course uh change this to be page size 10 right you can modify this later but the initial load needs to be exact once you do this and refresh no more errors right but if one of these doesn't match you will start getting that unauthorized error because the queries don't match so now go ahead and clean this entirely make it an empty object and make it an empty object here perfect what we're going to do now is we're going to add Nuks so let's go ahead and do npm install nooks- legacy pier depths and I will show you my Nooks version just in case oops package JSON Nooks so 2.4.3 uh the major version here is quite important because uh NX one for example is a completely different usage than NX 2 so in case your NS behaves very differently than mine feel free to install NX 2.4.3 to get the exact same experience as I do now let's go ahead to our root layout application so source app folder layout and in here import Nuks adapter from Nooks adapters next and go ahead and wrap the entire app inside of the Nooks adapter there we go and now you will see what Nooks basically is so uh what I like to do is I like to create a use filters hook inside of my uh respective module so let's go inside of agents here and let's create hooks and inside of here go ahead and add use filters or let's do use agent agents filters.ts like that and inside of here what you're going to do is import parse as integer parse as string and use query states from Nuks export con use agent filters agents filters and return use query states here and pass in the search to be parse as string dot with default empty string and with options clear on default true copy and paste this and set the second one to be the page and this will be parse as integer like this oh and this is an object not an array sorry there we go and with default it's going to be uh default page from the constants like this and clear on default will be true so one thing that we are not going to add here is the page size why well because nooks is basically a way to synchronize your search params for example search hello with your use state let's call it like that so we are basically going to use Nooks as a way to synchronize the URL state with our React component right it's going to be a two-way binding where they will control each other in sync but what I don't want is for the user to be able to append you know page size 1 million and break our app that's why I won't allow the user to change page size from the URL great so that is use agents builders here uh and now that we have that we have to go ahead and actually uh well use them so this is what we're going to do we're going to go inside of source inside of modules agents and let's go inside of uh UI components agents list header right here and in here I'm going to get the filters and set filters from use agents filters so you can see that it behaves exactly like use state so you get a very familiar API and a very powerful feature so now let's go ahead and create the search filter so I'm going to go ahead and go uh for the search filter yeah hm uh let's do it inside of the component here let's call it agents search filter dsx import the search icon from lucid react import the input component from components UI input and import use agents filters from hooks export const search filters search filter extract the filters and set filters from use agents filters return a div with a class name of relative render the input component here give it a placeholder of filter by name give it a class name of height 9 background color of white width of 200 pixels and PL of 7 give it a value of filters and on change grab the event and call set filters just as you would set state and set the search value to event target value and then add a search icon from lucid react make sure you add this import here and add a class name size for absolute left to top 1 and a half minus translate on the yaxis 1 and a half and text muted foreground great now let's go back inside of our agents list header here and let's go outside of this div here and add a div with a class name flex items center gap x2 and padding of one and render the search filter component and let's actually call it um agents search filter since the name is already agents search filter and render it here and now in here you should see a text filter by name and I want to bring your attention to the URL so this is my URL at the moment whoops let's go here this is my current URL http localhost 3000 agents when I type test you can see that it immediately changes to this it appends the test there and if I change this to test 1 2 3 so if I change my URL this time and press enter you will see that this is a two-way binding meaning that whatever I change in the URL will appear here and whatever I change here will appear in the URL and you're probably wondering what does the width default and clear on default do well this is simply to improve user experience so the default search is an empty string and in here we are telling it if you get an empty string simply remove this from the URL so we don't want a scenario where this is the URL it just looks weird why not just remove it so that's exactly what will happen if I clear this you can see that now my URL is back to the original so that's what the with default and clear on default options do perfect so now that we have that what we can do here is go back inside of the agents list header and now let's do this font is any filter modified and simply do double exclamation points and look for search then open a new function on clear filters and call set filters here search to be an empty string and page to be one and or we can use default page from the constants just so we avoid any magic numbers there we go and now we're after agents search filter open is any filter modified here and render a button component with an X circle icon from Lucid React and a clear text give the icon a size four actually no you don't have to it automatically gets size four if it's inside of a button make sure you have imported the button and X circle icon here and instead give the button a variant of outline size of small and on click on clear filters so now if you type something you can clear it with this great what we have to do now is we have to connect this with our actual agents view here and pass the search as an option here and we can do that quite easily by adding our filters hook so filters use agents filters like this and simply go ahead and spread the filters we don't have to even individually add search and then filters right we can simply spread all of them because we know that both search and page exist in the options so now by default it will use an empty string for the search and number one for the page but if you try this right now so go ahead and clear this and if you refresh you will get an error right unauthorized but if you try searching you will most likely be able to query the only problem is that when you refresh when this is like the initial state you will get this unauthorized error that's because I explained previously you need to match your initial load with your server component right so now we have to do the same thing here but how do we do that when we cannot access a hook here well they thought of that too what we're going to do now is we're going to go back inside of our modules agents and let's go ahead and add a new file called params.ts like this let's close all of this so just add params.ts here and I want you to go inside of hooks use agent filters and I want you to copy this keep both of them open actually go back inside of the params paste it here but add a forward slashserver import here go ahead and import the default page from constants here and export con filters search params page and simply copy everything that you had here so you can just copy these two like this there we go so search parse as string and this parse as integer and no need for use query states actually from the N server only these two there we go and then export const load search params create loader from Nooks server and pass the filters search params so now we have the equivalent for a server component now you probably have a question on your mind could we use find a way to reuse this like can we copy this somewhere and then use it here and use it here in the same time you probably can the problem is uh you would have to import everything from Nuk's server and I just haven't found proof that you can do that safely uh if you research yourself go to the Nuks documentation page maybe you will quite easily find an example where they show you that you can use Nuk's server in client components but I just don't want to teach you anything incorrectly so that's why I'm repeating myself twice once for the client and once for the server just to keep it safe so yeah make sure to just copy these properly so there isn't any mismatch because mismatch will continue to cause the unauthorized error right great so now that you have the params here go back to your not the view but go inside of the app dashboard agents page here create an interface here and what you have to do is add search params a type of promise and search params from nooks and you can import it as a type let's move it here and then go ahead and dstructure the props here grab the search params and then simply get the params from await load search params from modules agents params and pass in search params and then you finally have your params here or you can call them filters for example so you use the same keyword as on the client and simply spread the filters and now you have officially synchronized the server component and the client component you can see no more errors it now simply has the exact same state on the client and the front end no matter what I do I can properly query this no matter how I refresh no matter if I manually add search and do something and press enter no errors because the server component and the client component are synchronized by their initial query which is exactly what we wanted to achieve perfect and just one important thing to know uh load search params does not validate the search params just in case you were wondering right uh now let's go ahead and let's wrap this chapter up by adding pagionation because we just added search and now we also have to add pagenation so let's go inside of the agents view here and inside of the use agents filters let's also extract the set filters here and then just below the data table here let's add data pagination here it doesn't exist yet we're going to create it and let's prepare the props the page prop will be filters dotpage the total pages will be agents data whoops data total pages and on page change will be a function which accepts the page and simply calls set filters with the new page now let's go ahead and implement the data pagionation component here so I'm going to call this agents data uh pagion actually we can call it data pagenation tsx data-pagination here like that and let's first of all define our props page is a number total pages is a number on page change is a function which call which will set filters with the new page here and let's also import button whoops from add /components UI button let's export cons data pagionation here and let's dstructure the props page total pages and on page change here and let's return a div with a class name whoops flex items center and justify between then in here a div with a class name flex one text small and text muted foreground and simply write page then the number of the page of total pages but in case total pages is zero that will technically mean for the user page one internally on our server uh if there is no uh if there if there is no uh data at all then the total pages are zero there are no pages to be made but for the user it's weird to show them page zero that's still technically page one for them so that's why if we get zero we're just going to display the number one for the user and below this let's add a new div with flex items center justify end and gap whoops and space x2 and py of four in here let's add a button with the text previews and another button with the text next and now what we have to do is just assign some props to them let's set the disabled here to be page one for the previous and for the this one if page is equal to total pages or if total pages is equal to zero like this the next one will be the variant which is the same for both of them outline size small and then we're going to have the on click the first one or the previous one will have on page change math max one or page minus one so we are basically ensuring that we cannot go into negative page requests right the lowest one we can go to is page one and for this one on page change math min total pages otherwise page plus one this will basically ensure that we cannot go above the total pages i mean we cannot make a request above total pages and that's it that's our pagionation and now let's go back to the agents view and let's import this from components data pagination and there we go you can now see page one of one here and the previous and next buttons which are disabled in order to see the pagionation in action the best way is to go inside of the constants and simply change the default page size to be one or two and then you will see that you have the next page active so when you click next you will see the next set of results and take a look at your URL uh it should be showing page two so if I manually change this to page three it should load it should load the page three and I can go back previously and you can see when I do a refresh it stays on page two and there are no errors because we properly synchronized the client and the React server component so you can now bring this back to 10 you know just show the normal amount of data just you can always reduce it if you want to test your pagination amazing amazing job so you created a lot of components now which we are going to easily reuse for our meetings so we won't have to build all of this all over again uh specifically some components we are going to copy uh but some we're going to actually reuse that's why some of them in here have generic names like data pagenation and data table so we are later going to move these two into global components because they will be reusable uh but these ones aren't exactly reusable but we will be able to copy their code and then just uh build faster right uh if you want to you can make them reusable but sometimes I think two abstraction is not too good of a thing to do great so now that we've had this done let's just review we have modified agents get many procedure we added nooks we added UI for filters including the search input and pagionation and we synchronize React server component filters and client filters and now let's merge this so I'm going to go ahead and change to a new branch here 13 agents filters once I confirm I am on a new branch I'm going to stage all of these changes 13 agents filters as my commit message i will press commit and I will publish the branch there we go and let's go to GitHub let's create a pull request here and let's see what Code Rabbit has to say and here we have our code summary let's go through the walk through this update introduces pagionation and search filtering for agents leveraging the new Nooks dependency for query state management it adds constants for pagenation new hooks and components for filters in pagenation UI and modifies the agents query to support pageionated and filtered results and the root layout now wraps providers with a new Nooks adapter in here we have a detailed file by file change summary in here we have a sequence diagram uh diagram explaining our new filters here uh combined with the actual Nooks use agents filters so again if something is uh not clear regarding this chapter these kinds of diagrams come in very handy as you can see exactly what's going on so the user loads the page with search params the agents view components gets the filter state search and page using the use agents filters here we fetch the agents with those filters the agents server procedure then returns that in form of items total and total pages and then we render the page by clicking on the next or previous we update the page in query params and that triggers a data refetch with the new filters and no comments that means we did a very very good job so we can safely merge this pull request perfect once this pull request has been merged let's go back inside of our IDE let's go inside of our default branch in my case that is main and let's go ahead and hit synchronize changes right here and then you can go inside of your source control open the graph and confirm that you just merged the agents filters there we go perfect so that marks the end of this chapter amazing amazing job and see you in the next one in this chapter we're going to implement the individual agent page this () will include modifying the existing agents get one procedure creating the agent ID server component page adding a data table redirect on click creating the agent ID client view what we are not going to do is implement the actual edit and delete functionality we are just going to prepare the UI for that so let's start by modifying agents get one procedure as always ensure that you're on your default branch and feel free to synchronize changes before beginning just so you are sure that everything is up to date after that let's go inside of our modules agents server procedures and let's go inside of get one protected procedure here we can leave the input as it is the only thing that we are going to modify is the following in the wear we're going to add and we already have and imported from drizzlem let me just go back to my get one here and let me collapse this like this so it's easier to keep track of inside of this end query the first one will be to make sure that we are loading the agent for the ID that we pass in the input but the second one will be to ensure that the agents user ID is the same one as context whoops we need to extract context from here because this is now a protected procedure so make sure you change this to protected procedure if you haven't context.out out dot user ID so besides loading by the agent ID we are also going to confirm that this user has access to see that user ID and the way we do that is by checking if that user is the author the creator of that agent and then what we're going to do is if there is no existing agent let's throw new TRPC error which you can import from at the RPC forward/server and in here return a code not found and a message agent not found like that there we go and you can leave the meeting count to be a dummy number still we are later going to change it now that we have that let's go ahead and let's implement the agent ID page so we're going to go inside of app folder dashboard agents and create a new folder inside of square brackets agent ID be mindful of the capitalization here because the the way you write the variable inside will be the way you will access it so if you put a lowerase I you will need to use a lowerase I in the code if you put an uppercase I you will have to use the uppercase I so just be mindful let's create a page.x inside of here and let's go ahead and create an interface props and the params will be a type of promise and inside agent ID which is a string so this is what I was talking about it needs to be agent ID because we named this folder agent ID instead of square brackets right so then this will look like localhost 3000 forward/ aents and then 1 2 3 and then 1 2 3 will be the agent ID so it's basically kind of an uh unh hardcoded part of the URL so dynamic part of the URL that's the word I was looking for let's go ahead and do a default export here for the page let's add the props here let's get the params let's turn this into an asynchronous method and let's go ahead and dstructure the agent ID await params there we go uh now let's go ahead and do the prefetching so query client is get query client from tRPC server add TRPC from here as well and then just do void query client prefetch query like that and inside add TRPC agents get one query options and inside ID pass the agent ID there we go we have now prefetched this agent now inside of here let's render our hydration boundary which you can import from tanstack react query and also add dehydrate from here pass in the state here to be dehydrate query client just like that now inside of here go ahead and add suspense from React and error boundary from React error boundary so make sure to add these two now let me just properly align these for both of these give them a fallback and for now you can just write a paragraph loading error and then in here render the agent ID view and pass in the agent ID prop to be agent ID like this now let's go ahead inside of our modules agents UI views and create the new agent- id- view.tsx in here create a prompts accepting already the structured agent id so in here it's a promise in the params but in here we are passing it directly so we have it like this let's export const agent ID view here let's use the props here and let's get the agent ID and inside of here let's prepare the DRPC from use DRPC and let's prepare um I think that's it for now so let's just uh leave it like this and let's get our data using suspense query from tan stack react query here and pass in gRPC agents get one query options and pass in the agent ID as the ID like this there we go so now our use suspense query matches our hydration because this is the only prop we are sending perfect now that we have this we can go ahead and render out some information here so inside of here return a div with a class name of flex one py of 4 px of 4 md px of 8 flex flex column and gap y of four and you can just JSON stringify data null and two so now make sure to mark this as use client as well go inside of the page and render the agent ID view from modules there we go so now you still don't really have a way of accessing this because clicking on this does nothing so we created the agent ID page and now we have to add data table redirect on the click here so let's go ahead inside of our modules agents agents view go ahead and add a router from use router from next navigation here and then in the data table besides having data and besides having the columns also add on row click here you will get the access to row information and do router.push here open back text slash agents and then row id so now when you click on an individual agent let's just do a hard refresh and click here you will get redirected to the following URL agents and then the agent ID so I can double check that let me just refresh my neon uh tables here if I go inside of my agents here let's just wait for them to load this is the agent that I clicked on f9 vis and I can see that's exactly what's inside of my URL so your URL should look exactly like this because that is the exact structure we have defined in here agents agent ID right so agents agent ID and in here we have the JSON information about our agent now let's go ahead and let's build the proper loading and error states so let's go back inside of our agents module UI agent ID view and we can actually borrow the agents view states here so copy these two exports the loading and the error go inside of agent ID view here paste them and let's rename this so this is agent ID view loading and this is agent ID view error import the loading state from components loading state and import the error state from components error state this will be loading agent and this will be error loading individual agent like this make sure you've imported the loading and the error state now that you have these two you can go inside of your page here and we've added this placeholders so now let's add the actual agent ID view loading and in here let's add agent ID view error components so all of them from the same import the agent ID view agent ID view error and the loading state so now when you do a refresh here you will see how it looks like and if you try and change the ID to something gibberish you will get the proper error state you might run into that infinite loading error but it's going to resolve itself in a few seconds and it will show error loading agent perfect oops let's go to the agents here and just select some proper agent now so you can see the data now let's go back inside of the agent ID view component so instead of our modules agents UI view agent ID view the client component here where we stringify the data and instead let's render the agent ID view header component let's go ahead and pass in the agent ID here to be agent ID let's pass in the agent name to be data.name and let's pass in on edit here to be an empty arrow function and on remove here to be an empty arrow function as well now let's go ahead inside of the components and let's create agent ID view header dsx there we go and inside of here let's prepare our props agent ID agent name on edit and on remove now let's go ahead and export const agent ID view header let's go ahead and destructure these props here so that's agent ID agent name on edit and on remove inside of here we are going to return a div with a class name flex items center and justify between and now inside of here we're going to add the breadcrumbs so this is a component that we already have so you can go ahead here and import all of these from components UI breadcrumb the breadcrumb itself item link list and the separator so this is a shatzian component and it exists inside of source components UI breadcrumb now let's go ahead and use it to render out our header and we can actually import agent ID view header here simply so you can see what you're doing right so right now nothing is visible and now we're slowly going to add some more information here so open up the breadcrumb inside open up the breadcrumb list inside of it a breadcrumb item and finally the breadcrumb link give the link as child prop and a class name font medium and text extra large inside use an actual link from next link like this give this an href of forward slash agents and in here write my agents like this so now you have a text which says my agents and when you click on it you are redirected back to the agents page so you can see when you click on something you will have this left perfect now let's go ahead outside of this breadcrumb item and let's add a breadcrumb separator here and let's add a chevron right icon let's go ahead and give this a class name i mean the breadcrumb separator so let's give it a class name of text foreground text extra large font medium and target the SVG using this method here SVG size four like this make sure you have imported the chevron right icon from Lucid React then after the separator here you can copy the breadcrumb item like this and the link inside and change this to have a text of foreground like that and the href will be open curly brackets replace these with back ticks and you will go to agents agent ID and inside you will render the agent name like this so when you click on it you are already in here but it's I think it's semantically correct to do it this way right so you can now go back to your agents and you can see the name of the current agent you're on there we go perfect so now let's go ahead and import our uh drop-down menu from components UI drop-own menu import drop-own menu trigger drop-down menu item and drop-down menu content and also import button from components UI button also import trash icon and pencil icon and more vertical icon all from lucid react now let's go ahead uh after our breadcrumb ends let's open a drop-down menu and this is important give it a model false without model false the dialogue that this drop-down opens causes the website to get stuck or maybe precisely uncclickable right so that's why we need model false because our drop-own menu will open models the edit model and the delete module so that's why we have to not do double model otherwise the website will be in this weird hanging state so let's add drop-own menu trigger here button mark this as child give this a variant of ghost inside more vertical icon and outside of the trigger add a content give it an align of end drop-down menu item on click on edit and a pencil icon with a class name of size four and text black and the text of edit duplicate this change the on click to be on remove this will be delete and trash icon so the reason I'm typing text delete but using remove keyword is simply because delete is a reserved uh syntax in JavaScript so that's why I'm using remove internally but delete on the user side so now in here as you can see you have a nice dropown for editing and deleting currently they do nothing we're going to implement that later perfect now we can go back inside of the agent ID view here and below the header open up a new div with a class name background white rounded large and border inside of here open a new div with a class name px4 py 5 gap y of 5 flex flex column and call span of five inside of here a div with a class name flex items center and gap x of three let's render our generated avatar component which is a self-closing tag make sure you have imported it from components generated avatar go ahead and give it a variant of bots neutral and a seed of data name and a class name of size 10 below it an H2 element rendering the data name give the H2 element a class name text to Excel and font medium like this and outside of this div render a badge from components UI badge so make sure you import it from here and not from Lucid React because sometimes u IntelliSense imports it from there give this batch here a variant of outline and a class name of flex item center gap x2 target the SVG and give it a size of four inside render the video icon make sure you have it from Lucid React and go ahead and render data meeting count so inside of our procedures get one we added meeting count in the select with a mock number five so later we're going to change it to the actual meeting count but I'm just showing you this in case you don't have it you need to add it so that you can access it here in the agent ID view so now that you have the meeting count here go ahead and check if data meeting count is equal to one render meeting otherwise meetings like this there we go outside of this render a div with a class name flex flex column yeah y of four and two paragraphs first one with the label instructions and the bottom one with the actual data instructions give this one a class name of text large and font medium and this one a class name of text neutral 800 and there we go now let's just give this video icon here a class name of text blue 700 perfect so this is our agent view you can see that it matches exactly what we see here but in a different layout and now in the next chapter we will be able to edit it and to delete it great amazing i think that's all we wanted to do here let's just see this error that I'm having here it looks like I'm not using more vertical that's right because I'm using the more vertical icon okay so basically I added an invalid import here perfect so I think that's it for this chapter everything seems to be working just fine uh and obviously this is not in sync now this shows six and this shows five so I'm going to change that later when we actually do the proper calculation so we've added this and we've added this and now let's merge this so I'm going to go ahead and create a new branch with the name 14 agent page i'm going to stage all changes once I am on the new page here I will add a commit message and I will publish the branch and now let's go ahead and open a pull request and let's see what our code reviewer has to say and now let's read our code summary we introduced a detailed agent view page with loading and error handling states we added a header component for the agent date detail view featuring breadcrumb navigation and an action menu with edit and delete options we enabled navigation to an agents detail page by clicking on a row in the agents list we also improve data security by ensuring only agents owned by the current user can be accessed so this is referring to us modifying the get one procedure in here we have a more in-depth walk through we have a short sequence diagram explaining how when the user clicks on an agent row we access the agent view we use router push agents agent ID to get to the agent detail page in here we load the agent detail page using a react server component and then we do the uh we basically fetch the agent data later on but we have it in the cache so it's much faster and then we return agent data or error and depending on that we show either the agent details loading or the error UI and it also noticed a related PR here for our agents setup so it's pretty cool how it keeps context of all of our previous work so it knows what we are actually developing and in here uh we have a request from them to uh verify that we know what we are doing because we set the model to false so you can see that when you add a comment uh it doesn't tell you that you made a mistake it just asks you to verify so pretty nice uh noticing of the comment here and of course it tells us to add a proper comment here to implement this and not just leave it like that and that's exactly what we will do in the next chapter so let's go ahead and merge this pull request and once you've done that go ahead inside of your main and synchronize the changes after that go inside of your source control open the graph and confirm that you have just merged 14 agent page perfect amazing amazing job and see you in the next chapter in this chapter we are going to () implement update and delete functionality for an individual agent this will include adding agents procedure agents.update update procedure and the actual edit and delete UI so let's start with adding these procedures as always ensure that you're on your default branch and feel free to synchronize the changes to ensure that you're up to date after that let's head inside of our modules agents server and inside of the procedures and let's implement the remove procedure so this will be a protected procedure and it's going to have a input of Z.Object and simply accept ID which is a type of string add a mutation destructure the context and the input let's go ahead and get the removed agent here by using await database.delete delete agents where do and go ahead and add and the first one will match the agents ID for the input ID and the second one will confirm that the agent's user ID is the currently logged in user so that only we can remove this user and no one else go ahead and add returning here if there is no moved agent here throw new TRPC error code not found with a message agent not found otherwise return the removed agent back to the client perfect now let's go ahead inside of our modules agent schemas and in here let's export con agents update schema and let's reuse the agents insert schema and simply extend it by also requiring an ID give it a minimum length and a message ID is required like this now let's go back inside of our procedures here and let's implement the update protected procedure so the update protected procedure will have an input of agents update schema make sure to add this import and in here add a mutation asynchronous destructure the context and the input here let me just move this comma to this place and you can obtain the updated agent here by using await database update agents set everything in the input where and you can just copy the same logic as here so the matching agent ID with the matching author and make sure to put returning here if there is no updated agent you can throw the same error as here agent not found and then return updated agent and just like that we have implemented our procedures let's go ahead and mark them as complete now let's go ahead and implement the delete UI as it is a bit simpler so what I want to do is I want to go inside of an individual agent here and I want to go inside of the agent ID view so inside of modules agents UI views agent id view and in here let's go ahead and prepare some things let's set the router to be use router from next navigation and let's add query client to be use query client front stack react query so I'm just going to move this here there we go make sure you have added use query client and use router from next navigation and then what we're going to do is we're going to add a remove agent method by using use mutation so make sure you have imported use mutation from tanstack react query inside of the use mutation go ahead and pass TRPC.agents and open up mutation options inside of the mutation options here oh and let's just see uh looks like I have accidentally been doing this let me just fix this use mutation use query client use suspense query okay uh I think that's all I need yes perfect so let's go back inside of the remove agent here and let's add on success here to do the following let's use query client invalidate queries and the first thing we want to invalidate is our get many and add query options here and pass in an empty object inside then I want to invalidate uh something that we don't yet have so I'm just going to add a comment to do invalidate preier usage and after we've done that let's do router.push forward slash agents like this and you can mark this as async and then you can mark this as a wait so it will push after it invalidates the query and on error here obtain the error and do a toast which you can import from soner so move it here toast dot error error dot message and just like that you have implemented the remove agent method so if you want to technically you could already uh call on remove here so you could do remove agent mutate and pass in the IG to be agent ID so for example if you were to do this delete and try one more time because I have two of them with the same name there we go so there it's definitely working right the problem is there is no confirmation right the moment you hit delete it immediately deletes so if you if you are fine with that no problem but I want to go a step further and I want to add the confirmation message so let's go ahead inside of source hooks and create use-confirm ts actually tsx it's important to be tsx import jsx and use state from react import button from components UI button and import responsive dialogue let's export const we will accept a title which is a type of string and a description which is a type of string and we are going to return the following a JSX.element and a promise unknown let's go ahead and return that now first of all let's set the promise and set promise to be use state here and let's set it to null by default let's give the use state a following value open an object and write resolve a function which accepts the value which is a boolean and returns a void so it can either be that instead of an object or it can be null there we go so that's our promise state now let's add the confirm method in here very simply return new promise grab the resolve from here and set promise to resolve like this then do const handle close in here set promise to be null create a const handle confirm in here check if the promise exists and resolve it with true and do a handle close and finally let's do con handle cancel which is an explicit no so let's resolve this whoops with false and handle close so we are basically creating a system where the user can answer yes or no for a specific action and the you and then a developer will be able to await the result from this hook and get either true or false and depending on that we can call the delete method or we can close the model for example so it's going to be a highly reusable hook for asking the user for confirmation and let's now do a const confirmation dialogue here and let's actually render this so responsive dialogue like this let's pass in the open to be promise not null on open change to be handle close title will be title description will be description inside of it open a div with a class name adding top four full width flex flex column flex column reverse gap Y of two LG flex row my apologies this is not flex call remove this so just flex column reverse but on large devices it's going to be flex row gap x2 items center and justify end inside of here add a button cancel and below it confirm for the cancel button give it an on click of handle cancel variant of outline class name of full width on LG with auto in here let's copy these attributes and paste them here change the on click to be handle confirm remove the variant and just leave the class name and finally return the confirm dialogue and the confirm method in an array and you should have no errors here because we correctly matched all the types here so let's finally see how this will be used agent ID view let's go back here and let's go ahead now and do the following so after remove agent let's do const use confirm from hooks use confirm and let's go ahead and give the first prop are you sure and let's go ahead and do description the following action will remove and let's do data dot meeting count associated meetings so when you remove an agent we're also going to remove all meetings associated with that agent so we want to let the user know that in here grab the remove confirmation and confirm remove method and then create const handle remove agent method grab it make it an asynchronous method and then you will get the okay from await confirm remove and this confirm remove will open the remove confirmation and only if the user pressed okay are we going to continue forward so if not okay break the method otherwise call await remove agent mutate async and pass in ID agent id and then go ahead and put this here and wrap the entire thing inside of square uh the entire thing inside of a fragment and render the remove confirmation here and you should have no errors now and now let's go ahead and click on an agent and let's try and remove it only if you click confirm and you will see it says five associated meetings because that's what we currently mock so if I click cancel nothing happens but if I click confirm it deletes the agent exactly what we wanted now let's implement the update agent dialogue so let's go inside of our agent UI components and let's copy the new agent dialogue and let's paste it here and let's rename it update- agent- dialogue before you edit it just double check that you are inside of it that you're not accidentally inside of new agent dialogue close that and go inside of update agent dialogue the good news is we made our agent form editable so it will also edit as much as it will create for the first time the problem is we don't have the update uh agent mutate added here so that's the only thing we're going to have to modify so now go back to the update agent dialogue and let's rename this from new agent dialogue to update agent dialogue change the title to edit agent and this will be edit the agent details like this and the only difference here is that we're going to have initial values here and that will be a type of agent get one from the types and it will be required right you cannot edit these if you can't load the initial values here so go ahead and pass the initial values which are optional for the agent form because it can be used both with or without them so let's pass them here now let's go inside of the agent form and let's copy the create agent here and let's paste it here let's rename it update agent and let's use the RPC agents.update update and let's see what we have to do on success here so we have to invalidate the queries get many that's true and then we have to invalidate the get one because we just updated that individual one and in here this is also true so if the error code is forbidden we redirect to upgrade i'm going to leave this purposely on to-do because if we implement it now sure it's going to work but I want us to wait until we actually implement upgrades so it all makes more sense when it happens right uh great so that's our update agent and now that I look at it our create agent actually does not need to invalidate get one because at this point it will never exist in the cache so our create agent doesn't need to do that but let's add a to-do invalidate free tier usage in the future when we have it we don't have it yet but we're going to have to do this for the free tier TRPC route we now have the update agent which means that we can now go inside of is pending and add it here so update agent is pending and in here instead of a console log we can now do update agent.mmutate here spread the values and also add ID from the initial values do ID there we go and I think that's all we need right because I think this will already show update so now we have to go back to the agent ID view here and we have to add a state so let's import use state from React great and let's just add this field here update agent dialogue open and set update agent dialogue open from new state with a default of false and what we're going to do now is simply below the remove confirmation let's add the update agent dialogue so make sure to import it and now let's go ahead and just pass some props to it here so that's going to be open update agent dialogue open on open change set update agent dialogue open and the initial values will be the data and there we go now on edit modify this in the header to be set update agent dialog open to be true and let's try it out so make sure you have at least one agent this one is called a new agent i will click edit here and there we go you can see how it autofilled all information and it says edit and it says update so a updated agent 1 2 3 let's try this let's click update and the moment of truth there we go seems to be working just fine and this is invalidated as well amazing we have officially wrapped up our agents entity the only thing left is to properly count the meetings we're going to do that after we add the meetings schema amazing so let's go ahead and see what we have to do we added edit UI and delete UI and now let's merge this pull request so I'm going to go inside of my graph as usual i'm going to click on my branch i will create a new branch 15 agent update and delete so 15 agent update delete once I'm on the new branch I will click plus to stage all the changes and I will write a commit message and let's click commit and publish branch there we go and then let's go to GitHub let's open a pull request here and let's see what our reviewer has to say so let's see what we've done in this pull request we added the ability to edit and remove agents including the edit agent dialogue and confirmation prompts before removal we introduced a reusable confirmation dialogue for asynchronous user confirmations this was exactly the goal with the use confirm hook we had some improvements like enhancing the agent form to handle both creation and updating of the agents with improved success and error handling perfect in here we have a more in-depth walk through and in here we have a sequence diagram explaining our uh editing dialogues and our confirmation removal dialogue right here in case you are interested and in here uh we also have a related PR agent page from our chapter 14 and we do have some comments here so this one recommends checking if the promise exists and resolving it but we don't have to do that because uh we do that uh using a different method we do it using on cancel so close by itself should not uh resolve the promise that's why it's okay to do it this way okay so I'm just going to resolve this and in here it simply tells us to track and resolve those to-dos in a future pull request and we definitely will perfect so that's it for the comments and let's merge this pull request and after you've merged the pull request you can go back to your main branch whatever is your default branch and synchronize the changes and as always go inside of your source control graph and confirm that you just merged that and here we have our use confirm hook perfect that wraps up this chapter amazing job and see you in the next one in this chapter we are going to () implement the meetings into our project this chapter will include setting up the schema module procedures and the meetings pages so let's start with our schema as always ensure that you're on your main default branch and go ahead and synchronize changes just to make sure everything is up to date after that go inside of database schema and in here to make things easier let's copy our agents schema let's paste it let's rename this to meetings let's rename the actual table name to meetings here the ID field stays exactly the same the name as well user ID reference exactly the same and then we can copy the user ID reference and simply add the agent ID reference and make sure to name this table agent ID and the reference will be to the agents do ID table besides the agent reference which also has the ondelete cascade meaning if an agent is deleted this meeting will be deleted too let's also add a status now the status will be a special enum which we have to create so let's go above here and create a con meeting status to be a type of pgnum from drizzle or pg core inside of here let's go ahead and add meeting status and open an array in here we're going to set upcoming active completed processing and cancelled now we can use the meeting status as our type for the status here meeting status column name status required and default upcoming like this we are not going to have instructions but what we will have oops what we will have is the started at and ended at timestamps so make sure to fix this this will be started at this will be ended at and they will not be required and we are not going to default them so just timestamps like this besides that let's also add transcript URL which is a type of text transcript URL copy and paste this and make a recording URL and add recording URL here as well and last one will be the summary which is a type of text summary so none of these fields here are required because all of these will exist only after we switch to completed mode right only after the meeting has been had will we be able to append the proper status started at ended at transcript URL recording URL and the summary great so make sure you have the agent reference make sure you didn't forget to change the name of any column here make sure none of them are repeating and now let's go ahead and push this to the database so I'm going to go ahead and do mpm run database push like this and this will add the new schema to our database and I seem to be having an error here meeting status does not exist so let's see what I did incorrectly here so pgnium meeting status uh first of all let's also add export cons here i think we need to do this as well simply because we are using the entire schema in some places uh but let's just save this file let's shut down our app and let's try again there we go so I'm not sure which one of these changes did it maybe it was the export maybe it was just saving the file again and shutting down the app but yeah just try one of those and try npm run database push again and uh no reason at all for this to fail great so now we have added our meetings schema now let's go ahead and let's add the meetings pages and the meetings module so I'm going to go inside of source app folder dashboard and I'm going to add meetings here and inside a page dsx page div meetings page just like this and inside of here let's add individual meeting ID page DSX another page here and a div meeting ID page there we go so now that we have added this we can go ahead and do npm rundev on our app again and we can go to localhost 3000 here wait for it to load and we can now click on the meetings and we will see the meetings page and if I manually change my URL to forward/meings123 I will see the meeting ID page so let's go back to the meetings page and now let's implement our module so that we can actually see the JSON of our data so let's go inside of modules here let's create meetings and inside of here let's create the server module and inside procedures ds let's keep our agents server procedures open so we can copy and paste and speed things up so let's start by copying everything and pasting in in the new meetings procedures here and let's rename this to be meetings router and for now let's remove update and let's remove basically all except get one and except get many so that's the only thing we are interested in we are later going to adapt the create update remove and uh similar ones there we go so meetings router now let's go ahead and improve the get one procedure here so get one is a protected procedure it's looking for ID instead of existing agent it will be existing meeting here and it's not going to have a meeting count so you can remove that and you can leave this as it is and it will be from meetings so you have to change meetings in all instances here the easiest way to do that is to simply remove the agents imports you will have errors and you will know all the places you have to fix things there we go so everything's exactly the same existing meeting existing meeting and meeting not found for the get many similar let's go ahead and remove this leave this to be meetings from meetings meetings user ID meetings name equals the search order by meetings created at meetings ID and the total is counting the meetings with the same query here so luckily the fields are exactly the same so we don't have any issues here whatsoever and we can remove the SQL import here we go so we have a dead simple um get many and get one procedures here now what we have to do is we have to go inside of the RPC router And we have to add meetings router from modules meetings server procedures and call this meetings like this now let's go to our page tsx inside of our meetings here and in here let's return meetings view let's build the meetings view quickly by going inside of our modules meetings and let's create the UI folder let's create the views folder and let's create meetings-view tsx market as use client export const meetings view like this and inside of here go ahead and do the following prepare TRPC from use DRPC from the client prepare data from use query from tan stack create query pass in the TRPC meetings get many query options and simply pass an empty object here and in here do JSON stringify data question mark dot items like this or you can actually stringify the whole beta right it doesn't matter now let's go to the page and let's import meetings view from modules meetings UI views meetings view so now when you hit the meetings page you will see the empty state right here now let's go ahead and just add some data here so you can either visit the Neon console or you can visit the Drizzle Studio here so we can go inside of our project here go inside of the tables and let's just add something again if for whatever reason you can't do this no worries because we're going to create the uh the form for creating meetings in the next chapter so go inside of meetings add record um yeah you would now need to uh let's discard the changes so you need to have at least one agent and just you know paste the ID here grab a user for example whoever you are logged in with right and just paste that user ID here and then go inside of your meetings and add a new record for the ID you can just write demo for the name this can be first meeting and then for the user ID you will copy your user ID and add it here for the agent ID copy it and add it here as well and for the status you can use the default and I don't think you have to fill anything else here so just click save change there we go and now we have proper relations with that user and with that agent again if you fail at doing this no problem at all we will create it in the next chapter the actual form for doing this but there we go you can see that it works we can now see our data here perfect so what I want to do now is I also want to enable the prefetching here just so we don't have to do it later so let's go ahead and do the following inside of our meetings page let's go ahead and let's grab the query client using get query client like this let's execute it and let's do void queryclient dot prefetch query and inside pass in tRPC from tRPC server meetings get many and pass in an empty object for the query options like this so now we are prefetching that now let's go ahead and let's add our hydration boundary from tanstack react query in here let's add the state to be dehydrate from tanstack react query and pass in the query client like that there we go now our page is hydrated and prefetched so what's missing is the suspense here from react and besides suspense the error boundary from react error boundary now let's go inside of the meetings view here and let's borrow from our uh agents module UI views agents view let's copy agents view loading and agents view error and let's paste it inside of our new meetings view so let's rename both of these well all of these instances to meetings so meetings view loading loading meetings meetings view error error loading meetings and import the loading state and import the error state like this there we go and now in here we can use a fallback meetings view loading and in here we can use meetings view error there we go so I'm just going to align all of my imports here there we go move this here so you need the meetings view meetings view error and the meetings view loading there we go which means that now in the actual meetings view instead of using use query you can use use suspense query and that will trigger the suspense there we go so now when you refresh here you will see loading meetings and if you go ahead and try and throw an error somewhere in here for example throw new TRPC error code bad request and refresh you might encounter this maximum uh depth infinite loop thing but after it settles down or after you do a couple of refreshes and try again it will eventually uh simply render the error let's give it a second there we go perfect so I think that's exactly what we wanted to do in this chapter simply introduce our meetings and prepare the basics and we did it quite faster than the agents simply because we had a lot of things to copy from so now let's go ahead and let's create a branch from this and let's merge it so I'm going to create a new branch here and I'm going to call it 16 meetings setup let me just confirm that is our topic it is perfect let's go ahead and stage all changes and let's write our commit message meetings setup let's click commit and let's publish the branch perfect now let's go to our GitHub let's open up a pull request and let's see what code rabbit has to say about our code and here we have our summary we introduced a meetings dashboard page with loading error and data display states we added a dedicated page for viewing individual meeting details meetings data is now fetched and displayed including support for pagination and search simply because we copied the get menu from the agents procedures perfect so in here we have a more in-depth walk through and in here we have a sequence diagram which is identical to the one for the agents so we didn't have to go through it because we didn't really add anything new later when we actually add some new filters it will be interesting to look at how it handles that here perfect and in here it has some comments obviously we didn't do anything for the meeting ID page we will have a chapter for that but you can see how it knows exactly how it's supposed to look like so it even knows the new TRPC syntax this is very impressive because it actually reads from our code because this new TRPC syntax is not something that AI completion models actually know perfect um in here it tells us to add pagination parameters we will add that later when we add the data table and all the filters and in here of course it tells us to add the actual data table we will do that in the next chapter uh and in here it tells us to add UID validation for get one this is interesting but it's actually not correct because we are using nano ID if you go inside of the schema here we are using nano ID so using UU ID for the validation would be incorrect in this case perfect and in here it adds some additional validation but I'm okay with the way we are using it right now perfect so let's go ahead and merge this pull request right here and let's go ahead and go back to our main branch here and let's click synchronize changes here and there we go that adds the meetings here go inside of your source control graph and confirm that you just merged chapter 16 meetings amazing amazing job let's mark this as completed and see you in the next chapter in this chapter we're going to develop () the meetings form so this will include creating the meeting list header which will use the text my meetings and the new meeting button and also the actual form where we will be able to select an existing agent let's start by creating the meetings create procedure as always ensure that you're on your default branch and that you have no unstaged changes now let's go ahead and copy agents server create procedure simply so we speed things up so I'm going to copy the entire procedure here and then I'm going to go inside of my meetings server procedures and then at the top here right above the get one I'm going to paste the create procedure so now let's go ahead and let's actually create the meetings insert schema so we can also help ourselves by copying the agent schemas and pasting it inside of meetings let's rename the agents insert schema to be meetings insert schema here and it will be a name and agent ID and this will be agent is required and for the meeting update schema we are going to extend the meetings insert schema with an ID like this now we can go back inside of the meeting server procedures and instead of agents insert schema we now have it meetings insert schema from dot dot / schemas instead of having a created agent we are going to have created meeting in this procedure here and instead of inserting agents we will be inserting into meetings the input can be spread like this and we assign the user ID manually and simply return the created meeting here and that's it that's all we need for our uh create procedure for now because there will be just one more thing we're going to have to do here to do create stream call upsert stream users so later when we add video call SDK we're going to have to do that here in the create procedure that's why we are adding a to-do here perfect so we can mark this as completed now let's build the list header component and we can also help ourselves here by copying the agents UI components agents list header let's go ahead and paste that inside of meetings UI create a new folder called components and paste it inside instead of agents list header this will be meetings list header like this and now let's go ahead and do the following let's remove the new agent dialogue from here let's remove agents search filter and let's remove use agent filters so we can remove this and we can remove this and this basically we're just building the UI now so this on click for now can just be an empty arrow function and then we're going to easily add it later so you can also remove these things here as well to do filters remove this this and this double check that you are doing all of these changes in the meeting list header and not accidentally in the actual agent list header and now rename this to meetings list header and this will be my meetings and the button will be new meeting here now let's go ahead inside of our app folder dashboard meetings page and let's wrap this hydration boundary inside of a fragment and let's go ahead and render the meetings list header component like this from the modules and while we are here let's just mark this as an asynchronous function and let's also copy our protection here so let's grab the session and let's do a redirect here so simply add that here in the meeting page so meetings page import out from lib out and headers from next headers and redirect from next navigation so you should have all of these added there we go so now our route is protected and when I refresh the meetings it should now render the meeting list header above my JSON data here so we have this bug here because it's extending our view so what we can do for now is go inside of the meetings view component here and just write to-do data table here and you can leave this error to stay like that there we go so now you have a much normal uh look here now I want us to create the new meeting dialogue let's go ahead and copy from the agents here in the UI components we have the new agent dialogue let's copy that and let's put it inside of meetings UI components let's go ahead and rename this from new agent dialogue to new meeting dialogue let's go ahead and rename the instances of agent to meeting so new meeting dialogue you can remove the form import from now and in here you can add to-do meeting form change the title to be new meeting and this will be create a new meeting there we go now let's go back inside of our meetings list header here and let's actually render the new meeting dialogue component fromward/ new meeting dialogue because they are in the same components folder in the meetings module and now we have to add back our use state here is dialogue open set is dialogue open from use state from react with a default value of false and then in here give it an open of is dialogue open and an open change of set is dialogue open and in here simply set is dialogue open to true so now when you click on a new meeting you will see new meeting pop up and on a mobile this will be a drawer there we go now we have to implement the meeting form in order to do that I also want to add the update procedure already simply because it's simple to do and we will able to be complete the form both for update and for create status so let's go ahead inside of modules agents server procedures find the update procedure and let's go ahead and copy it because it's going to be quite similar so now let's go inside of our meetings server procedures and above our create let's now add our copied update protected procedure so we can now import the meetings update schema which we uh created a moment ago by extending the meetings insert schema here instead of updated agent agent it will be updated meeting and we are updating the meetings which means that in the wear clause we are looking for a matching meeting ID and a matching meetings user ID if we cannot find if we uh we're unable to find the updated meeting that means that meeting does not exist for this specific query maybe the user doesn't have access to it we're just going to throw all of that under not found and let's return back updated meeting as simple as that make sure you're using update and set here perfect so now we have the update procedure as well which means that we can now go inside of the agents module UI components and we can now copy uh the new the agent form so let's copy the agent form go inside of meetings UI components paste it here and let's rename this to meeting form and now let's go step by step and let's simply uh fix these things so in here the agent form will be meeting form so rename this to meeting form and use the props here now let's fix the schema and the type so let's go ahead and copy from agents their types here let's paste them inside of the meetings module make sure you're inside of the modules meetings types here and in here change this to be meeting get one and in here use meetings get one so make sure that you have implemented inside of our meetings router get one protected procedure which is something we did in the meetings setup chapter alongside get many if you haven't it's a very short procedure and you can implement it now great and now when you hover over meeting get one you will see the exact meeting fields inside perfect so let's replace this with meeting get one from dot dot/ do/types and I seem to be having some error here or maybe I just need to try again there we go now it's working and in here we are using the meetings insert schema now let's go ahead and actually append that schema in our form here so type of off meetings insert schema so the resolver is using the meetings insert schema and we now also have to properly add the form here so the name will be initial values name and the agent ID will be initial values agent ID and also use the meetings insert schema right here obviously this will now cause errors because we have not changed the mutations here so let's start with create agent it's actually going to be create meeting instead of TRPC agents create it's going to be TRPC meetings.create like this and for invalidation we are going to invalidate meetings get many like this and also to do invalidate free usage and on error here toast the message and redirect to upgrade so exactly the same now let's change this to update meeting use meetings update and reinvalidate meetings get many and reinvalidate meetings get one when we update it like this and all other to-dos stay exactly the same perfect so now what we have to do is we have to modify the instances of create agent to be create meeting and update agent to be update meeting and that also includes right here update agent and create uh update meeting and create meeting and there we go no more type errors because everything is perfectly type safe now let's go down here and now we have to fix this form field because inside of here it says to use instructions but that's not true we will not be using instructions so we can remove this form field for now and we can remove the text area import so now you have a completely uh valid form which you can go ahead and add to the dialogue so let's go back inside of our new meeting dialogue here and let's go ahead and import meeting form from forward slashme form and let's also add a router from use router from next navigation here like this and inside of here let's add the meeting form and let's go ahead and add on success here to accept an ID call on open change to false and do a router push to forward slash meetings and then that meeting that we just created so we immediately open it up in case the user immediately wants to start it and add on open change here now we're going to have to do a slight modification instead of the meeting form here so go inside of meeting form and simply allow on success to accept an optional ID of string like that there we go and then instead of create meeting here on in the onsuccess you can pass that so for example pass in the data and data do ID and then the on success will now respond with the ID and we can redirect to that meeting ID you could have also done that here immediately but since we have a call back let's use the call back so now when you refresh here you will see uh that you have a new meeting here with the name here but we also render the avatar so let's quickly fix that let's go inside the new meeting form let's find the generated avatar and let's remove it entirely and let's remove the import for it so this is how it's supposed to look like now let's go ahead and let's give this a proper placeholder so this first input instead of being a math tutor let's for example uh call this uh math consultations like this now we need to add one more field to new meeting and that is the option to select an agent so the way I'm going to do that is by implementing a new component called command select this way it's going to be a type of select which is responsive on mobile and a model on desktop devices so let's go ahead and do the following let's import react node and use state from react let's import chevrons updown icon from lucid react let's import CN from lib utilus and button from components UI button and let's import the following from components UI command command empty input item list and responsive dialogue now let's go ahead and create an interface props here first of all let's create an array of options so we are going to accept options which are going to be an array of objects which accept an ID value and children using the React node import from above besides the options we're going to have two functions on select which accepts the value and on search which which is an optional function which accepts the value we are then going to have an actual value and three optional props here placeholder is searchable which is a boolean and class name which is a string then let's export con command select here and inside of the props here let's assign them and let's go ahead and destructure all of them here options on select on search value placeholder and class name and let's give the placeholder a default value of select an option now in here let's create a state open and set open use state with a default value of false then let's get the selected option here to be options.find get the option and compare if option value is identical to the current value that the user selected that's how we will find the selected option inside of here go ahead and open a fragment return a button inside of a button add a div which is going to check for selected option question mark children or simply render a placeholder if selected option was not found this div right here I mean below it add chevrons updown icon for the button itself give it a type of button so it can safely be used inside of a form variant of outline class name of CN default classes will be height 9 justify between font normal and px of two then we're going to have class name whatever the user passes and actually above that let's add if there is no selected option so make sure you put the question mark before it in that case it's going to be text muted foreground like this so we are transforming make a button to behave like a select and then what we're going to do outside of the button we're going to render the command responsive dialogue component inside of here let's add open to be open let's add on open change to be set open inside of here let's add a command input with a placeholder of search and on value change on search below that add a command list add a command empty which will render a span no options found and give the span a class name of text muted foreground and text small below the command empty let's iterate over all of our options here render the command item here and inside render option dot children give the command a key of option do ID and on select call on select with option do value and set open to false that's it we will have to do one more thing but first I want to demonstrate how this currently looks like so we have an easier time [Music] understanding so I want to go back to the meeting form where we added the math consultations input here and let's go ahead and do the following above all of this let's add our agents and let's load them so this time we are using use query because we don't know where we are going to use this model so we cannot guarantee with use suspense so we're just going to use the good old use query here inside call tRPC agents get many query options set the page size here to be 100 and set the search here to be const agent search set agent search and use state empty string and import use state from react like this then also add const open set open use state false and in here add the agent search we are basically increasing the page size to 100 and we are allowing the user to search through the agents so this will this will be a better user experience than a drop-own select because this way they can actually filter through all of the agents they might have and they can also be more specific with the search query ensuring that we load them in this large data set perfect so now that we have this let's go ahead and let's import the command select component which we've just created and let's also import generated avatar component and now let's go ahead and let's copy our form field for the name and let's paste it below here let's change it to be agent ID and change the form label to be agent and inside of the form control you're going to do the following you will render the command select option you will pass in the options here open parenthesis agents data question mark items or fall back to an empty array dot map get the individual agent here and immediately return an object add an id to be agent ID value to be agent ID and then children to be a react node which will be a div with a generated avatar inside a class name of flex item as center and gap x of two give the generated avatar a seed of agent name variant of bots neutral class name of border and size six and below that a span rendering the agent name like this and then let's add some more options to command select which will be on select to be field on change on search will be set agent search so basically it's going to be controlling this state here which will then re-trigger this call every time it changes and value field do value and the placeholder will be select an agent so the only thing we have left unused is the open and set open we're going to use that in a moment but now when you click on this uh it should open the command but looks like we did something incorrect so let's go back instead of the command select here uh and let's see what we did incorrectly in the button let's add on click here set open set to true so this is referring to the internal set open of the command select not to this is open so now when you click here you will see a list of your agents and you will be able to select them so if you go inside of your agents here for example and create a new agent click create go back to your meetings click new meeting you will find it here and if you search for new you will be able Oh yeah so right now it's not working because we didn't uh properly implement the filtering inside of the command but it's quite easy to do that what we actually have to do is we have to turn off the way command component filters by itself so in order to do that we're going to pass the prop should filter to be the oppos to be the opposite of our on search value so if we have on search in that case it's going to be false but if we don't have it it's going to be true but we are getting an error for it which means we have to go inside of the command responsive dialogue inside of source components UI command find function command responsive dialogue and simply add a new prop here should filter and set it by default to be true go ahead and map it here so should filter is an optional boolean like this and simply go ahead and in is mobile add it to this command so should filter you can see the prop exists and pass it here and make sure to also do it in here there we go so now our command select will not use the internal filtering instead it will use React query search so when I try this again and write new you can see how it loads that new agent right so it's actually doing an API call in the background here or updated that there we go when I click here I can select the agent amazing amazing job so now when I click test here and click create we should be able to create a new meeting uh and I am redirected to that meeting ID page immediately so this is my URL right now there we go perfect so if you want to uh you can enable inside of your meetings view the data JSON JSON stringify data let's just give it a class name overflow X scroll so it doesn't move our content too much well it still moves it but you can see uh our items total says two if I go ahead and create a new one right here go back to the meetings now it says total three so we are successfully creating new ones right just make sure to scroll here in case your button is disappearing and you can now you know comment it out so you can see it here normally one more thing we have to add here is a text uh if the user never created an agent so they have a quick way to create it and we already have the dialogue for that so inside of the new meeting form let's change this to be a bit more precise so open agent dialogue open new agent dialogue and set open new agent dialogue so we are specific about what this is and then we're going to go ahead and find our agent ID form field and after form control let's add form description here and make sure to import this from components UI4 inside of here we're going to ask not found what appos your My apologies not found what like this you are looking for you can add a space like this go to new line and render a normal button here create new agent give this normal button a type of button this is very important a class name of text primary hover underline and on click we'll very simply call set open new agent dialogue to true currently this doesn't control anything so what we have to do now is we have to actually use it so let's go ahead inside of here let's go wrap our entire form in a fragment like this oops in a fragment and then here simply render the new agent dialogue and pass it open to be open on open change to be set open new agent dialogue and this will be open new agent dialogue make sure you import new agent dialogue component from modules agents UI components new agent dialogue so now in here you have a quick button to create a new agent here and for example right now it doesn't exist here so if I go ahead and create new one click create it automatically invalidates the get many query so it immediately appears here and we can create it amazing amazing job so I think I've noticed one little bug here which we're going to do in the next chapter and that's if I search for something and close it and open it up again uh you can see it stays in that weird state so I'm going to look into that and fix it in the next chapter but you just wrapped up the new meeting form so we can now create new meetings what we're going to do in the next chapter is actually display them and filter them now let's go ahead and let's create review and merge the pull request so this chapter is called 17 meetings form so I'm going to create a new branch here 17 meetings form once you're in the new branch go inside of your source control mark all of these changes as staged changes and add a commit message 17 meetings form let's click commit and let's publish the branch once the branch has been published let's go ahead and open a pull request here and let's see what code rabbit has to say about our code and here we have the summary so we introduced a couple of new features including a customizable drop-down select component with search capabilities so that's our new command select component we added a header section with a new meeting button and a dialogue for creating messages my apologies meetings we implemented a form for creating and editing meetings with validation and agent selection using the command select component and of course a model dialogue for creating a new meetings with navigate on success here so let's go ahead and go through this sequence diagram we're not going to go through entire sequence diagram we're just going to go through this what happens when we click on a new meeting so the user clicks on a new meeting in the meeting meetings list header component after that we open the dialogue which renders the form meeting form and once we submit that form we create it through our server procedures here and we validate the data the server procedures return the created meeting and then we fire the on success where we close the dialogue and we redirect the user to the new page which is the meeting ID page perfect and down here we have some actionable comments here to complete these to-dos which is completely valid but since this is a tutorial I'm not going to do them right away i will do it when it makes sense so you see why we are doing it so I will close this uh in here it suggests adding the is loading for our command select that's something we can consider later and in here it found a bug which we have to fix so right now our new meeting dialogue does not cancel properly so I think you can actually try that if you click new meeting and click cancel nothing happens so that is because inside our new meeting dialogue here we didn't call on open change properly we need to pass false to it like this so what I'm going to do now is I'm going to do that in the second chapter simply because in case you already merged it right so I don't want to cause you any problems we're just going to do it in the next chapter in the new branch but this is a bug found by code rabbit i have completely missed this great job so let's go ahead and merge this pull request as it is right now and once it's merged let's go ahead back inside of our main branch here and let's click synchronize changes let's click okay and then everything should be fixed let's click on the source and go inside of the graph and we just merged 17 meetings form amazing amazing job that marks the end of this chapter and see you in the next one in this chapter we are going to () implement the meetings data table this will include modifying the procedures to include the duration column and inner join on the relevant agent for that meeting we are also going to make the existing data table component reusable and we're going to add the empty state component for the meetings view let's start with modifying our procedures for my meetings page so let's go inside of source modules meetings server procedures before you start writing anything make sure that you're on your default branch go ahead and find the get many protected procedure and we are now going to modify the await database here specifically the select after we spread all the columns from the meetings schema let's also include an individual agent relevant for this meeting which will use the agents schema you have to import that from database schema then while you're in the imports also import SQL from Drizzle ORM now go ahead and add a duration here the duration will be calculated by using the meetings schema started at and ended at timestamps and we're going to use pure SQL so open SQL like this you can give it a type of number and in here write extract epoch from open parenthesis and then make sure you don't misspell your columns so you can copy them from here ended at minus started at like this and then simply add dot as duration like this after that let's go ahead and after we select from meetings let's add an inner join here for the agents and we are specifically going to join all agents that have the meeting ID my apologies all agents that were used in our meetings so meetings id agents do ID that's what we are matching so for each meeting that will be iterated here in the select we're going to find its relevant meeting ID and we are going to search for an existing agent ID and we are only going to render the meetings which were successfully matched with their agent that's why we're using an inner join if we were to use a left join then we would be okay with an agent being null but that's not the case for us because the agent is always required so inner join is the correct usage for this great and now I think we should also add this to our total simply so it ex it is 100% accurate about uh the amount of data that we are working with here great so now we have successfully modified our procedures and we can go ahead and render that inside of a data table so let's go ahead and let's copy the data table component from modules agents UI components and let's copy the data table and let's actually add it to our global components right here because it is different enough uh it is generic enough that it can be used multiple times so now that we have pasted it inside of here we can go inside of source modules meetings UI views meetings view and we can now use it here data table from components data table the only thing that's missing here is the actual well columns right so let's just pass in the items here and now we have to develop the columns so let's go ahead and let's copy the existing columns from agents here so in UI components we have the columns here and let's paste them inside of our meetings UI components so now we have columns here as well so what I want to do now is I want to go inside of my meetings types and I will copy meeting get one and I will replace it with getting meeting get many and let's use meetings get many here as well so now inside of my columns I will be a bit more specific so make sure you are inside of your newly copied columns in the meetings and import meeting get many and then in here specify number so uh actually let's go ahead and do type meeting get many number like this or maybe I'm doing something wrong here oh yes so get many here should be items my apologies and yes then you can use the number here and then uh this number will just be a single one of these values here the reason I'm using meeting get many and not meeting get one is because these columns will be loaded using the get many procedures right and instead of this get many procedures we just modified the select the select here is different than the one from get one the get one doesn't have it so it would be an incorrect column data so that's why I will I'm instead using meeting get many and simply specifying a single item from there by using the number operator here great so now that we have this let's go ahead and let's add everything that we will need from here let's start by adding npm install date FNS like this once you have added date FNS just go ahead and include it here let's also add mpm install humanize duration with legacy period apps as well let's import that here there we go then we're going to need a lot of icons from Lucid React besides these here so let's go ahead and add the following icons circle check icon circle X icon circle arrow up icon C clock fading icon and corner down right icon and lastly loader icon like this we are going to need the CN libut from here and uh that's going to be it so now let's go ahead and before we start the columns let's implement a function format duration here seconds number and return humanize duration here multiply the seconds by a th00and largest will be one round will be true and units here will be hours and seconds you're going to see how we're going to use this function in a second great now let's go ahead and let's define a const status icon map so depending on what status the meeting is in we're going to display a different icon if it's in upcoming it will be clock arrow app icon active this one completed this one processing this one and canled this one it is very important that you don't misspel these ones and if you aren't sure you can go inside of your schema here and find the meeting status so you can copy them from here make sure you don't misspell them and now what you're going to do is create another map called status color map so depending on upcoming active completed processing or cancelled you will have specific colors an easy way to tell you've done it correctly without typos is to click on one of them and the other one will highlight meaning that it's exactly the same there we go so let's go ahead and do the upcoming one first so it's going to have a BG yellow with 20% opacity it's going to have a text of yellow whoops a text yellow 800 and it's going to have border yellow 800 with 5% opacity and the other ones will be very similar just different colors so the active will be background blue with 520% opacity text blue 800 and border blue 800 / 5 for the completed one same thing but using the emerald for the cancelled one my apologies for the processing it's going to be rows and the exact same values as the ones above the only one that will be slightly different is the processing one my apologies so I have um reversed these two so instead of processing here this will be cancel like this cancelled one will be using the rose color and then change the last one to be processing like that this one we'll use gray 300 with 20% opacity and the rest will be the same so you can pause and copy and now we are ready to build our columns let's start with the accessor key name which will now be meeting name the flex flex call gap y1 will be the same and then inside of here let's immediately add a span here which will render the row.name name with a class name font semibold and capitalize like this now go ahead and remove this div here so we can immediately work on this one flex item center and gap x2 rendering the corner down right icon instead of this flex item center gap x2 add a new div with a class name flex items center gap x1 like this and simply encapsulate the corner down right icon and the span and this will render the agent name and then outside of this div add a generated avatar component this will use a variant of bots neutral seed row original agent.name and a class name of size four and after that add a span element here row.st started at if we have it we're going to format that exact field so started at using mm and d format otherwise an empty string and give this a class name of text small and text muted foreground now let's go to the second cell which will be the status and a header will be status and inside of here let's go ahead and do the following let's remove the cell function like this and let's open the curly brackets and first let's grab our icon which will be status icon map row original dot status as key of type of status icon map and then let's go ahead and let's return a badge element here and inside we are going to render that icon let's go ahead and append some props here so variant will be outline last name here will be CN capitalize go ahead and target an SVG here give it a size of four and text muted foreground and then let's go ahead and check if status color map has an original status here which should be a key of type of status color map so now our icon will automatically be generated depending on the meeting status as well as our color here for that badge and for the icon here we can give it a class name CN row original status is processing and in that case simply do animate spin so it shows a spinning uh icon and let's render the row original status here like that and now let's go ahead and do the last column here with accessor key duration and let's do header of duration and I think I have to do this here my apologies so I add a comma here because this curly bracket is the cell function so make sure you're doing it in the proper uh indent like I have now and let's open a cell let's dstructure the row here and let's return another badge here like this now let's go ahead and give this badge the following variant of outline and let's copy the class name you can copy it uh from here like this so class name capitalize and SVG size 4 flex items center and gap X of two and inside of here add the clock fading icon give it a class name of size my apologies text blue 700 and check if we have row original duration and in that case format duration using the row original duration as the prop otherwise simply render no duration meaning this meeting has not been started yet now let's go and see what we have not being used so we didn't use humanized duration uh not true my apologies uh we did not install the types for humaniz duration there we go so this is how the full command looks like and let me just quickly show you my package JSON so humanize duration and date FNS there we go perfect so now we can go back inside of the meetings view and we can pass the columns here to be columns from that forward/c columns and now when you try to load the meetings it should have a complete new look what we have to do now is add some padding and it seems like something's wrong with the colors here so let's just quickly go inside of here and let's see what's going on so status color map upcoming we definitely have that and this is a status of upcoming status color map here let's just see is there something we're doing incorrectly here i think everything's okay with our code because the icon is rendered correctly right this is the correct icon we assigned so this line of code should work just fine um so I'm going to debug this in the next chapter it could be because of the just in time compiler for Tailwind maybe I'm going to explore a bit but anyway let's go ahead and focus on wrapping this chapter up by going back inside of the meetings view here and give this div a proper class name of flex one padding bottom of four px of four medium px of 8 flex flex column and gap y of four there we go perfect uh so in the next chapter we're going to add the filters and you can go ahead and try something here and click create and there we go you can see our agent right here perfect so now it looks very similar to our agents uh field let's just wait a second for this to load uh and the style is matching the theme is matching and our data table looks the same i just want to change one thing and that is to make data table component reusable here and also we have to add the empty state component yes I forgot about that so let's go ahead and do the following inside of source modules agents inside of UI views agents view let's go ahead and let's uh import the data table not from components data table local ones but instead from the global ones right using at components data table so it's reusable which means that we can now go inside of the modules agents UI components and we can delete the data table from here we no longer need it and one more thing I want to fix here is my columns inside of the agents so let's go inside of the in the types first and let's go ahead and prepare agent get many agents get many agents get many items like this then go inside of UI components columns and in here when you use agents get one use agents get many number and nothing should change the agents view should work perfectly fine but we are now using the proper get many inference and now we also have to add the empty state so we can copy this from the agents view right here and let's go inside of meetings UI views meetings view and let's just add that right here import empty state from components empty state and now we just have to change this to create your first meeting like this and let's add a description so the description I will use is the following schedule a meeting to connect with others each meeting lets you collaborate share ideas and interact with participants in real time perfect so if you want to see that in action go inside of your meetings here and go inside of your Neon Console or Drizzle Studio and simply delete all meetings and then do a refresh here and you should see this create your first meeting amazing that's it let's go ahead and merge this pull request so meetings data table i'm going to create a new branch 18 meetings data table i'm going to stage all changes there we go i will write a commit message and I will click commit and publish branch and once the branch has been published let's go ahead and review the pull request and here we have this chapter's summary we introduced a new table view for meetings displaying meeting name status agent details and human readable duration we added empty state messaging to guide users when no meetings are present we enhanced meeting data by including related agent information and computed duration for each meeting we improved the agents table typing for more accurate data representation perfect so in here I don't think there's anything too useful in the sequence diagram that we haven't seen before but as you can see it immediately added to the diagram that we now join the agents and compute the duration right so it's not just repeating the same diagrams it's actively reading the context of everything we've done before and you can see how it detected all related PRs because we previously added these kinds of things so it knows that this is similar so it tells you this is possibly related we might want to take a look at that right in a real world example this will be extremely useful and we have one comment here to improve the duration SQL uh I'm not a SQL expert so I'm don't know what to tell you if this is good or not if you want to you can try it out but I will stick with what I know worked for my project right here great so let's go ahead and resolve this conversation and let's merge this pull request and after we've emerged the pull request let's go back to our main branch here and let's click on the synchronize changes button and click okay and inside of your source control here in the graph you will see 18 being merged amazing amazing job that marks the end of this chapter and see you in the next one in this chapter we're going to () implement the meetings filters the same way we implemented the agent filters but before we do that we're going to improve the badge padding and we're going to fix command select component filter reset i'm going to showcase both of these issues in a second we are then going to modify the meetings get many procedure add the Nooks filters and create UI for those filters so regarding our previous issue uh where I had problems with displaying the status color you can see that I no longer have that issue looks like all I had to do was wait for Tailwind's just in time compiler to analyze the classes if you are still having that problem you can try doing rmrf next and then simply doing npm rundev again this should clear up the cache and perhaps restart the just in time compiler from Tailwind now let's go ahead inside of source components UI badge and before you write anything just a reminder make sure you are on your default main branch here and change the py to one instead of 0.5 so I just want to make my badges a little bit taller great now the second problem we have is when selecting something from here and typing for example new and closing it and opening it again it only displays those two so what we have to do is go inside of um source components command select and go ahead uh and implement const on close or let's call it handle close like this and actually let's call it handle open change value is a boolean like this and then what you're going to do is call the on search but only if it exists like this and in here simply pass an empty string to reset the query and then set open set to value and then use the handle open change for command responsive dialogue on open change so on open change as you can see will give you the open boolean here so to make it clearer you could call this open like that so when you try it now click on new meeting this still works as usual and if you search for new and it loads these two and then you close it and open again it reset the query back to an empty search great so that's two problems that we had resolved now let's modify the meetings get many procedure so let's go inside of the meetings server procedures specifically let's go inside of the get many procedure here alongside search let's add agent ID Z string and nullish as well and then let's go ahead inside of the meeting types here and let's go ahead and create export type my apologies export enum meeting status and in here go ahead and add the following statuses upcoming active completed processing and cancelled always do this by looking at your database schema file and just don't misspell them you can copy and paste them and add them here so this value is what matters this can be named whatever but this inside of the strings needs to match this exactly using including the casing as well so now that you have that let's go ahead inside of the procedures here and let's add status and let's make that Z.NU Enum and inside of here you're going to import meeting status from dot dot slashtypes like this and very simply add dot upcoming as one of the options and then simply continue adding active completed processing and cancelled all of them and chain nullish to the status enum as well now let's go inside of the query here and after page size extract the status search and the agent ID you can remove the search as we already have it here so just status and the agent ID and then inside of the where let's go ahead and add some new things so after search check if you have a status that user requested and then use equals meetings status with the status otherwise undefined confirm that you have equals imported from Drizzle OM perfect and now that you've added that also add agent ID in the same way using the equals and agent ID value make sure you're using the proper values here like that otherwise undefined perfect and then I want to copy these two and add them to the total query as well so I get the proper total amount here great and that's it that's all we need for our get many procedure so we have added that now let's add our Nooks filters let's go inside of our meetings and let's also open the agents and I think that we can borrow the hooks here so copy the hooks folder and paste it inside of the meetings here so you will now you have use agents filters go ahead and rename it to use meetings filters make sure you're doing that inside of the meetings module go ahead and return use meetings filters here so the search and the page are exactly the same so now let's go ahead and add parse as string enum here and let's import meeting status from dot dot /types so now you can go ahead and add status to be parse as string enum and open object do values meeting status so these are the possible options for the status in the URL and lastly add agent ID which is just a normal string with clear on default here and no need for any clear on default for the status so leave that as is now let's go ahead and let's go inside of the agents and let's copy the params and let's paste them in the meetings and now we are just going to modify the new meetings params with uh the new things we added in the use meetings filters so import parse string as enum from Nook server make sure you're working in the params we just copied and put in the meetings module and you also have to import meeting uh status from types this one great so now let's go ahead and just add these two to the params like this and that's it now let's go ahead and let's add the UI for these filters so I want to prepare from the agents UI components in here we have agents search filter so let's go ahead and copy this and uh let's go inside of meetings UI components and paste it here let's go ahead and rename this to be meetings search filter and let's rename this to meetings search filter and inside of the meetings search filter we are going to use from our hooks use meetings filters and this will be use meetings filters and everything else can stay exactly the same yes we probably could have done a better job and reused this if you want to you can do this as a challenge for yourself find a way to reuse the search filter since it's exactly the same the only difference is the hooks hint it will be controlled from the outside of the component not the inside but I already built it this way so I'm just going to continue now that I have the meeting search filter using the new use meetings filter I will go inside of the meetings list header here uh and I'm going to add it so in the to-do filters here let's add search filter from forward slash meetings search filter so now right here when I do a refresh I should see filter by name and then when I write test my URL has changed to this search equals to test now let's go ahead and let's build the status filter so this will be a new component so let's go inside of modules meetings UI components create status-filters-filter.tsx let's go ahead and import the following from Lucid React circle X icon circle check icon clock arrow up icon video icon and loader icon after that we're going to import our new command select component which we've built in the previous chapter let's go ahead and import the meeting status from our types and let's go ahead and import use meetings filters from hooks use meetings filters now we have to prepare the options for our command select so this will be the following id of meeting status dotupcoming and the value of meeting status whoops dot upupcoming like that and then add a children which is a react node so open up a div here with a class name flex items center gap x2 and capitalize render clock arrow up icon and render the actual text meeting status upcoming there we go we are now going to do the same thing for all statuses so after upcoming go ahead and add completed it's exactly the same just using the completed status and circle check icon after completed let's add active using the active and video icon after active let's add processing using the loader icon and finally let's add the last one cancelled using the circle X icon and now we can export con status filter here we can grab the filters and set filters using use meetings filters and we can return command select inside of here set a placeholder to be status class name to be height 9 options to be the options constant from above on select we'll very simply grab the value and set filters with status value as meeting status and value will be filters status or an empty string there we go we can now go back to the meetings list header and we can import the status filter here from dot slash status filter and now in here when I click I am able to select the status that I want and you will see that my URL is now both the search and the status completed and notice that I can actually filter right if I want to i can search but notice how that works differently than this where in here I actually query the database right so the way this works and let me just see is this a bug or is it just not loading here looks like we have a bug here so I'll make sure to fix that i will just do a refresh just to confirm that it's not uh something with my local server all right i just restarted my server and looks like it was just a connection issue everything is working fine with our filter here so I can search for new and it actually queries the database for new so the reason for the different behavior between the two is that our status filter does not use the on search whereas inside of our uh meeting form right when we use the command select we use on search which basically tells the command select to not use the built-in filter that's how that works in case you were wondering great so one more filter to build and that is the agent ID filter let's go ahead and let's go inside of meetings UI components and let's do agent- ID-filter.tsx let's import use state from react let's import use query from tanstack query let's go ahead and import use TRPC from TRPC client command select from components command select and generated avatar from components generated avatar and lastly use meetings filters now let's go ahead and export const agent ID filter and as always let's go ahead and add our filters and set filters from use meetings filters let's prepare our TRPC here and let's prepare the agent search and set agent search to be use state and an empty string and then we can query the data using use query pass in tRPC agents get many dot query options and inside of the query options increase the page size to 100 and the search to be agent search this is basically a way to guarantee that they can find uh their agent right the pagination will not be a problem here and then we can go ahead and return command select let's give it a class name of height 9 let's go ahead and give it placeholder of agent and for the options we're going to go over data question mark items or fall back to an empty array map over an individual agent and then in here we are going to uh return an object like like this with an id of agent id value of agent id and children which are going to be a react node so give this a class name of flex items center and gap x of two inside a generated avatar component and give it the following props seed will be agent name variant will be bots neutral and class name will be size four and next to it simply render out the agent name the on select will be identical as in our status filter so on select gets the value and sets the filter to agent ID for that value and this time we're going to have the on search prop meaning that we are going to be using network filtering so on search will change and that will re-trigger the data here providing us with the new data inside and finally the value will be filters agent ID perfect let's go inside of the meetings list header here and let's add the agent ID filter make sure to import it from the right place there we go and now you should be able to select a filter so for example I select this and now this is my URL i have the search test status completed and an agent ID and now let's add a button to clear all of that and then let's finally connect it to the API let's go back inside of the meetings list header and let's go ahead and add filters and set filters from use meeting filters like this let's go ahead and define whether any filter is modified is any filter modified if status exists or search exists or agent ID exists like that make sure to use double exclamation points and let's also add a onclear filters method which simply resets the filters to their default states status is null agent ID is an empty string search is an empty string and page as well perfect so now what we can do here is we can import the button and we can also import X circle icon from Lucid React and we can go down here after the agent ID filter if any filter is modified render the button with the variant outline which has an on click for our new method on clear filters and render the X circle icon which we just imported with the clear button so now I can click clear and everything is reset in order to connect these filters we have to go back to our meetings UI view meetings view and let's go ahead and let's simply add the filters here so I will also add the router because we will need it in a second so let's just move this here and then let's also add our filters and set filters here from use filters use meetings filters like this and then inside of the query options here simply spread the filters so already this should now start working if I select an agent like new one I will get no results here but when I do a hard refresh here I'm getting this issue unauthorized that is of course because our filters have not been synchronized with the React server component so before we do anything further here let's quickly go back to app folder dashboard meetings page and let's go ahead and let's import load search params from modules meetings and let's go ahead and just ask for params there we go and let's also import a type search params from Nooks server so then we can go ahead and create props for this page using the promise search params we can then dstructure the search params from the props here and let's do params await load search params search params if you want to you can call them filters and then all you have to do is spread the filters in the prefetch there we go so now when you refresh you will get no errors at all and you can safely change your filters that includes the status everything seems to be working exactly as we expected let's just try the name test there we go works like a charm there's one more thing left to do before we can end the chapter let's go ahead inside of our agents UI components and let's copy data pagenation and let's paste it in source components so in the same place where we added the data table because it's generic enough to be reused and let's now add it to the meetings view so after the data table add data pagenation from components data pagionation like this and then we're just going to go ahead and give it some props page will be filters page total pages will be data total pages and on page change we'll get the page and set filters and simply modify the page like this and for the data table let's add an on row click here to get the row and simply do router.put push open back takes forward slash meetings and then row do ID and let me just collapse this so it's more visible there we go so make sure to not misspell this right since we already have that when you click here it should lead you to the meeting ID page perfect so we now have working pagionation for this as well let's try it out by adding another agent here like this let's go back to the meetings and let's go inside of our constants in the source and change the default page size to one and you can see it immediately allows me to pageionate and see the older agent perfect so you can now revert this back to 10 great one tiny problem that we have is if you have any filter set and go inside of mobile you can see that this happens so let's go ahead and quickly fix that so let's go inside of components meetings list header and wrap this div inside of a scroll area from components UI scroll area so it's a chassis and a component you already have it in your project just make sure that you've added an import for it like this in here and let's go ahead and add a inside of scroll area add a scroll bar from components UI scroll area and give it an orientation of horizontal so make sure to import scroll bar and you can see that now this is how it behaves and now let's go ahead and do the exact same thing inside of the agents list header so let me just copy the import here let me add it here there we go uh and yeah you can also in the meetings list if you want to replace the magic number you can use the default page from the constants which will be the number one and you also have to copy the usage of it so let's just wrap this inside of scroll area add this and close scroll area great so I've just done exactly what we did in the meetings list header to the agents list header including the scroll scroll area and scroll bar and I also replaced the number one with default page which is number one but in a constant so now the agents will also have uh I mean it's not really visible it requires a very small screen but this is also now scrollable in case in it overflows great amazing amazing job so that's all we wanted to do we have done all of these and now let's merge this pull request so 19 meetings filters i'm going to go inside of my source control i will change my new branch create a new branch 19 meetings filters let me just double check there we go and let's write a message actually first let's stage all changes there we go 19 meetings filters let's click commit and let's publish the branch and then let's go and review our pull request and now let's read the summary of this chapter let's read through the walkthrough this update introduces a comprehensive filtering and pagionation to the meetings feature it adds new filter components state management hooks and search parameter utilities the meeting's back end is extended to support filtering by agent and status the UI now includes horizontally scrollable filter bar clear filter functionality and pageionated meeting lists and in here we have a sequence diagram explaining exactly how when the user adjusts the filter it goes to the meeting list header component using the use meetings filters hook we update the filter state which in turn uh fetches the meetings with new filters and the pageionation and finally returns it back to the user and no comments so let's go ahead and merge this pull request we did a very good job with this one and after that's done let's go back to our main branch and let's click synchronize changes to ensure that we are up to date perfect after that go inside of your source control and confirm that you see 19 merged to main amazing amazing job and see you in the next chapter in this chapter we're going to develop the individual meeting ID page () this will include modifying the agents get one procedure adding the agents remove procedure and adding the agent ID page and the agent ID view let's start with modifying the get one procedure as always confirm that you are on your main branch and then let's go inside of our meetings procedures here and find get one protected procedure in the select here after we spread our get table columns add an agent which will be a type of agents and you can actually copy from get many right so you can copy the duration here it will work exactly the same so just add it right here and what we have to add is an inner join here so we are only going to load this meeting if we can find the relevant match between meetings agent ID and agents ID for each meeting that we are requesting like that great so that's what we had to do for modifying the agents get one procedure and now let's go ahead and implement the remove procedure so I'm going to copy the update procedure because it's quite similar let's go ahead and copy it let's paste it here and let's call it remove inside of the input here we are simply going to call Z object and request id of string like this this will then be removed meeting and instead of update we will call delete remove the dot set and find where so where meeting ID matches the input ID and where the user ID matches the currently logged in user so we know this user has access to modify this meeting and then let's work with if there is no removed meeting not found otherwise removed meeting that's it that is our agents remove procedure now let's go inside of the agent ID page we can find that in source app folder dashboard meetings meeting ID and in here let's go ahead and let's prepare the following props params with a promise of meeting ID inside and make sure that you didn't misspell meeting ID here because that's how you will be able to access it so be mindful of the case sensitive items be mindful of any typos now let's mark this as an asynchronous method let's extract the props and let's get the params here then let's go ahead and let's extract meeting ID from 08 params then let's go ahead and let's add our session protection here so let's import out from lib out let's import headers from next headers and let's import a redirect from next navigation once you've added that let's go ahead and prefetch the individual meeting so let's get query client from get query client you can import this from ERPC server and then void query client refetch query ERPC meetings get one query options and pass in the ID to be meeting ID add a to-do refcript meetings get transcript this doesn't exist yet we are later going to implement it now let's add hydration boundary here let's add state to be dehydrate and pass in the query client you can import hydration boundary and dehydrate all from tanstack react query now in here add a suspense from react then add error boundary from react error boundary now let's go ahead and assign the fallback here and let's just do to-do make sure to import suspense from React and error boundary from React error boundary now let's implement the meeting ID view component so I'm going to go inside of my modules meetings UI views and I will create meeting ID viewtsx like this let's go ahead and create a interface here props meeting ID let's export const ID view right here let's dstructure the props meeting ID like this then let's go ahead inside of here and let's return a fragment and let's return a div here with a class name flex one py4 px4 mdpx8 flex flex column and gap y of 4 meeting ID view then let's go back to the page and let's replace this with meeting ID view and pass in the meeting ID meeting ID make sure to import this from modules meetings UI views meeting ID view and now when you click on an individual meeting here let's just do a refresh you should see the new meeting ID view now let's go back inside of the meeting ID view let's prepare TRPC from use TRPC from TRPC client and let's extract the data from use suspense query individual use suspense query from tanstack react query pass in the RPC meetings get one query options and pass in the meeting the ID as meeting ID like that now that you have that let's go ahead and do a JSON stringify data null 2 so let's go ahead and refresh let's go uh inside of meetings here let's click here okay seems like something is wrong here instead of meeting ID view we need to mark it as use client that's it that's what we forgot to do let's refresh now and there we go perfect now let's build the error and loading states so these are identical as to all the other places we've used them so meeting ID view loading using the loading state and meeting ID view error using the error state you can import the loading state from components loading state and the error state from components error state the title loading meeting this may take a few seconds and error loading meeting please try again later and here I have both of those components added now that you have that added you can go back inside of the page here and instead of using to-do you can now use meeting ID view loading and in here you can use meeting ID view error like this and let's just import it make sure to add all three meeting ID view the error and the loading so now when you refresh you will have proper loading here and we've already demonstrated error a couple of times so no need to do it again now let's go ahead and let's copy from the agents UI components in here uh we have agent ID view header let's copy that let's paste it inside of meetings UI components and let's go ahead and rename this from agent ID view header to meeting ID view header and in case you think that we forgot to rename this one no this is our filter for filtering by agent so this needs to be called agent ID even though it's in the meetings module so let's go inside of our new meeting ID view header and let's modify the props a bit so instead of agent ID and agent name we will have meeting ID and meeting name so let's go ahead and use that here meeting so let's use the meeting ID here and the href will be forward slash meetings and here as well meetings and this will be my meetings and this will be meeting name and I think that everything else can stay exactly the same except of course meeting ID view header component name perfect so now we can go back inside of the meeting ID view here and let's go ahead inside of this div render the header component uh meeting ID view header let's do meeting ID view header and inside of here go ahead and pass the following so the meeting ID can be simply meeting ID prop meeting name will be data dot name and on edit here will just be an empty arrow function and on remove will be an empty arrow function let's see what the issue is here so uh my apologies meeting ID view header that's the component uh I wanted to add the new one which we just copied and modified so now when you refresh here your individual meeting ID should now have a familiar looking header so you can navigate back to all meetings or you can open the dropdown to edit and delete now let's implement the delete functionality here so that will be quite simple let's go inside of the meeting ID view here and we have to prepare const remove meeting from use mutation you can get this from TRPC oh my apologies from tanstack react query inside add TRPC meetings remove and add query options here let me just see mutation options like this add on success here and on error like this now let's also prepare the query client here use query client you can import this from tanstack react query and inside of the onsuccess we are going to invalidate uh meetings get many like this and let's add to-do invalidate free tier usage and then let's also add router here use router from next navigation so make sure you import this like that and after we do this let's do router push forward/ meetings so after we remove it we get redirected back to the meetings here and on error we can get the error and we can do toast from sonar error data message uh let's do error.data uh it looks like we don't have any code in this one let's just not do uh the error for this one now uh let's go ahead and add our use confirm hook which we can now reuse so in here I will add this remove confirmation and confirm remove coming from the use confirm hook and it has two parameters first one are you sure and the second one the following action will remove this meeting and use confirm can be imported from here and let's remove the toast soner here in case you've had it and let's go ahead and add this here like that and now let's go ahead and let's implement the handle remove meeting so handle remove meeting is an asynchronous method which is going to await confirm remove from our use confirm hook and only if we get okay are we going to await remove meeting mutation so now we can handle that and pass it here like that and now if you want to you can go ahead and try it out click delete and you have a confirmation once you hit confirm this will get deleted and you are redirected back to the meetings page now let's also implement the edit functionality so this will be quite simple let's go ahead and let's copy the new meeting dialogue and let's rename it to update meeting dialogue inside of here rename it to update meeting dialogue as well and add one more initial value prop here to be a type of meeting get one and I think we already have it from the types so we do so this is the get one output like that go ahead and structure the initial value here uh this will be initial values not initial value like that and then inside of here this will be edit meeting and this will be edit the meeting details and meeting form in here uh is not going to have a redirect so it's just going to be an open on change and oh yeah we have to fix this and set this to false and pass the initial values here to be initial values like that and we can do this simpler like this and while you are here uh remove the router remove this go inside of your new meeting dialogue and simply fix this to be false so you can close that dialogue great now let's go ahead and let's render the update meeting dialogue inside of the meeting ID view and let's go ahead and prepare our set state here so I'm just going to put it here so const update meeting dialogue open and set update meeting dialogue open all from use state which you can import from react like that now let's go ahead and use this right here in the update meeting dialogue so open will be update meeting dialogue open like that and we're going to have on open change to be set update meeting dialogue open and the initial values will be data uh and make sure to import this update meeting dialogue from components update meeting dialogue and one more thing we have to do is set update meeting dialogue open in the header here so meeting edu header on edit set this to true so now this meeting is called test as you can clearly see here but if I click edit uh you can see how it also populates the agent but if I call it test two and click update it should rename to test two and it does and if I go back it's called test two so that's all thanks to the work we did when we initially developed uh the meeting form so it automatically uses update meeting and it refetches itself and get many as well great amazing amazing job uh so I'm going to stop this chapter here and then in the next one we're going to focus on the UI inside of here and we can start the call very very soon perfect let's go ahead and merge this so I'm going to go ahead and open a branch 20 meeting page create new branch 20 meeting page i'm going to go ahead and stage all of these changes 20 meeting page i will commit and I will publish the branch now let's go ahead and let's review our changes by opening a new pull request and here we have our chapter summary we added the ability to delete meetings we introduced an enhanced meeting detail view with improved loading and error handling and we added a header component to the meeting detail view with options to edit or delete the meeting as well as a new dialogue for editing meeting details we also did some bug fixing such as uh the issue where cancelling the new meeting dialogue did not properly close the dialogue great so in here we have a more in-depth walk through and in here we have a sequence diagram but nothing new is really shown here because we did this exact thing uh when we developed the agent ID view right and in here we have some comments such as to implement to-do which we are definitely going to do once we get to the premium chapter uh I mean the chapter where we add premium features to our app and in here uh It's telling us to be mindful of accessibility so yeah we could look into this even though I think ChatSen handles that by itself in here it does not have the most up-to-date information so next headers does return a promise so headers needs to be awaited so this is an incorrect suggestion in this case same thing for params so this is new it wasn't like that before but now the new version is params is a promise and you need to await it uh and in here same thing so this is a completely new way of prefetching with TRPC so it thinks it needs to be await no it needs to be a void perfect great so now let's go ahead and let's merge this pull request and after it's merged let's go back to our main branch and let's click synchronize changes and okay let's then go inside of our source control graph and confirm that we just merged 20 meeting page with all of the changes we just reviewed amazing amazing job and see you in the next chapter in this chapter we're going to () add meeting varants this will be cancelled processing active completed and upcoming so let's go ahead and ensure that you're on your default branch after that go inside of the meeting ID view inside of modules meetings UI views meeting ID view and in here go ahead and add the following constants and instead of using meeting we are directly accessing the data like this so is active is upcoming is canceled is completed and is processing and in here you don't have to be afraid of doing a typo because you will get an error because data.status is an enum because data is what we fret from our database right so it can only be a specific thing that we defined in our schema so just go ahead and add these values and now let's go ahead and use them to render the current state so remove the JSON stringify here and check if is cancelled let's go ahead and render a div cancel like this and then let's go ahead and repeat that for all states like this so he's canceled cancelled processing processing completed completed and upcoming upcoming so right now when you visit your meeting you should see its state here there we go now it says upcoming but if I go inside of my Neon console here inside of tables meetings and if I change the status to processing for example and click save and refresh here it will now say processing so let's go ahead and just quickly uh bring it back to upcoming so we can develop that component before we can develop any components we first have to fetch the rest of our assets so you can go ahead and visit cwantonio.com/meat-assets or you can simply use the link in the description and that will take you to the GitHub with all of the assets so go ahead and download all of this you can click individual inside of them and use the download button right here once you've downloaded them go ahead and put them inside of the public folder so we already did this with the empty SVG and now we're just adding a couple of more so we've added the cancelled we've added processing and we've added upcoming now let's go ahead and just close everything and go inside of source components empty state and in here add a new prop which is an optional image prop and make it a default forward slash empty SVG and instead of rendering the hardcoded string here put it like this and now let's go ahead and develop upcoming state so we're going to do that inside of the meetings UI components let's create a new file upcoming state.tsx let's go ahead and let's export const upcoming state and let's return a div with a class name background white rounded large px of 4 py of 5 flex flex column gap y8 items center and justify center inside render the empty state from components empty state and inside put an image to be forward upcoming SVG so we just added that to our public folder and then let's add uh the title and the description this is what I'm going to use you can of course use whatever you prefer so let's go ahead now and go back inside of our views meeting ID view and instead of this upcoming let's actually render upcoming state from components upcoming state so now in here when you refresh if this is in the state upcoming you should see not started yet once you start this meeting a summary will appear here now let's go back inside of the upcoming state here and let's import button from components UI button and let's import uh link from next link and let's also add video icon and ban icon from lucid react and now we're going to go ahead below the empty state here and we're going to open a div with a class name flex flex column reverse lg flex row lg justify center items center gap 2 and full width and now let's render the buttons the first one will be ban icon and cancel meeting button copy and paste it and the second one will be start meeting and video icon and this one will also be a link so go ahead and wrap the content of the button inside a link and give it an href to the following open back forward call forward slash and then we're going to do meeting ID so let's just put one two three for now set the this to be as child and class name with full LG with auto and that would be it and now let's go ahead to the button above and let's go ahead and give it a variant of secondary and let's give it the same class name here there we go and now let's go ahead and let's simply extend the props for this so it will accept meeting ID on cancel meeting and is cancelling so we can now destructure that let's go ahead and do it meeting ID on cancel meeting and is cancelling from the props here so for this button here we can go ahead and add an on click and we can go ahead and add disabled if it's cancelling and we can also disable the start meeting button as well if is cancelling so we don't accidentally start the call while we're canceling it now let's go ahead and also use the meeting ID here instead of the 1 2 3 so forward slall meeting ID like that now let's go inside of the actual meeting ID here and let's render it properly so I'm going to give it meeting ID meeting ID on cancel meeting will be an arrow function like this and in is cancelling will be false there we go so now we have the options to cancel or start the meeting now let's leave it like this and let's go ahead and let's add a new state called active state so in order to do that we just have to copy the upcoming state and let's go ahead and let's rename it active state and for the props it will just accept a meeting ID let's call it active state and all we have to do is just modify the title and the description here meeting is active and meeting will end once all participants have left and we can use the exact same image here and you can remove this div here no need for it and uh yeah you can leave the class name as it is just remove the unused imports here and uh yeah my apologies bring this back but it's just going to be a single button here it's not going to be disabled it will be a link to the meeting ID and this will be join meeting like that perfect and I think we can leave everything else exactly as it is so meeting is active meet will end and just remove the ban icon from here perfect let's go back to the meeting ID view here and let's go ahead and let's add is active and active state meeting ID meeting ID make sure to import active state so now let's go ahead and let's change this to active and click save change and let's see this change meeting is active and we have a button to join the meeting which is a 404 page at the moment because it doesn't exist yet and now let's wrap it up with the processing state and the cancelled state so let's copy active state and let's rename it canceled state let's go ahead and remove the props as we are not going to need any and let's rename this to cancelled state in here we are using cancelled SVG and we just have to modify the title and the description and we can completely remove everything below that and let's remove all of the unused imports here so that's the canceled state so let's go inside of the meeting ID view down here and let's go ahead and render the canceled state make sure to import the cancelled state and let's go ahead and change this to cancelled save change and let's refresh and see it in action there we go meeting cancelled and let's do one more which is the processing state so let's just copy the cancelled state and let's rename it to processing state processing state so we're in here we're going to use u processing SVG I think public processing yeah so we have processing SVG here and but this is technically a completed state right we are going to say meeting completed because it was literally completed we are just processing it so like a summary will appear soon great and now let's go back inside of the meeting ID view here and let's use the processing state like this there we go perfect so the only thing left is the completed state but this will not use any image this will be an actual you know completed state with information and we can only develop it once we actually process a meeting but let's just confirm this works by changing this to processing and saving it and refreshing and there we go meeting completed the meeting was completed a summary will appear soon perfect so now just bring this back to upcoming or just create a new meeting it's going to have upcoming by default and in the next chapter we are going to enable this buttons right here now let's go ahead and let's see if we've done everything we've grabbed the assets cancelled processing active uh not completed yet but we did add this perfect and now let's go ahead and merge this so 21 meeting variants let me go ahead and open a new branch here create new branch 21 meeting variants and let's click plus to stage all changes and add a commit message and let's press commit and publish the branch once the branch has been published we can go ahead and review our code this one was pretty simple so I'm not expecting much but I am interested if we missed some uh serious issues here and in here we have our code summary so as we've just learned we have introduced new visual states active upcoming canceled and processing and we have also added the images to represent those states in here as always we have a more uh in-depth file by file change summary a diagram representing our logic to show each visual state and in here we have some comments so it recommends using active SVG instead of upcoming SVG completely reasonable it's not exactly clear the component is called active state but upcoming svg is the one we need to use in here it suggests adding some class names here but we don't need to do that because in the new chat versions button automatically separates the icons here and let's go ahead here uh it suggests removing the meeting on cancel we are going to have an actual action to just cancel the meeting without removing it uh of course in here it suggests actually you know filling this and also it suggests adding an unknown meeting status so that's something we might actually do even though I'm not sure how this can happen it's good to cover this kind of case as well so let's go ahead and merge this pull request here let's go back to our main branch and let's click synchronize changes so this button right here and let's go back inside of our source control look at the graph and confirm we just merged all of those new images and all of those new states great that's it for this chapter amazing job and see you in the next one in this chapter our goal is to implement a video calls the plan for () that is to start by obtaining stream API keys adding the stream video and node SDK adding a few methods procedures and finally UI elements let's start by obtain obtaining the stream API keys so visit getstream.io and create an account if this is your first time you will have a prompt like this where you have to enter a unique organization name so I'm going to call this meet- AI and I'm just going to go ahead and give it a number to make it unique let's click save and there we go our organization was just created and in here we also have our production app in case you don't have an app you can click create app so go ahead in your existing app or your newly created one and in here go ahead and select video and audio and click overview and now inside of here make sure you are in video and audio and copy the key now let's go ahead make sure you are on your default branch go inside of environment and let's add next public stream video API key and below that prepare the stream video secret key which will be this secret right here so copy that secret and add it here after we've obtained our keys let's install the SDK so I want to show you where you can find the documentation and it's quite simple you can just click view documentation here just make sure you have video and audio open and in here go ahead and select the platform API and select JavaScript let's go ahead and install stream.io node SDK so npm install and just add legacy pure depths so the installation doesn't fail now that it's installed let's go ahead back inside of our project source library and create stream-vide.ts let's go ahead and let's import stream client from at stream io node SDK and export constream video to be new stream client and inside of here we need to pass our new environment keys which are process environment next public stream video API key and stream video secret key as always please double check copy and paste so you know you didn't add any typos great for extra security you can also import server only in the beginning you already have this installed server only and let me just show you my stream io node SDK version in case you're wondering so this will basically prevent this from being imported anywhere on the client side now let's divert a bit and let's go create the generate avatar method so we're going to do that inside of source lib and create avatar dsx and import create avatar from dice bear core and let's add our two variants here now let's go ahead and create the props seed which is a string and the variant they need to match the imports above and then in here create a very simple method generate avatar URI accepting the seed and variant props and what we are doing is calling the create avatar method depending on the variant and we are passing some specific options if it's initials if it's bots neutral we are just passing the seed and we are returning to data URI so this is a quick way to generate avatar URIs but not the entire component as we have with our generated avatar component so it's pretty much the exact same function and we could probably reuse it here if we wanted to feel free to do that but this one doesn't render any JSX now let's go ahead inside of our meetings procedures located in modules meetings server procedures and let's go to the top here and let's create generate token procedure it's going to be a protected procedure go ahead and add a mutation here make it asynchronous extract the context from here and what you're going to do is await stream video from our newly added lib stream video and in here add upsert users and in here open an object and set the ID for this new user to be the currently logged in user give it a name for the currently logged in user a role will be admin and image will either be context out user image or our newly created generate avatar URI from lib avatar and let's go ahead and pass it some options here so we are going to use seed to be context out user name and variant will be initials there we go so now we have prepared a user for the call now we have to create the actual token so let's create the expiration time using this formula which is equivalent to 1 hour and let's go ahead and create the issued at using this formula right here and then we can finally create the token using stream video generate user token pass in the user id to be context al user id so this will now create a token for which user can join the call and it's going to match the user ID of this user which we just added to the list of members so it's going to be able to read their image and their name even though the token only knows the ID of that user that's why we needed to upsert the user first now let's add the expiration to the expiration time and the validity in seconds to be issued at and since the generate user token does not return a promise we don't need to await it we can instead immediately return this token now we have to stay inside of the meetings procedures and go inside of the create protected procedure and in here we have a to-do to create stream call and upsert some more users let's see what that's all about so first let's create a new call using stream video dot video call the type of the call will be default and the ID of the call will be created meeting ID so we are going to associate the stream SDK call with our meeting ID so that will be our unique identifier for this video call and now let's await call create let's go ahead and add some data inside this will be created by underscore id context al user ID and then we're going to add some custom fields here so we can render them in the call UI such as meeting ID to be created meeting ID and meeting name to be created meeting.name name be careful about the spelling here because there is no type safety here these are our custom fields so just make sure you don't misspell them and now let's add some settings override here we are going to immediately enable the transcription of the call using English language mode will be auto on and closed caption mode will be auto on as well and we are going to do the same thing with recording using mode auto on and quality 180 uh 1080p there we go so we just created a new call every time we create a new meeting so we are ready to join that call whenever we want but we are not done yet what we have to do now is we have to fetch an existing agent that this newly created meeting uh uses so let's go ahead and do that we can get the existing agent using await database select from agents where equals agents ID matches the newly created meeting agent ID and the first thing we are going to do is throw an error in case we were not able to found that because we cannot upsert this user and now we can finally go ahead and do stream video users that's right this agent will be treated as a normal user so inside of here let's add the ID and the name to be existing agent ID and existing agent name let's go ahead and give it a role of user because we already set the admin and the image will be our generate avatar URI with the seed to be existing agent.name name and the variant will be bots neutral just like that perfect and now we can safely create our meeting and that's all we need to do with stream video SDK uh in this procedure right here now let's go ahead and let's develop the following page which we get access to in our upcoming state if you remember in the previous chapter we created a lot of meeting variants one of that was upcoming state which allows the user to either cancel the meeting or start the meeting so it's basically this screen right here so when we start the meeting we are redirected to forward/call meeting ID let's go ahead and work on that page now the crucial difference here will be that it's not going to be inside of a dashboard so it's going to be in its own folder call this means it's not going to have the sidebar because we don't want it to be anything other than full screen so let's go inside of call and let's go ahead and create a new folder meeting ID and inside page esx why meeting ID that's because in our procedure right now when we use the create method when we create a new call we use the created meeting ID as the unique identifier for that call so we can safely rely on the meeting ID to help us find the call from stream video SDK perfect now let's go ahead and let's create a props here with params promise and meeting ID be mindful of spelling don't make any typos or casing errors let's export const page here make it an asynchronous page and destructure the params assign the props here and let's go ahead and dstructure the meeting ID from the params like this let's also make sure that this page is protected we can do that by using our familiar session from out which we can import from lib out get session and pass in the headers from next headers and the redirect from next navigation if there is no session available so now only authenticated users can visit this page now let's go ahead and let's grab our query client from get query client we can get it from TRPC server and let's void query client prefetch query ERPC which you can also import from the server here and let's prefetch meetings get one pass in the query options and use the ID as meeting ID just like that now let's go ahead and return our hydration boundary here from tan stack React query and add the state as dehydrate from tanstack react query and pass the query client inside just like that so we are doing the prefetching like we've always done it so far so you can import dehydrate and hydration boundary from tanstack react query and uh what I like to do is for some reason I like to structure the params up here even though we will redirect it just feels right for it to be here now what we have to do is we have to develop the call view component we are going to develop that inside of a new module so let's go inside of our modules and let's create a new folder called call and inside of here UI and then finally let's create views and inside call- view tsx it's going to have an interface props of the meeting id and let's export const call call view here and let's simply grab those props here so we are basically extracting the meeting ID here so we can do TRPC and so that we can extract the data using use suspense query from TRPC meetings get one with the query options ID meeting ID so now we have that data prefetched here because we are prefetching it here so we can now import call view and pass in the meeting ID as meeting ID make sure you have imported the call view from modules call UI views call view the reason we still have an error here is because we don't return any JSX here so let's go ahead and let's return a div hello or maybe we can do JSON stringify data null 2 just like that and make sure to mark the call view as use client now let's go ahead and test our app a bit just to see nothing's broken so make sure that you go instead of a meeting which is in the state of upcoming if you are unsure you can go ahead and create a new meeting i would actually suggest that you go ahead and create a new meeting so you can test the video SDK so let's click create here and let's see if any errors pop up maybe we did something incorrectly in here i cannot see any errors at all which would mean that we have successfully uh upserted those users and created those calls and I think that we might actually be able to uh track this inside of here let me go ahead and refresh here inside of my video and audio and I think that somewhere here I might be able to go maybe in the usage or explorer let's click on calls here and there we go i think that this is a new call and I think uh it might not Yes it doesn't yet have any members uh I think that in order to do that we actually need to join the call I think right but this is the new call which we just created and you can see we have the custom information test video SDK so we are successfully doing that perfect now let's go ahead uh and let's click on start meeting and in here we should now see a redirect to forward slall and looks like we are missing something so inside of this page here I'm doing export const page but that's a mistake because page needs to be export default so let's just fix that and now in here you can see no sidebar and we have properly loaded the meeting ID for which call we want to connect to now let's go ahead and let's go inside of our app folder call meeting ID and inside of the entire call folder create a layout dsx and it's going to be very simple so interface props with the children and just wrap the children with a height screen and background color of black so there we go it's now just a black on black text here so I just wanted to change the background for everything relating the call to be black now let's go back inside of our call view here and first things first let's check if data status is completed in that case what I want to do here is I want to return a div with a class name flex hide screen items center and justify center and I want to render the error state from components error state and in here I just want to alert the user that this meeting has ended and you can no longer join this meeting so now we can test this out more easily by changing this to upcoming so there we go this is the error that the user will see but only when it's completed so make sure you change this to completed so the upcoming user actually sees the JSON stringify for now now let's go ahead inside of call UI and let's create a new folder called components inside of here create a call dashprovider component now inside of here go ahead and mark it as use client and go ahead and import loader to icon from Lucid Ref import AL client from lib al client import generate avatar URI from lib avatar and let's quickly create an interface props with meeting ID and the meeting name and now let's export const call provider here let's assign the props and let's dstructure the meeting ID and the meeting name let me just fix the capitalization issue and inside of here let's go ahead and let's get our current session using al client use session so now we have data and is pending here so in case we don't have data or in case is pending is active we are going to return a div with a loader to icon inside give the div a class name of flex height screen items center justify center background radial from sidebar accent to sidebar i told you we're going to reuse that variables a few more times in the project and give the icon size six animate spin and text white and now down here go ahead and simply return meeting ID inside of a div whoops and meeting name just like this and now let's go inside of the call view here and let's return call provider from components call provider and pass in the meeting ID to be meeting ID and meeting name to be data name so now when you refresh this you should now see a loading and then in here you will see the name and the ID it's just uh black text here now what I want to do is I just want to change the call provider from loader to icon to just the normal loader icon because I don't think we use loader to throughout the project as much so let me refresh here let's do refresh again yeah that's the uh loader that I want now we're going to go ahead and we're going to build a new component which we are going to render here and where we are going to pass this to as well and it's going to be inside of the same components folder so create call-connect.tsx and create an interface props accepting the meeting ID meeting name and the new user data information which we await for here so user ID username and user image let's export con call connect here and let's go ahead and assign the props here and let's dstructure all of them there we go now inside of here uh I want to go ahead and return a div call connect like this so let's go to the call provider here and instead of returning this let's return call connect component which is a self-closing tag make sure you have imported it and we are now going to pass the meeting ID and the meeting name the user ID and the username which we get from data which we use here in the use session and finally we are going to get the user image which will look for data user image if it exists otherwise it will generate one using our generate avatar using seed data username and variant initials great so now we can go inside of the call connect and we can continue developing here so now we should actually go ahead and go back inside of the stream documentation but this time go inside of react documentation here and we have to go ahead and install uh stream io video react SDK so let me go ahead and copy this let me expand this a little bit clear and let me add d- legacy here depths like this great once this is installed let me immediately show you my package JSON so you can see the version the version is just in case you can't get your uh your doesn't work so you you think it's the version well this is the version I'm using so you can always install this directly and then try with that version now let's focus on the call connect component so in here we're going to import the following items from stream io video react SDK calling state stream call stream video and stream video client we are also going to add import loader icon from lucid react we are going to import use effect from react and use state from react and we're also going to add use DRPC from TRPC client and we are also going to need to import the last import needs to be stream io video react SDK dists style.css so that's how you style the components of stream and we are later going to modify some of the variables to match our theme our project theme uh and also let's import use mutation from tanstack react query and mark this as use client now let's go ahead and use all of these props to establish our call so let's add TRPC from use DRPC here and let's extract mutate async and let's map it to generate token use mutation and pass in TRPC meetings generate token with mutation options here now open up the use state with the first argument client second one set client and use state and give it a type of stream video client now open up the use effect here set the empty dependency array for now and let's do the following create the underscore client variable simply because client is already taken using new stream video client inside of API key go ahead and add our process environment next public stream video API key please be mindful and go inside of your environment and just copy it from here make sure it has the next public prefix so it's accessible on the client copy it from here and paste it here and now let's add the user so ID is user ID name is username and image is user image and we have made it convenient for us so all of these are just props great and let's add the token provider for the user training to join which will be this mutate asynchronous function so let's just pass it here and you will see it's completely compatible perfect and then let's go ahead and do set client to this newly created client like that and in the unmount method we have to call this established underscoreclient and disconnect the user and set the client back to undefined and now let's go ahead and let's add all the dependency array items user ID username user image and generate token so now we will have access to that generated client inside of this state and we will be able to pass it around and do whatever we want with it now that we have established our stream video client we have to establish the actual call so we're going to do a pretty similar thing starting with the use state call and set call with the type of call which we imported from stream io video react SDK and then let's go ahead and let's open a new use effect which will check if we don't have the client so if we don't have a client set we cannot initialize the call at all so simply return at this point and then we're going to create underscore call using client call the type of call will be default and meeting ID will be the identifier let's go ahead and by default disable the camera for this user and by default disable the microphone for this user and let's set call underscore call and now in the unmount function we have to disconnect from the call but only under certain conditions if underscore call state calling state is not identical to calling state then you can do underscore call leave and underscore call and call and set call to undefined like this and inside of the dependency array add the client and meeting ID like that and now let's go ahead and let's check if at this point we still uh don't have client or we still don't have a call we're just going to do the same thing we did in the call provider and return this type of loader here so let me just indent uh my items here a bit there we go perfect so this this will be the loader while all of these is being set up here the call and the client and now finally in the return instead of a div we can render stream video with client being client inside of here stream call with call being call and now inside of here let's just see what we have left unused meeting name okay so what we have to add now is the call UI element let's go ahead and go inside of components and let's create call UI tsx inside of call UI let's create the props which are meeting ID and the meeting name actually we don't need meeting ID just the name let's export const call call UI let's assign the props the structure the meeting name and inside of here we're going to go ahead and do the following the first thing we can actually do is since the call UI is rendered inside of these two we can use hooks to get the current state of the call so let's go ahead and let's import the following let's import stream and use call from stream io video react SDK and let's also import the following use state from react like this now let's go ahead and let's obtain the call from use call and let's create the following use state show and set show and the types can be lobby call or ended with the default being lobby and now let's create two methods one is handle join which is going to be an asynchronous method if there is no call we are going to break this method and let's just do a way call and join the call and after that we can set show to an active call and let's do handle leave to check if there's no call and break the method as well and do call end call and set show to ended so we now have methods to start the call from the lobby and to leave the call from the actual well call let's go ahead and return stream theme with a class name of height pool and now if show is equal to lobby we should go ahead and render lobby if show is equal to call we should render the call and if it is ended we should render ended so let's go ahead now and let's use call UI inside of the call connect so let's add it here and meeting name is meeting name like this so I'm going to go back to my app here and I'm going to do a refresh and let's just see what will happen you can see I am in the lobby it's very hard to see you have to highlight it right uh because we set our background to be black but you can see the text is now the text now says lobby because I'm in the lobby by default so now let's go ahead and let's create the lobby component inside of components add call lobby.tsx and in here we're going to go ahead and do the following props on join and let's go ahead and prepare the following imports here so that's going to be login icon from lucid react and we're going to have a bunch of imports from stream io video react SDK dream default video placeholder stream video participant toggle audio preview button toggle video preview button use call state hooks and video preview we are basically now building this page right here the lobby asking the user if they are ready to join and giving them an option to set up their video camera and microphone let's also go ahead and import link from next link let's go ahead and import al client from lib al client button from components UI button and generate avatar URI from our newly created lib and let's also import the styles here as well so stream io video react sdk this css styles CSS like that now let's go ahead and let's export const call lobby in here let's destructure on join props and now we can go ahead and we can grab camera state and microphone state from use call state hooks from these two hooks we can d the structure has browser permission for both of them but since they are named the same we will alias this one to has microphone permission and this one to has camera permission and we're going to unify that into a single variable has browser media permission so if we don't we can then display to the user that they need to allow the browser to access the camera and the microphone so now let's go ahead and return a div here with a class name flex flex column items center justify center height full background radial from sidebar accent to sidebar inside open up a new div with a class name py of 4 px of 8 flex flex one items center and justify center inside of that div let's open one more div with a class name of flex lex column items center justify center gap Y 6 BG background rounded large padding of 10 and shadow small inside of here we are going to add one more div i know this is divception so many divs uh but we will finally write some text inside of this one i promise so flex flex column gap Y2 and text center let's add an H6 element ready to join and let's add a paragraph set up your call before joining now let's go ahead and give the heading a class name of text large and font medium and the paragraph a class name of text small now let's go ahead and go back instead of call UI and let's actually render call lobby here and the only thing it accepts is the onjoin method so let's pass in on join to be handle join so there we go this is what you will see now let's refresh ready to join set up your call before joining and now instead of call lobby we actually have to go ahead and render the video preview so in order to render the video preview uh we have to create the following a const disabled video preview and in here the structure the data from out client use session and return default video placeholder which is a self-closing tag and inside add the participant prop open a new object inside set the name to data question mark user name or an empty string image will be data question mark user image or generate avatar URI with seed data question mark user name or an empty string and let's just open an object here like this and we also need to pass the variant here to be initials like this and in order to get rid of the error use as stream video participant prop here like this so now we have the disabled video preview here and we need uh just one more thing one more component besides disabled video preview and it's very simple one allow browser permissions just a simple paragraph please grant your browser a permission to access your camera and microphone and now outside of this div add a video preview component and pass in disabled video preview to be the following if has browser media permission you will use disabled video preview otherwise allow browser permissions like this and there we go since by default my uh camera is disabled you can only see my current user's image which is Google login so Google image is loaded here perfect so it's correctly loads the currently logged in user here now below the video preview let's add a div with a class name of flex gap x2 and inside of here we are going to render toggle audio preview button and toggle video preview button there we go and now let's go ahead below here open up a div with a class name flex gap x of justify between and full width in here let's add first button to be cancel and the second button to be join call with login icon this one will also be a link with an href going back to meetings and give this an as child prop and a variant of ghost the one below will simply have on click to be on join and just like that we've wrapped up our call lobby method so we can now cancel and go back to the meetings or we can go to uh make sure you choose the newer one right so delete any old ones you had because uh there's a chance it might not work because we only in this chapter added the call creation in the create procedure so use the newest one and click start meeting and there we go and when you click join call uh I don't do it just yet because uh I'm not sure what's going to happen but what will happen is you will just see a paragraph call which will actually be invisible right so now let's actually develop the uh call active for this so inside of components create call-active.tsx let's create the interface with on leave and the meeting name and let's import the following things link from next link image from next image call controls and speaker layout from stream io video react SDK export const call active get on leave and meeting name assign it to props here and let's go ahead and return a div with a class name flex flex column justify between padding for height full and text white and inside open up a new div with a class name of background and You can use the following hex code and a rounded pool adding four flex items center and gap four like that inside add a link element like this with an href of forward slash and give it a class name of plex items center justify center padding one background white forward slash 10 rounded full and w fit and render an image with a source of our app logo with width 22 and height 22 and alt logo and then after that an H4 element with our meeting name and a class name of text base and outside of that div speaker layout which is a self-closing tag and below that a div with call controls go ahead and give it a background the same as above so class name here and rounded full and px of four and let's pass our on leave method to call controls on leave and let's add our on leave here there we go so now we can go back to the uh call UI and in here render call active just like we rendered uh call lobby and let's pass on leave to be handle leave and we also need the meeting name and I think we have that we do meeting name let's go ahead and try it out now so when I click join call there we go and I can go ahead and send emojis here i can uh open my camera again here I am uh and you can see that I have the meeting name rendered right here and you can see the meeting is actively being recorded i can also share my screen you can see my connection here and I can also end the call but before we end the call let's actually implement the end screen so we can wrap up this chapter so what we can actually do is we can copy call lobby and paste it and rename it to call ended go inside of call ended here you can remove all props you can remove this component you can remove allow browser permissions rename call lobby to call ended remove any props from here uh you can remove this you can remove this basically remove everything besides link and button so just a return method here and inside of this heading six uh heading six you will use you have ended the call and in the summary in the in here you will add summary will appear in a few minutes and then outside of this div there will be no video preview none of this right so let's go ahead and remove this let's remove this and let's remove this as well so all you're going to do after this is back to meetings button because there will be no action to do here so now we can go back to call UI and we can render call ended here just like that so now that we have all of these states when I actually end the call this appears you have ended the call so we have officially implemented the video calling the problem is states are not being changed so I can now start this meeting as many times as I want and join it and end it right but we have two problems agent is not joining and uh no actual background jobs are being done and there is no communicating with our database so that's what we're going to do in the next chapter to properly synchronize those states but we did such an amazing job we obtained stream API keys stream video SDK we've created these procedures we added call page and call view and now let's merge this let's go and create a new branch here 22 video call let's go ahead and stage all of our changes just like that 22 video call let's commit let's publish our branch and let's review our pull request to see if there are any potential issues with our code and here we have this chapter's summary we introduced video call functionality including joining participating in and ending calls with a streamlined user interface this includes a pre-join lobby in call controls and a post call summary screens for a complete meeting experience we integrated video call service for secure token generation and user management we automatically created and managed video calls when scheduling meetings and we display user avatars and meeting details throughout the entire call experience as always in here we have a sequence diagram containing every single component that we just created in this request this is absolutely insanely detailed uh in case you're interested I'm just going to try and target it center it like this so you can take a look and review this entire diagram explaining exactly what's going on in our code as per the code changes most of these are refactor suggestions which we have already seen but we decided that we like our current practice but there are a couple of potential issues that I want to discuss so this one is because it doesn't know yet that headers are now awaitable they are a promise same with the params so we are okay with this this is not an issue uh this is a refactor suggestion and in here it shows some u JVT payload fields are incorrect token may be invalid as you can see in here it uh tells me that my tokens might be invalidly created uh and I'm not entirely sure but what I can tell you is that I went into video and audio platform here user tokens and I uh learned that validity and basically everything besides user ID is completely optional so yeah technically in our procedures in the meetings when we generate the token we don't even have to use these two we can just pass you can see there there are no errors here so if you want to if it's causing you any problems if it's expiring too soon you can delete these two fields and this generation and just use the user ID so that's the new thing I've learned here thanks to uh rabbit's potential issue uh with the rest I am satisfied so I'm going to go ahead here and merge this pull request and that marks the end of this chapter let's go back to the main branch and let's go ahead and synchronize our changes let's go inside of the source control open up the graph and confirm we just merged the video call and we did great amazing job and see you in the next chapter in this chapter we're going to learn how to connect the agent to our () video call let's start by obtaining the OpenAI API key which you can do by visiting platform.openai.com or you can use the link in the description to let them know you came from this video after that go ahead and log in or create an account if it's your first account you will most likely have to create an organization and as per project you can use the default project now go inside of your settings once you are in your settings go inside of billing and confirm you have sufficient credit balance five or $6 will be more than enough for you to complete this project and after that go inside of API keys and click create new secret key i'm going to call this meet AI select the default project with all permissions let's go ahead and copy our key inside of your IDE make sure you are in the default project go inside of environment here and set open AAI API key to be your newly copied key the next step we have to do is set up enrock to expose our local host so webco handlers can communicate to it so head to angrock.com and create an account or you can simply use the link in the description to let them know you came from this video once you create an account you will see a welcome screen like this in here select your operating system and simply follow the installation method and once you've added your token go ahead and try running this command right here in order to properly test it first make sure you have your app running on localhost 3000 and after that change the command to target well localhost 3000 this will generate the following forwarding URL using HTTPS protocol so now when you paste that inside of your URL you will be able to see your project's login screen meaning that our project is now accessible through this URL right here the only problem with this is every time that you run this command a new URL will be generated and that's quite difficult to work with so what Enro offers is a static domain if you can't find it here you can click inside of domains here and then find it down here and then you can find start a tunnel button and you can copy this command so now you can go ahead and run the following which basically adds your static URL here and change the port to 3000 so what happens now is every time you run this command you will have your own static URL there we go our app is accessible through that URL keep in mind that it's not intended to access our app through that URL you shouldn't use that to share your app with someone else we will have a deployment for that because this will cause many things to fail the only thing we need this for is web hooks so what I want to do now is I want to go inside of my package JSON here and I want to add dev web hook command and I simply want to run this this is the command I want to run enro http and then your static URL so now every time you're starting your project in one terminal simply type mpm rundev and in another mpm rundev web web hook as simple as that so now that we have that let's go ahead and let's set up stream web hook handler so the first thing you're going to have to do is just copy your URL your uh static domain URL and go inside of stream dashboard specifically video and audio and click on overview in here go ahead and scroll down until you find web hook URL and paste it here make sure it includes the proper protocol HTTPS so you can visit that here right here and change this to be forward slash API slash web hook make sure to not misspell it and for the events you want to listen to uh we won't be needing all of these but feel free to leave all of them selected so it's easier to develop right now just make sure you have all of them selected regarding call and after that make sure you click submit perfect so now let's go ahead and let's actually build the endpoint so we are going to do it in the place we just added API web hook so inside of source app folder API create a new folder called web hook and inside of here route.ds inside of this route let's prepare by adding the following imports from stream io node SDK we are going to use all of them uh except message new event for now so these are the events we are interested in for this chapter now let's go ahead and let's also add the following from drizzle and equals and not and let's also import next request and next response from next server then we are going to import our database we are going to import agents and meetings from database schema and we are going to import stream video from lib stream video what we have to do now is develop a method to verify the signature for whoever is trying to access this web hook because this will not be protected via our AL instead it will be protected via a signature so we adding a function called verify signature with SDK which accepts the body and the signature and calls stream video util verify web hook using the body and the signature now let's export asynchronous function post with request next request here and what we have to do now is we have to obtain two headers signature and API key from request headers get and then their respective header names if you want to you can also use the next headers import just in case you're using some newer version and this becomes outdated even though it shouldn't because this is the native Node.js API so if you want to this will also work you can also await headers and then do headers.get the same way just in case you were interested now let's go ahead and check if any of these are missing and if they are throw an error now in order to verify our signature we have to turn the body of this request into a string we can do that by using await request.ext and then we can do a final check if verify signature with SDK including our body and the signature failed meaning put an exclamation point here we throw back an error meaning you don't have access for this endpoint now let's define our payload to be unknown and let's attempt to uh parse the string which we just created here so we are attempting to parse it and if we fail to parse it it means it's not a valid JSON so we can't work with it and then after we successfully parse it let's prepare a constant event type we have to assign the payload to be a type of object and then simply extract type from it and now we can finally check if event type is one of our events that we need the first one will be call session started but before you do any development in here what I want you to do is I want you to go outside of this if clause and simply return a success message at the end because otherwise all other events which did were not handled would be throwing an error and that would eventually cause stream to stop sending our web hook any events so make sure to add that great now let's go ahead to our call session started here and let's add two things the first one will be event payload with a type of call session started event which we imported from here from stream io node SDK and then we destructure the meeting ID from event call custom meeting ID make sure to put a question mark here so what is custom if you remember in our meetings procedures when we do the create we do await call create and we add the custom fields here meeting ID and meeting name so that's how we access the meeting ID here even though it's a web hook with no meeting information so that's why we needed it and we can actually remove this to-do text now we fixed that now in here we have to check if we don't have a meeting ID because then we can just throw the error what we have to do now is we have to find an existing meeting under certain conditions first of all including the matching meeting ID so existing meeting await database select from meetings where the matching meeting ID is found but also we have to ensure that it's its status is not completed or active right uh and we can also add if it's not cancelled so under no circumstances uh should we find this meeting the only one we should actually look for is upcoming so if you want to you can actually set equals meeting status upcoming right or you can simply use the the reverse values if you want to be explicit great now let's go ahead and let's throw an error here if that kind of meeting was not found and immediately what I want to do here is update this meeting to a status of active just in case this fires twice because I found some rare cases where that can happen especially if it's been errored and then it may be retrieded so it's important to update the meeting status to active as soon as possible because what we're going to do now is connect the agent so if this event accidentally fires multiple times it will connect multiple agents which is not good right so that's why we immediately set it to active so if even if it fires next time this will fail right because in here we explicitly say that it must not be active and you can also add not processing here there we go so now we explicitly add all uh states that we don't want to have access to or you can use the reverse and just target the upcoming ones uh great so now what we want to do is we want to find the existing agent for this meeting that we just updated so existing agent using agents ID not match existing meeting agent ID if such an agent does not exist we throw an error and now we can connect to the stream video call using the exact same method as we did in our create procedure here so now that is the same instance and before we go any further we now have to install a package for open AAI agent to connect so I'm just going to shut this down and I will do mpm install stream-io openai realtime API- legacy pure deps and I will do mpm rundev here and just make sure you have your webc running web hook running here and then inside of my package json I will stream simply show you all of my stream versions just in case yours keep failing and you don't know why it might be due to newer versions so you can always use the exact same versions as I do if you prefer doing so let's go ahead now uh and let's actually connect the agent so we're going to do that by adding a realtime client to be await stream video connect open AI pass it the call instance and then pass it open AI API key to be process environment open AAI API key always double check this by copying it copying it from your environment and pasting it here the agent user ID will be existing agent do ID right here perfect so now let's also update the session for this real-time client just be very very careful here this is not yet typed so you can add anything here and it will not throw errors so be very very careful to correctly type this update session instructions existing agent.instructions like that and that is it that's all we need for connecting the agent to our uh call but before we test it out let's add one more event here so let's do else if event type is call session participant left so if anyone leaves the call first of all let's establish this to be the payload type call session participant left event which we imported and let's get the meeting ID the only problem is in here we need to use a special way to obtain a meeting ID we can't do it the same way as in here because there is no call event here because this is a participant event right so inside of the payload here uh you won't really have you can see you have call C ID but you don't have the call ID so you have to access the meeting ID like this and if you're wondering why that format it's because it's formatted as type and then colon and then the ID so that's why we need it like that but in case we cannot find the meeting ID throw an error and then let's go ahead and connect to the call again so just as we did here above and what we are going to do is we're going to end the call so the reason we are doing this is as a fail safe just in case uh so we don't leave our agents hanging in the call too long and they increase your usage on stream so I think we are now ready to test this out if you want to you can comment out these three events so you don't have any errors here and make sure you have your local host running make sure you have your angro running and now what I highly suggest that you do is first of all clear all of your meetings so I'm going inside of my neon tables meetings here and I have deleted all of my meetings here and make sure to create new meetings you can ignore the fact that one of mine is active i was testing it out so let's go ahead and create a new one math consultations and I created an agent math tutor and I will click create here and just to show you this new agent of mine what instructions it has so I just added you're a helpful math assistant that's it and now I will click start meeting here and then I'm going to click join call and this will fire an event and as you can see math tutor has joined the call and you can see it immediately starts recording now I'm going to ask it a question what is 1 + 1 1 + 1 = 2 now I don't know if you're hearing the answer but it's actually telling me the answer perfect so now what I'm going to do is I'm going to go inside of my Neon console and just refresh my meetings and this should now have a status of active and it does perfect uh and now what we can do here is we can just end this call and go back to meetings here and you can see it still says active and that's fine because we don't yet have a event which will turn it into processing or completed so it's completely fine that it still says active and in here you should now see this kind of screen here amazing amazing jobs so that's exactly what I wanted us to do uh in this chapter and we're going to leave the rest in the next chapter when we actually add some background jobs to process what we just had so let's go ahead and merge this now so I'm going to go ahead uh and create a new branch 23 connecting agents and I will stage all of my changes 23 connecting agents let's commit and let's publish the branch and now let's go ahead and let's review our code i am just focused on any potential issues or bugs and let's look at this chapter's summary so we introduced some new features including a web hook endpoint to handle video call events enabling real-time updates to meeting status and agent integration and we also added a development script for web hook testing and updated dependencies to support realtime OpenAI integration in here we have the sequence diagram explaining exactly what happens in our web hook so once the event is hit we validate the headers and the signature parse JSON body and event type and in the event call session started we find the meeting ID fetch the agent and then we connect that agent to the call and initialize real-time client with agent instructions and when the participant leaves we end the call session perfect in here it actually recommends using an environment variable instead of hard-coded text and honestly I didn't even know you can do this so if you want to feel free to change it to an environment variable like this you learn new things every day uh in here it suggests wrapping our web hooks inside of a try and catch um we might look into that after we've wrapped up the entire web hook event and in here it suggests already updating the meeting so it's very aware of our codebase it knows that we expect the status completed and ended at at some point so it's super impressive how it knows our schema but this is not the place to do that completed is a status that will be handled differently in here another try cache suggestion and I'm satisfied with our code so let's go ahead and merge it and once you've merged it go back into your main branch and go ahead and hit synchronize changes and then you should see the new branch 23 merged to your project amazing amazing job and see you in the next chapter in this chapter we're going to implement background jobs into our () project let's start by completing these three web hook events from our previous uh web hook implementation so right now I don't have anything running and I am on my main branch i'm going to go inside of source app API web hook route ds and the first thing I want to add is call session ended so let's go ahead and add an else if here event type is equal to call session ended and inside of here I want to get the event as call ended event which we can now uncomment as well as these two and we can get the meeting ID from call custom because this is a call event this was a session participant event so that's why we had to do a different way of grabbing the meeting ID but in here we can use our custom field and check if it's missing and throw an error and if it is uh actually finished and we have the meeting ID we can go ahead and update that meeting to be processing and give it the ended at date and only do that if we have a matching meeting ID and the meeting status is active so in case this fires twice we don't want to add new ended at date here we can only do it once so we are only doing it for a meeting which was currently set to active and now it's set to processing so that's one event down now let's do transcription ready and call recording ready so let's start with the transcription ready event else if event type is equal to this so in here we have to do the same thing get the event payload as call transcription ready event and get the meeting ID using the call C ID and split because of the specific format here and then in here we're going to go ahead and we are going to update the meeting with the new transcript URL so updated meeting and set transcript URL to be event call transcription dot URL where we have a matching meeting ID here and then I'm going to add to-do call ingest background job to summarize the transcript like that so what we can do here for now is check if there is no updated meeting and then we can uh simply throw an error like we did in the previous instances meeting not found and let's do a 404 here and let's go ahead and do one more event so we can actually copy everything from here and let's do else if event type is call.recording ready you can go ahead and paste everything inside of here and this will be the call recording ready event meeting ID will be accessed the same way and in here you won't have to actually return this at all just go ahead and update and set the new call recording URL so these events will only fire the call recording ready and the transcription ready if in the meeting procedures you enabled the transcription to be auto on and recording auto on otherwise these events will not fire at all so what I suggest you do now is go inside of your neon console tables meetings here uh and delete all of your meetings make sure you have a clean slate here then go ahead and do npm rundev and npm rundev web hook so you have a web hook running now let's go ahead and refresh and I'm going to create a new uh meeting here okay so I just created a new meeting and I'm going to start the meeting and I will have just a quick conversation with uh the math tutor which should join any second and now that it has answered my question I will simply end the call and I will go back to meetings here and you can see that now this is actually set to processing because it actually captured my call session ended and it set it to processing here and what should be happening now is I should be receiving my transcription ready and recording ready events and I should be able to see that in here if it's finished i can see the transcript URL and the recording URL so in the transcript URL here you can see what we talked about right and in the recording URL you will be able to see uh the actual recording of the event perfect so both of these are actually working looks like we have uh successfully created recording ready and transcription ready events now that we have finished all of our web hook events let's go ahead and let's implement a proper background job by configuring inest so you can use the link in the description to let them know you came from this video and now let's go ahead and let's go inside of documentation get started you won't even need to create an account so let's go inside of Next.js here make sure you select the app router so in here I already have my app running so no need to do that but let's go ahead and let's install inest so I'm just going to go ahead and do that here and I will just add legacy here dep so it doesn't fail with the installation now that I have installed it let me show you the version so 337.0 just for your information and now let's run the ingest dev server so I'm going to go ahead here and I will have it running the same way I have my web hooks running so alongside mpm rundev I have my web hook running and now I will have inest cli dev so if it asks you to upgrade feel free to upgrade to use the latest version this is the version I'm using for this tutorial you can also specify that version here if you want to and immediately upon running this uh you will see that it is actually scanning my localhost 3000 for any kind of ingest functions and you can see how my npm rundev has a bunch of 404s because we haven't added any functions yet but what you can do now is you can visit localhost 8288 let me go ahead and paste that here so you can see it let me go all the way down so you can go to localhost 8288 and you can actually see the ingest dev server and inside of here you will see all the functions that we create and all the steps and background jobs that we will we will be able to run so now let's go ahead and let's actually create a background job for that we can simply follow the uh documentation so let's just go back here after we run this let's go ahead and let's create the ingest client so I'm going to close everything here i'm going to go inside of source and I will create a new folder called ingest like that and inside I will create a client.ts and I will paste this inside and I will call this meet AI 2 simply because I already named one meet AI so I don't want any conflicts just in case after that let's go ahead and create an API folder with the ingest route so this server will actually be able to find it and it won't have to scan for 404s let's go inside of app API let's create a new ingest folder and inside let's create a route.ts and let's go ahead and copy this and let's paste it inside and I will just change this to use our uh at sign there we go so make sure to put it inside of API inest route.ts it needs to be called inest and finally you can now see this npx inest cli is hitting the correct uh route here so it finally found inest in our project and now let's go ahead and let's write our first function here so I'm going to go inside of ingest and create functions.ts and I will paste the hello world function here and I will import this from ingest client so it will be called hello world here and you can see it accepts some data it even waits for a second now that we have this defined we're going to have to add this back to our route so let's go inside of the route here u and my apologies the functions.ts DS files should be created in inest folder here next to the client not in the API route my apologies for that so the API inest should just have a route and the actual source inest should have the functions now let's go inside of the ingest route and inside of here let's add our hello world from ingest functions and immediately upon doing that if you go inside of your local host 3 uh not 3000 but 8282 you will see in the functions a hello world function and in here you can invoke it and you can pass email to be hello@mail.com and click invoke this function and you can see you now have a run here which first waits for 1 second and then says hello and your email so that's how these background jobs will work but ex instead of triggering them from this dashboard we are going to trigger them from actual code and they will simply work in the background you won't have to await it you can tell your user to log out and they can take a walk and this will still be completed without them that's the power of background jobs you don't have to worry about them timing out or erroring because these individual steps will retry themselves until they succeed or until you put a limit on retries so now that we have established this we can go ahead and we can actually uh create everything we need so let's create our own uh inest function now so the way we're going to do that is by going back inside of the functions here in the ingest and let's remove the hello world function and instead we are going to add export const meetings processing to be ingest.create function the ID will be meetings slprocessing and the event will be meetings forward slashprocessing and then we're going to have an asynchronous function which destructures the event and the step and inside we're going to start defining the steps we need to process our meeting now the first step here will be to fetch event data transcript URL that's because if you go inside of our web hook route when we call transcription ready here we added a to-do call the ingest background job to summarize the transcript so at the point that this function is called we will have this stored inside of the updated meeting so we are going to pass that along here as transcript URL and we can use inest step.fetch as an optimized way to fetch in a background job so no matter how long this takes background job will take care of it you won't have to worry about it failing or anything else now what we have to do is we have to parse this because this is currently in JSON L format so it's not exactly workable with in JavaScript by default so what we have to do is we have to add mpm install jsonl l parse stringify and let's add legacy pier deps here once it's installed you can exit and let's go ahead and import it here jsonl from jsonl parse stringify and in here what we're going to do is call this a transcript and do await steprun and this will be a custom that called parse transcript like that let's open up an asynchronous method here and first things first let's go ahead and await the response which we just fetched above and turn it into a text and then we will simply return JSON L parse and pass in the text like this the only problem is currently we don't really know the type that is waiting for us but thanks to this JSON LS uh JSON L parse function we can actually add the type so let's go inside of our modules let's go inside of meetings and let's go inside of types and down here I'm going to add a new type called stream transcript item including speaker ID type text start and stop how do I know that these are the ones I need because of our transcript uh URL right so I just visited my previous transcript URL which we demonstrated to confirm it's working and in here you can see speaker ID start timestamp top stop timestamp type and text so that's why I know that those are the things I need so inside of here I can now append stream transcript item from modules meetings types like this and now when I hover over a transcript you can see exactly what I expect inside perfect now the problem is uh I can't really do much just by having speaker ids we need to populate them and connect them to the users from our database quick interruption from future me just a heads up right now we're using step.fetch fetch and this works fine locally during development but once we deploy which will happen in a few chapters this line will break in production causing a malformed JSON object the fix though is very very simple all we have to do is modify from step fetch to this basically calling your normal fetch inside of a step and then chain then and turn the response into text the problem now is that we also have to modify this line but that's not a problem either instead of using the response.ext here in this step we're just going to go ahead and parse it and do nothing more so this is what I would suggest you change your code to even though the code will switch back to the old version once I unpause this interruption I recommend using this updated version going forward to avoid any issues later on all right now back to the current timeline so let's add another step called transcript with speakers step.run run add speakers and inside of here the first thing we're going to do is we're going to establish all the ids from our transcript so we're going to be using a set to avoid any duplicates so all of them will be under speaker ID and you can see how thanks to this type here we have strict typing here so we don't make a mistake just double check that you actually have speaker ID here you can find it here in your meetings just find a recording or transcript URL to check great now let's go uh back to our app here and once we have speaker ids let's go ahead and let's get all user speakers because half of them will be agent speakers so user speakers will need a database it will need the user schema it will need in array from Drizzle OM so make sure you have imported the database user schema and Drizzle OM great now that we have all of these we have the user speakers and we can now do the exact same thing but for the agent speakers but instead of calling users we are calling agents here so make sure you've added the agents schema perfect and now let's unify them all together in a constant called speakers so we are combining the user speakers and the agent speakers here and we are going to return transcript.m mapap get the individual item here and now we are going to attempt to find the matching speaker ID with all of these speakers combined so we are going to load uh something either an agent or a user and then if we don't find any speaker we are just going to return this existing transcript item and we're going to set the username to be unknown because we cannot find that user in our database otherwise let's return this existing item but we are appending the user object with the proper speaker name so we know exactly who was speaking at that time perfect and that is our job for actually adding the uh adding the speakers to the transcript now we have to build an agent here so uh inest has their own agent kit which we can implement and then use as a step so we can actually connect open AI to ingest but in order to do that we first have to go to uh our assets repository here and find system prompt you can use the link in the description to find this and go ahead and simply copy this entire prompt now go to the top of your meetings processing function here and create a summarizer and give it a create agent function and you can import create agent from another package that we have to install so let's just do that npm install inest agent kit legacy pier deps so after it's installed let's go back here and let's import create agent open AI and text message all from ing inest agent kit inside of the create agent here give it a name of summarizer again give it a system prompt of the following open backpix and now you will simply copy the system prompt and paste it here and then go ahead and simply add dot trim here and add a model and in here add open AI and we imported this from here right so open AI model choose whichever model you want i'm going to choose 4 O and API key will be process.vironment open AI API key always double check make sure it's the proper one there we go uh perfect so we now have this which means that we can now actually summarize this so after transcript with speakers we can go ahead and create another step using await summarizer.run give it summarize the following transcript and then use JSON stringify transcript with speakers because we now have them with speakers here and once you actually have the output you're going to add one more step and add save summary asynchronous method and await database update meetings and set the summary here to be output first in the array as text message which is our type we imported from inest agent kit dot content as string and set the status to completed finally and only do that where our meetings ID uh matches the event data meeting ID be mindful uh oh yes let's import meetings from database schema my apologies and let's import equals from Drizzle OM so make sure you have added meetings here and uh equals from Drizzle OM make sure you don't misspell the event data meeting ID because this can be anything it's not strictly typed same goes with uh event data transcript URL all that's left to do now is go back inside of our web hook here find the call transcription ready remove the to-do here and do await ingest which you can import from ingest client dot send name will be meetings processing so just make sure you don't misspell it you can copy it from here and then paste it here and data and simply pass in the meeting ID and the transcript URL from this updated meeting which we've had right here perfect and we must not forget to now go inside of API inest route and instead of hello world add meetings processing here and you can confirm you've done it correctly by going inside of your functions here let's go ahead and refresh and you now have the meetings processing uh but if you try it with this data it will just fail so the best way to test this out is to go ahead and have a new meeting so that's what I'm going to try out now so I just started math consultations 3 and I will simply ask a question here and then we're going to look if any runs will start automatically here i'm now going to end the call which will now trigger the processing mode for that consultations here and it will also wait for the web hook to hit and once the web hook hits you can see that we run the meetings processing function so the first step was to fetch the transcript URL which you can see right here worked it has the speaker ID here and everything then we parse the transcript so we turn it into JSON then we add the usernames so this is me John Doe and this is math tutor so we use the speaker ID to find that and then finally we used chat GPT to summarize the transcript and you can see that we have the content result here and we saved that summary and now if I refresh my database here I should see a summary text inside of here and I will also see the status to be completed so if I go back here this now finally says completed and you can also see we have proper duration here amazing amazing job so we now have everything ready uh to display the last components for this app so now let's review and merge this pull request i'm going to go ahead and open a new branch 24 background jobs once I'm in a new branch I'm going to stage all of my changes and I will write a commit message let's commit and let's publish the branch and now let's review our pull request and here we have the summary so what I'm interested in here is the walkthrough this update introduces injust based eventdriven processing for meeting transcripts adds new dependencies and expands web hook logic to handle additional event types we implement a function for AI powered meeting summarization and we update database records accordingly we also introduced a new type for transcription items and some minor formatting changes so this is basically the goal of this chapter inest based eventdriven processing background jobs something the user doesn't have to wait for and something that we don't have to await or uh be afraid that it will fail right the user can take a walk the user can go away that's the power of background jobs they can simply do whatever they want while they wait so once the web hook reaches the proper uh event type we update the meeting status and fields and we dispatch the meetings processing event with meeting ID and the transcript URL to ingest after that we meet we trigger the meeting processing function and we fetch the transcript URL and speaker info we then send the enriched transcript to summarization to AI and we return the summary and notes and finally update and set it as completed in here we do have some uh recommendations and this is not an uh uh an SD SDK does not accept this kind of format so it actually gives you a suggestion even in that case if agent kit doesn't support this format at minimum use template literal so it's basically suggesting us to use template literal instead of joining like this basically to avoid potential prompt injection so if you want to you can change this i might change it in the next chapter and the rest of the refactor suggest suggestions are basically just error handling suggestions which inest does a pretty good job of just by itself so no need to do any of that we can just go ahead and merge this pull request and once you've merged it go back to main and go ahead and synchronize the changes like that and now inside of your graph here you should see that you have merged 24 background jobs that marks the end of this chapter amazing job and see you in the next one in this chapter we're going to go ahead () and implement the completed state with the new summary which we generated in the previous chapter using background jobs so let's go ahead into our project and ensure that we are on the main branch let's also make sure we are running npm rundev rundev web hook and npx inest cli and then let's go ahead to our meetings page once in the meetings page ensure that you have at least one meeting with a completed status if not have a new meeting and wait for it to be completed you will know it's properly completed by going inside of your database and confirming that at least one of them has a summary like this and now let's implement the completed state let's go inside of meeting ID view and let's find the is completed which renders the completed text let's replace it with completed state and pass in the data which is our use suspense query data now let's create the completed state inside of components create completed state dsx let's export con completed state right here and let's go ahead and let's create the interface for let's import meeting get one from our types which are located in the meetings module right here we have meeting get one and now in here we can go ahead and destructure the props and grab our data right here now let's go ahead and let's return a div with flex flex column and gap y of four let's go ahead and add semicolons here and let's import the completed state so we can actually render it and you should have no errors with the types when you refresh nothing should be visible in your completed meeting because we haven't rendered any text yet now let's go ahead and let's import everything we need from our components UI scroll area and components UI tabs so we haven't used tabs yet but you have them inside of your source components UI tabs we've added that as well as scroll area when the initialize chats UI now let's go ahead inside of here and the first thing we're going to do is activate the tabs like this with the default value of summary then inside of the tabs we are going to add a div with a background of white rounded large border and px of three then we are going to open the scroll area and inside we are going to render the scroll bar the scroll bar will have an orientation of horizontal now inside of the scroll area let's go ahead and let's open the tabs list component with class name padding zero bg background justify start rounded none and height of 13 now inside of here let's add the tabs trigger component and let's render an icon book open text icon which you can import from Lucid React make sure to add that and let's give the tabs trigger a value of summary and now if you take a look at your app you will see the summary tab right here now let's go ahead and let's import actually all icons we need from Lucid React so that will be sparklas icon file text icon book open text icon file video icon and clock fading icon let me just move them to the top here and now let's go ahead inside of this tabs trigger and let's move this down here because we're going to add a pretty large class name here so I'm going to paste it here and I will you can pause the video and copy it so basically text muted foreground rounded none bg background and now this is important uh data state active and shadow none are one class name right so let me just temporarily remove this so you can see this is how the class name looks like so whenever you write data state active shadow none it's one class name it's just that I use uh this collapse line uh settings which collapses them so if I zoom out you will see that my data state active are all in one line so whenever you see data state active just know that they are supposed to be together with whatever comes after the column like this same is true for hover okay so after you've added this yours should look like that there we go and now we're going to go ahead and open uh copy the taps trigger again and the second one will be transcript and we're going to use the file text icon and transcript and then we're going to have the recording one so I'm basically just copying exactly uh as it is all of them have the same class names right uh this one will have file video icon and the recording text and the value of recording and this one has the value of transcript and then the last one we're going to have is the chat value sparkles icon and ask AI so the class names are identical in all of them we are just copying from the first one changing the icon value and the label inside so now you have the transcript the recording and ask AI and now we have to actually create the content for each of these tabs a pretty easy tab to make is the recording tab so let's just go outside of this div but still inside of the tabs oops and let's render tabs content with value recording just make sure that it matches the value here that you don't have any typos and the only thing we're going to do is the following we're going to add a div with background white rounded large and border and then we're just going to add some padding as well so let's just do that right here px4 and py5 and the only thing we're going to do is we're going to render a video so normal video and source data recording URL with an exclamation point because without it uh it can be undefined but we know that since is it is in the completed state it's always going to exist so we can safely just put an exclamation point at the end uh with full and rounded large and let's also add controls and when you click on recording now you will see the actual recording uh that exists in the recording URL here just one tip recordings storage for recording and transcription these URLs here uh they have an expiration date they are retained for 2 weeks before being automatically deleted but don't worry if you want to keep them forever or just not store them with stream you can use your own storage like Amazon Google Cloud or Asure so go ahead and visit video and audio select platform and recording storage and transcription storage and follow the documentation to add your own external storage if you don't want this to expire great so it was that easy to add the tabs recording and now we're going to go ahead and add the summary tab before we can implement the summary tab we have to install a package called react markdown so we can properly render our markdown because that's what we instruct our assistant to do so now that we have that let's go ahead and let's make sure that we add an import for markdown from React Markdown let's also import link from next link and let's also import generated avatar from components generated avatar now let's go down there inside of new tabs content so I will add tabs content here and I will give it a value of summary and inside I will render a div with background white rounded lg and border then inside I'm going to render another div with px4 py5 gap y5 flex flex call and call span of five inside I'm going to add an h2 element with text to excel font medium and capitalize rendering the data name and you can see that now when I click on summary I can see this meeting's name just make sure you didn't misspell the default value the value in the trigger and the value in the tabs content below the meeting title we're going to end add the current agent that was inside so add a div with flex gap x2 and items center and add a link element we're going to give the link an href of forward slash agents and then data agent ID like this and then let's go ahead and give it a class name flex item center gap x2 underline underline offset 4 and capitalize and then inside of this link let's render the generated avatar which we imported previously with variant bots neutral seed as the agent name and class name size five and below it we can simply render the agent name and then add an empty space after the link here and below that let's go ahead and let's add a paragraph to check if we have started at if we have it let's use format from date FNS so just make sure you imported format from date FNS and you're going to format data started at in this exact format so there we go now you can see math tutor and when I click on it it will take me directly to that meeting here now below our agent here outside of this div let's render a new div with class name flex gap x2 and item center render our imported sparkles icon and oops not this one and render the text general summary like this and then below that let's go ahead and let's add a badge from components UI badge and it's not going to be a self-closing tag so make sure you just added the badge from components UI badge let's go ahead and let's give it uh some attributes here so variant outline and class name flex item center gap x2 and target the SVG to give it size 4 and inside of here go ahead and add it clock fading icon now let's go ahead and let's revisit our columns for the meetings here and in here we have a function format duration let's copy it and let's add it inside of our lib and inside of utils here so after the function CN let's add export function format duration and import humanize duration from humanized duration because I want to reuse it so inside of my source modules meetings components columns I no longer have to have it here i can instead go down to where I use it and just import format duration from lib utils right like that that means I no longer need this import and there should be no errors in your columns here now go inside of the completed state here and now below clock fading icon that's exactly what we're going to do so we're going to check if we have the duration and then use our newly added format duration make sure to import it from lib utilus not from date fns so we use the same name that's unfortunate you can change it if you want to just make sure to import it from the correct place so now in here you have the duration of the call now below this badge let's go ahead outside of this div let's go ahead and actually sorry inside of this div below the badge open a new div and render the markdown let's close the markdown so make sure you have imported markdown from React Markdown here and inside of here render data summary so let's go ahead and refresh in here you can see that I have the summary the problem is it's not formatted at all so in order to format it we have to go ahead and add components prop here open an object and let's simply add the elements so this is the H1 element text to Excel font median and margin bottom of six and then I'm just going to copy from my source code the same is for H2 elements H3 and H4 we are just reducing the uh size of the fonts you can see it slowly changing now now let's go ahead and let's add the paragraph margin bottom of six and leading relaxed there we go and then you can go ahead and add more for example unordered list or you can add ordered list you can then add a normal normal list here and I would also suggest adding strong i will also suggest adding code and block quote this way you cover most of the things AI can generate in markdown so you can just pause the screen these are very simple snippets right uh and there we go you now have a nice overview summary here and I'm going to end the chapter earlier now because I want to do the transcript together with the AI chat actually so we only did the simple ones now and we'll do these a bit more complex ones in its own chapter so let's go ahead and mark this as completed let's revert this and recording tab is completed so let's go ahead and merge all of these changes i'm going to create a new branch uh 25 uh completed state I believe is the chapter name and once I have confirmed I'm on a new branch I'm going to stage all of these changes and I will add 25 completed state commit message click commit and publish the branch once it's published let's go ahead and let's review our pull request i'm only interested in any potential issues and here we have the summary so this chapter was pretty simple so not much going on here we basically added a completed meeting view with summary transcript recording and ask AI tabs and we added the markdown rendered summary and in here we have one actionable comment and that is to add turnary in case recording URL does not exist which is a good idea considering that it will uh disappear at one point unless you use your own storage as explained in the beginning of the chapter so you might consider doing this let's go ahead and let's merge the pull request and once it is merged let's go back to our main branch and let's synchronize the changes to ensure everything is up to date and in your source control here in the graph you will now see 25 completed state amazing amazing job and see you in the next chapter